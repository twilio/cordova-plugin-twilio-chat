/* twilio-chat.js 5.0.0
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2019, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes javascript-state-machine under the following license.

    Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes q under the following license.

    Copyright 2009â€“2014 Kristopher Michael Kowal. All rights reserved.
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to
    deal in the Software without restriction, including without limitation the
    rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
    IN THE SOFTWARE.

This software includes platform.js under the following license.

    Copyright 2014 Benjamin Tan <https://d10.github.io/>
    Copyright 2011-2015 John-David Dalton <http://allyoucanleet.com/>

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;((t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Twilio||(t.Twilio={})).Chat=e()}}(function(){return function(){return function e(t,r,n){function i(a,o){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!o&&u)return u(a,!0);if(s)return s(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){return i(t[a][1][e]||e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var s="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}}()({1:[function(e,t,r){"use strict";var n=w(e("babel-runtime/core-js/object/keys")),i=w(e("babel-runtime/core-js/get-iterator")),s=w(e("babel-runtime/helpers/toConsumableArray")),a=w(e("babel-runtime/core-js/set")),o=w(e("babel-runtime/regenerator")),u=w(e("babel-runtime/core-js/promise")),c=w(e("babel-runtime/helpers/asyncToGenerator")),l=w(e("babel-runtime/core-js/map")),d=w(e("babel-runtime/core-js/json/stringify")),f=w(e("babel-runtime/core-js/number/is-integer")),p=w(e("babel-runtime/core-js/object/get-prototype-of")),h=w(e("babel-runtime/helpers/classCallCheck")),b=w(e("babel-runtime/helpers/createClass")),m=w(e("babel-runtime/helpers/possibleConstructorReturn")),v=w(e("babel-runtime/helpers/inherits")),y=w(e("babel-runtime/core-js/reflect/metadata")),g=w(e("babel-runtime/core-js/object/define-property")),_=w(e("babel-runtime/helpers/typeof")),k=w(e("babel-runtime/core-js/object/get-own-property-descriptor"));function w(e){return e&&e.__esModule?e:{default:e}}var x=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=(0,k.default)(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,_.default)(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&(0,g.default)(t,r,a),a},C=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":(0,_.default)(Reflect))&&"function"==typeof y.default)return(0,y.default)(e,t)};Object.defineProperty(r,"__esModule",{value:!0}),r.Channel=void 0;var j=e("events"),S=e("./logger"),T=e("./data/members"),E=e("./member"),M=e("./data/messages"),I=e("./util"),R=e("twilio-sdk-type-validator"),P=S.Logger.scope("Channel"),O={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",type:"type",uniqueName:"uniqueName",state:"state"};function N(e){try{return new Date(e)}catch(e){return null}}var L=function(e){function t(e,r,n,i,s){(0,h.default)(this,t);var a=(0,m.default)(this,(t.__proto__||(0,p.default)(t)).call(this));a.sid=r,a.links=n,a.configuration=i,a.services=s;var o=e.attributes||{},u=e.createdBy,c=N(e.dateCreated),b=N(e.dateUpdated),v=e.friendlyName||null,y=(0,f.default)(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,g=e.uniqueName||null;try{(0,d.default)(o)}catch(e){throw new Error("Attributes must be a valid JSON object.")}a.entityName=e.channel,a.channelState={uniqueName:g,status:"notParticipating",type:e.type,attributes:o,createdBy:u,dateCreated:c,dateUpdated:b,friendlyName:v,lastConsumedMessageIndex:y},e.notificationLevel&&(a.channelState.notificationLevel=e.notificationLevel);var _={participants:a.links.participants};return a.members=new l.default,a.membersEntity=new T.Members(a,a.members,_,a.configuration,a.services),a.membersEntity.on("memberJoined",a.emit.bind(a,"memberJoined")),a.membersEntity.on("memberLeft",a.emit.bind(a,"memberLeft")),a.membersEntity.on("memberUpdated",function(e){return a.emit("memberUpdated",e)}),a.messagesEntity=new M.Messages(a,a.configuration,s),a.messagesEntity.on("messageAdded",function(e){return a._onMessageAdded(e)}),a.messagesEntity.on("messageUpdated",function(e){return a.emit("messageUpdated",e)}),a.messagesEntity.on("messageRemoved",a.emit.bind(a,"messageRemoved")),a}return(0,v.default)(t,e),(0,b.default)(t,[{key:"_subscribe",value:function(){var e=this;return this.entityPromise?this.entityPromise:this.entityPromise=this.entityPromise||this.services.syncClient.document({id:this.entityName,mode:"open_existing"}).then(function(t){return e.entity=t,e.entity.on("updated",function(t){e._update(t.data)}),e.entity.on("removed",function(){return e.emit("removed",e)}),e._update(e.entity.data),t}).catch(function(t){throw e.entity=null,e.entityPromise=null,"disconnected"!=e.services.syncClient.connectionState&&P.error("Failed to get channel object",t),P.debug("ERROR: Failed to get channel object",t),t})}},{key:"_subscribeStreams",value:function(){var e=(0,c.default)(o.default.mark(function e(){var t,r;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._subscribe();case 3:return P.trace("_subscribeStreams, this.entity.data=",this.entity.data),t=this.entity.data.messages,r=this.entity.data.roster,e.next=8,u.default.all([this.messagesEntity.subscribe(t),this.membersEntity.subscribe(r)]);case 8:e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),"disconnected"!==this.services.syncClient.connectionState&&P.error("Failed to subscribe on channel objects",this.sid,e.t0),P.debug("ERROR: Failed to subscribe on channel objects",this.sid,e.t0),e.t0;case 15:case"end":return e.stop()}},e,this,[[0,10]])}));return function(){return e.apply(this,arguments)}}()},{key:"_unsubscribe",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPrivate||!this.entity){e.next=5;break}return e.next=3,this.entity.close();case 3:this.entity=null,this.entityPromise=null;case 5:return e.abrupt("return",u.default.all([this.membersEntity.unsubscribe(),this.messagesEntity.unsubscribe()]));case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_setStatus",value:function(e,t){var r=this;this.statusSource=t,this.channelState.status!==e&&(this.channelState.status=e,"joined"===e?this._subscribeStreams().catch(function(t){if(P.debug("ERROR while setting channel status "+e,t),"disconnected"!==r.services.syncClient.connectionState)throw t}):"invited"===e?this._subscribe().catch(function(t){if(P.debug("ERROR while setting channel status "+e,t),"disconnected"!==r.services.syncClient.connectionState)throw t}):this.entityPromise&&this._unsubscribe().catch(function(t){if(P.debug("ERROR while setting channel status "+e,t),"disconnected"!==r.services.syncClient.connectionState)throw t}))}},{key:"_statusSource",value:function(){return this.statusSource}},{key:"_update",value:function(e){var r,o,u,c,l;P.trace("_update",e),t.preprocessUpdate(e,this.sid);var d=new a.default,f=!0,p=!1,h=void 0;try{for(var b,m=(0,i.default)((0,n.default)(e));!(f=(b=m.next()).done);f=!0){var v=b.value,y=O[v];if(y)switch(y){case O.status:if(!e.status||"unknown"===e.status||this.channelState.status===e.status)break;this.channelState.status=e.status,d.add(y);break;case O.attributes:if(I.isDeepEqual(this.channelState.attributes,e.attributes))break;this.channelState.attributes=e.attributes,d.add(y);break;case O.lastConsumedMessageIndex:if(void 0===e.lastConsumedMessageIndex||e.lastConsumedMessageIndex===this.channelState.lastConsumedMessageIndex)break;this.channelState.lastConsumedMessageIndex=e.lastConsumedMessageIndex,d.add(y);break;case O.lastMessage:if(this.channelState.lastMessage&&!e.lastMessage){delete this.channelState.lastMessage,d.add(y);break}this.channelState.lastMessage=this.channelState.lastMessage||{},void 0!==(null===(r=e.lastMessage)||void 0===r?void 0:r.index)&&e.lastMessage.index!==this.channelState.lastMessage.index&&(this.channelState.lastMessage.index=e.lastMessage.index,d.add(y)),void 0!==(null===(o=e.lastMessage)||void 0===o?void 0:o.timestamp)&&(null===(c=null===(u=this.channelState.lastMessage)||void 0===u?void 0:u.dateCreated)||void 0===c?void 0:c.getTime())!==e.lastMessage.timestamp.getTime()&&(this.channelState.lastMessage.dateCreated=e.lastMessage.timestamp,d.add(y)),I.isDeepEqual(this.channelState.lastMessage,{})&&delete this.channelState.lastMessage;break;case O.state:var g=e.state||void 0;if(void 0!==g&&(g.dateUpdated=new Date(g.dateUpdated)),I.isDeepEqual(this.channelState.state,g))break;this.channelState.state=g,d.add(y);break;default:var _=e[v]instanceof Date,k=_&&(null===(l=this.channelState[y])||void 0===l?void 0:l.getTime())===e[v].getTime(),w=!_&&this[y]===e[v];if(k||w)break;this.channelState[y]=e[v],d.add(y)}}}catch(e){p=!0,h=e}finally{try{!f&&m.return&&m.return()}finally{if(p)throw h}}d.size>0&&this.emit("updated",{channel:this,updateReasons:[].concat((0,s.default)(d))})}},{key:"_onMessageAdded",value:function(e){var t=!0,r=!1,n=void 0;try{for(var s,a=(0,i.default)(this.members.values());!(t=(s=a.next()).done);t=!0){var o=s.value;if(o.identity===e.author){o._endTyping();break}}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}this.emit("messageAdded",e)}},{key:"_setLastConsumedMessageIndex",value:function(){var e=(0,c.default)(o.default.mark(function e(t){var r;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.configuration.links.myConversations+"/"+this.sid,{last_consumed_message_index:t});case 2:return r=e.sent,e.abrupt("return",r.unread_messages_count);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"add",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.membersEntity.add(t);case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"advanceLastConsumedMessageIndex",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:if(!(t<this.lastConsumedMessageIndex)){e.next=6;break}return e.next=5,this._setLastConsumedMessageIndex(this.lastConsumedMessageIndex);case 5:return e.abrupt("return",e.sent);case 6:return e.next=8,this._setLastConsumedMessageIndex(t);case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"decline",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.invites+"/"+this.configuration.userIdentity);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getAttributes",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return e.abrupt("return",this.attributes);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getMessages",value:function(){var e=(0,c.default)(o.default.mark(function e(t,r,n){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.messagesEntity.getMessages(t,r,n));case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getMembers",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.membersEntity.getMembers());case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getMembersCount",value:function(){var e=(0,c.default)(o.default.mark(function e(){var t,r;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new I.UriBuilder(this.configuration.links.conversations).path(this.sid).build(),e.next=3,this.services.network.get(t);case 3:return r=e.sent,e.abrupt("return",r.body.participants_count);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getMemberBySid",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.membersEntity.getMemberBySid(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getMemberByIdentity",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.membersEntity.getMemberByIdentity(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getMessagesCount",value:function(){var e=(0,c.default)(o.default.mark(function e(){var t,r;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new I.UriBuilder(this.configuration.links.conversations).path(this.sid).build(),e.next=3,this.services.network.get(t);case 3:return r=e.sent,e.abrupt("return",r.body.messages_count);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getUnconsumedMessagesCount",value:function(){var e=(0,c.default)(o.default.mark(function e(){var t,r,n;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new I.UriBuilder(this.configuration.links.myConversations).path(this.sid).build(),e.next=3,this.services.network.get(t);case 3:if((r=e.sent).body.conversation_sid===this.sid){e.next=6;break}throw new Error("Channel was not found in the user channels list");case 6:if("number"!=typeof(n=r.body.unread_messages_count)){e.next=9;break}return e.abrupt("return",n);case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"invite",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.membersEntity.invite(t);case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"join",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:this.configuration.userIdentity});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"leave",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"!==this.channelState.status){e.next=3;break}return e.next=3,this.services.commandExecutor.mutateResource("delete",this.links.participants+"/"+this.configuration.userIdentity);case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"removeMember",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.membersEntity.remove("string"==typeof t?t:t.sid);case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"sendMessage",value:function(){var e=(0,c.default)(o.default.mark(function e(t,r){var n,i;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&null!==t){e.next=5;break}return e.next=3,this.messagesEntity.send(t,r);case 3:return n=e.sent,e.abrupt("return",I.parseToNumber(n.index));case 5:return e.next=7,this.messagesEntity.sendMedia(t,r);case 7:return i=e.sent,e.abrupt("return",I.parseToNumber(i.index));case 9:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"setAllMessagesConsumed",value:function(){var e=(0,c.default)(o.default.mark(function e(){var t;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this.getMessages(1);case 4:if(!((t=e.sent).items.length>0)){e.next=7;break}return e.abrupt("return",this.advanceLastConsumedMessageIndex(t.items[0].index));case 7:return e.abrupt("return",u.default.resolve(0));case 8:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setNoMessagesConsumed",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this._setLastConsumedMessageIndex(null);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setUserNotificationLevel",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.configuration.links.myConversations+"/"+this.sid,{notification_level:t});case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"typing",value:function(){return this.services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?(0,d.default)(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateFriendlyName",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.channelState.friendlyName===t){e.next=3;break}return e.next=3,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:t});case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateLastConsumedMessageIndex",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._setLastConsumedMessageIndex(t));case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateUniqueName",value:function(){var e=(0,c.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.channelState.uniqueName===t){e.next=4;break}return t||(t=""),e.next=4,this.services.commandExecutor.mutateResource("post",this.links.self,{unique_name:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUserDescriptors",value:function(){var e=(0,c.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.users.getChannelUserDescriptors(this.sid));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"status",get:function(){return this.channelState.status}},{key:"type",get:function(){return this.channelState.type}},{key:"uniqueName",get:function(){return this.channelState.uniqueName}},{key:"isPrivate",get:function(){return"private"===this.channelState.type}},{key:"friendlyName",get:function(){return this.channelState.friendlyName}},{key:"dateUpdated",get:function(){return this.channelState.dateUpdated}},{key:"dateCreated",get:function(){return this.channelState.dateCreated}},{key:"createdBy",get:function(){return this.channelState.createdBy}},{key:"attributes",get:function(){return this.channelState.attributes}},{key:"lastConsumedMessageIndex",get:function(){return this.channelState.lastConsumedMessageIndex}},{key:"lastMessage",get:function(){return this.channelState.lastMessage}},{key:"notificationLevel",get:function(){return this.channelState.notificationLevel}},{key:"state",get:function(){return this.channelState.state}}],[{key:"preprocessUpdate",value:function(e,t){try{"string"==typeof e.attributes?e.attributes=JSON.parse(e.attributes):e.attributes&&(0,d.default)(e.attributes)}catch(r){P.warn("Retrieved malformed attributes from the server for channel: "+t),e.attributes={}}try{e.dateCreated&&(e.dateCreated=new Date(e.dateCreated))}catch(r){P.warn("Retrieved malformed dateCreated from the server for channel: "+t),delete e.dateCreated}try{e.dateUpdated&&(e.dateUpdated=new Date(e.dateUpdated))}catch(r){P.warn("Retrieved malformed dateUpdated from the server for channel: "+t),delete e.dateUpdated}try{e.lastMessage&&e.lastMessage.timestamp&&(e.lastMessage.timestamp=new Date(e.lastMessage.timestamp))}catch(r){P.warn("Retrieved malformed lastMessage.timestamp from the server for channel: "+t),delete e.lastMessage.timestamp}}}]),t}(j.EventEmitter);x([R.validateTypesAsync(R.nonEmptyString),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"add",null),x([R.validateTypesAsync(R.nonNegativeInteger),C("design:type",Function),C("design:paramtypes",[Number]),C("design:returntype",u.default)],L.prototype,"advanceLastConsumedMessageIndex",null),x([R.validateTypesAsync(["undefined",R.nonNegativeInteger],["undefined",R.nonNegativeInteger],["undefined",R.literal("backwards","forward")]),C("design:type",Function),C("design:paramtypes",[Number,Number,String]),C("design:returntype",u.default)],L.prototype,"getMessages",null),x([R.validateTypesAsync(R.nonEmptyString),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"getMemberBySid",null),x([R.validateTypesAsync(R.nonEmptyString),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"getMemberByIdentity",null),x([R.validateTypesAsync(R.nonEmptyString),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"invite",null),x([R.validateTypesAsync([R.nonEmptyString,E.Member]),C("design:type",Function),C("design:paramtypes",[Object]),C("design:returntype",u.default)],L.prototype,"removeMember",null),x([R.validateTypesAsync(["string",R.literal(null),R.custom(function(e){return[e instanceof FormData,"an instance of FormData"]}),R.objectSchema("media options",{contentType:[R.nonEmptyString,"undefined"],media:R.custom(function(e){var t="string"==typeof e&&e.length>0||e instanceof Uint8Array||e instanceof ArrayBuffer;return"function"==typeof Blob&&(t=t||e instanceof Blob),[t,"a non-empty string, an instance of Buffer or an instance of Blob"]})})],["undefined","string","number","boolean","object",R.literal(null)]),C("design:type",Function),C("design:paramtypes",[Object,Object]),C("design:returntype",u.default)],L.prototype,"sendMessage",null),x([R.validateTypesAsync(R.literal("default","muted")),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"setUserNotificationLevel",null),x([R.validateTypesAsync(["string","number","boolean","object",R.literal(null)]),C("design:type",Function),C("design:paramtypes",[Object]),C("design:returntype",u.default)],L.prototype,"updateAttributes",null),x([R.validateTypesAsync("string"),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"updateFriendlyName",null),x([R.validateTypesAsync([R.literal(null),R.nonNegativeInteger]),C("design:type",Function),C("design:paramtypes",[Number]),C("design:returntype",u.default)],L.prototype,"updateLastConsumedMessageIndex",null),x([R.validateTypesAsync(["string",R.literal(null)]),C("design:type",Function),C("design:paramtypes",[String]),C("design:returntype",u.default)],L.prototype,"updateUniqueName",null),r.Channel=L},{"./data/members":7,"./data/messages":8,"./logger":14,"./member":16,"./util":25,"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/map":30,"babel-runtime/core-js/number/is-integer":31,"babel-runtime/core-js/object/define-property":34,"babel-runtime/core-js/object/get-own-property-descriptor":36,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/object/keys":38,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/reflect/metadata":42,"babel-runtime/core-js/set":43,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/toConsumableArray":53,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"twilio-sdk-type-validator":234}],2:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.ChannelDescriptor=void 0;var a=e("./logger"),o=e("./util"),u=a.Logger.scope("ChannelDescriptor"),c=function(){function e(t,r){(0,n.default)(this,e),this.client=t,this.descriptor=r,this.sid=r.sid||r.conversation_sid,this.channel=this.sid+".channel",this.uniqueName=r.unique_name,this.friendlyName=r.friendly_name,this.attributes=o.parseAttributes(r.attributes,"Failed to parse channel attributes",u),this.createdBy=r.created_by,this.dateCreated=o.parseTime(r.date_created),this.dateUpdated=o.parseTime(r.date_updated),this.messagesCount=r.messages_count,this.membersCount=r.participants_count,this.type=r.type,this.isPrivate="private"===r.type,this.lastConsumedMessageIndex=r.last_consumed_message_index,this.notificationLevel=r.notification_level||void 0,this.status=r.status||"unknown"}return(0,i.default)(e,[{key:"getChannel",value:function(){return this.client.getChannelBySid(this.sid)}}]),e}();r.ChannelDescriptor=c},{"./logger":14,"./util":25,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],3:[function(e,t,r){"use strict";var n=m(e("babel-runtime/regenerator")),i=m(e("babel-runtime/helpers/asyncToGenerator")),s=m(e("babel-runtime/core-js/promise")),a=m(e("babel-runtime/core-js/object/assign")),o=m(e("babel-runtime/core-js/object/get-prototype-of")),u=m(e("babel-runtime/helpers/createClass")),c=m(e("babel-runtime/helpers/possibleConstructorReturn")),l=m(e("babel-runtime/helpers/inherits")),d=m(e("babel-runtime/helpers/classCallCheck")),f=m(e("babel-runtime/core-js/reflect/metadata")),p=m(e("babel-runtime/core-js/object/define-property")),h=m(e("babel-runtime/helpers/typeof")),b=m(e("babel-runtime/core-js/object/get-own-property-descriptor"));function m(e){return e&&e.__esModule?e:{default:e}}var v=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=(0,b.default)(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&(0,p.default)(t,r,a),a},y=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof f.default)return(0,f.default)(e,t)};Object.defineProperty(r,"__esModule",{value:!0}),r.PushNotification=r.Client=r.User=void 0;var g=e("events"),_=e("./logger"),k=e("./configuration"),w=e("./user");Object.defineProperty(r,"User",{enumerable:!0,get:function(){return w.User}});var x=e("./data/publicchannels"),C=e("./services/network"),j=e("./interfaces/notificationtypes"),S=e("twilsock"),T=e("twilio-notifications"),E=e("twilio-sync"),M=e("twilio-mcs-client"),I=e("./data/channels"),R=e("./data/users"),P=e("./services/typingindicator"),O=e("./data/userchannels"),N=e("./pushnotification");Object.defineProperty(r,"PushNotification",{enumerable:!0,get:function(){return N.PushNotification}});var L=e("./util"),U=e("twilio-sdk-type-validator"),A=e("./commandexecutor"),D=_.Logger.scope("Client"),F=e("./../package.json").version,q=function e(){(0,d.default)(this,e)},B=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,d.default)(this,t);var i=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));if(i.options=n,i.connectionState="connecting",i.channelsPromise=null,i.configurationPromise=null,i.version=F,i.parsePushNotification=t.parsePushNotification,!i.options.disableDeepClone){var s=(0,a.default)((0,a.default)({},i.options),{transport:void 0,twilsockClient:void 0});(s=L.deepClone(s)).transport=i.options.transport,s.twilsockClient=i.options.twilsockClient,i.options=s}i.options.logLevel=i.options.logLevel||"silent",D.setLevel(i.options.logLevel);var u=i.options.productId="ip_messaging";if(i.options.clientMetadata=i.options.clientMetadata||{},i.options.clientMetadata.hasOwnProperty("type")||(i.options.clientMetadata.type="chat"),i.options.clientMetadata.hasOwnProperty("sdk")||(i.options.clientMetadata.sdk="JS",i.options.clientMetadata.sdkv=F),i.options.Sync=i.options.Sync||{},(null===(r=i.options.Sync)||void 0===r?void 0:r.enableSessionStorage)||(i.options.Sync.enableSessionStorage=!0),i.options.region&&(i.options.Sync.region=i.options.region),!e)throw new Error("A valid Twilio token should be provided");i.services=new q,i.options.twilsockClient=i.options.twilsockClient||new S.Twilsock(e,u,i.options),i.options.transport=i.options.transport||i.options.twilsockClient,i.options.notificationsClient=i.options.notificationsClient||new T.Notifications(e,i.options),i.options.syncClient=i.options.syncClient||new E.SyncClient(e,i.options),i.services.syncClient=i.options.syncClient,i.services.transport=i.options.transport,i.services.twilsockClient=i.options.twilsockClient,i.services.notificationClient=i.options.notificationsClient;var l=n.Chat||n.IPMessaging||n||{},f=l.region||n.region,p=l.apiUri||l.typingUri||"https://aim."+(f||"us1")+".twilio.com";return i.services.commandExecutor=new A.CommandExecutor(p,{transport:i.options.transport},u),i.configurationPromise=i.services.commandExecutor.fetchResource("Client/v1/Configuration"),i.configurationPromise.then(function(e){return i.configuration=new k.Configuration(i.options,e,D),i.services.typingIndicator=new P.TypingIndicator(i.getChannelBySid.bind(i),i.configuration,i.services),i.services.network=new C.Network(i.configuration,i.services),i.services.users=new R.Users(i.configuration,i.services),i.services.users.on("userSubscribed",i.emit.bind(i,"userSubscribed")),i.services.users.on("userUpdated",function(e){return i.emit("userUpdated",e)}),i.services.users.on("userUnsubscribed",i.emit.bind(i,"userUnsubscribed")),i.services.twilsockClient.on("tokenAboutToExpire",function(e){return i.emit("tokenAboutToExpire",e)}),i.services.twilsockClient.on("tokenExpired",function(){return i.emit("tokenExpired")}),i.services.twilsockClient.on("connectionError",function(e){return i.emit("connectionError",e)}),i.channels=new I.Channels(i.configuration,i.services),i.channels.on("channelAdded",i.emit.bind(i,"channelAdded")),i.channels.on("channelInvited",i.emit.bind(i,"channelInvited")),i.channels.on("channelRemoved",i.emit.bind(i,"channelRemoved")),i.channels.on("channelJoined",i.emit.bind(i,"channelJoined")),i.channels.on("channelLeft",i.emit.bind(i,"channelLeft")),i.channels.on("channelUpdated",function(e){return i.emit("channelUpdated",e)}),i.channels.on("memberJoined",i.emit.bind(i,"memberJoined")),i.channels.on("memberLeft",i.emit.bind(i,"memberLeft")),i.channels.on("memberUpdated",function(e){return i.emit("memberUpdated",e)}),i.channels.on("messageAdded",i.emit.bind(i,"messageAdded")),i.channels.on("messageUpdated",function(e){return i.emit("messageUpdated",e)}),i.channels.on("messageRemoved",i.emit.bind(i,"messageRemoved")),i.channels.on("typingStarted",i.emit.bind(i,"typingStarted")),i.channels.on("typingEnded",i.emit.bind(i,"typingEnded")),i.services.users.myself._ensureFetched()}),i.channelsPromise=i.configurationPromise.then(function(){return i.channels.fetchChannels()}).then(function(){return i.channels}),i.services.notificationClient.on("connectionStateChanged",function(e){var t=null;switch(e){case"connected":t="connected";break;case"denied":t="denied";break;case"disconnecting":t="disconnecting";break;case"disconnected":t="disconnected";break;default:t="connecting"}t!==i.connectionState&&(i.connectionState=t,i.emit("connectionStateChanged",i.connectionState))}),i.fpaToken=e,i}return(0,l.default)(t,e),(0,u.default)(t,[{key:"subscribeToPushNotifications",value:function(e){var t=this,r=[];return[j.NotificationTypes.NEW_MESSAGE,j.NotificationTypes.ADDED_TO_CHANNEL,j.NotificationTypes.INVITED_TO_CHANNEL,j.NotificationTypes.REMOVED_FROM_CHANNEL,j.NotificationTypes.TYPING_INDICATOR,j.NotificationTypes.CONSUMPTION_UPDATE].forEach(function(n){r.push(t.services.notificationClient.subscribe(n,e))}),s.default.all(r)}},{key:"unsubscribeFromPushNotifications",value:function(e){var t=this,r=[];return[j.NotificationTypes.NEW_MESSAGE,j.NotificationTypes.ADDED_TO_CHANNEL,j.NotificationTypes.INVITED_TO_CHANNEL,j.NotificationTypes.REMOVED_FROM_CHANNEL,j.NotificationTypes.TYPING_INDICATOR,j.NotificationTypes.CONSUMPTION_UPDATE].forEach(function(n){r.push(t.services.notificationClient.unsubscribe(n,e))}),s.default.all(r)}},{key:"initialize",value:function(){var e=(0,i.default)(n.default.mark(function e(){var r,i=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configurationPromise;case 2:return t.supportedPushChannels.forEach(function(e){return i.subscribeToPushNotifications(e)}),this.services.publicChannels=new x.PublicChannels(this,this.services,this.configuration.links.conversations),this.services.userChannels=new O.UserChannels(this,this.services,this.configuration.links.myConversations),(r=(0,a.default)(this.options)).transport=null,this.services.mcsClient=new M.McsClient(this.fpaToken,this.configuration.links.mediaService,r),e.next=10,this.services.typingIndicator.initialize();case 10:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"shutdown",value:function(){var e=(0,i.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.twilsockClient.disconnect();case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"updateToken",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(D.info("updateToken"),this.fpaToken!==t){e.next=3;break}return e.abrupt("return",this);case 3:return e.next=5,this.services.twilsockClient.updateToken(t).then(function(){return r.fpaToken=t}).then(function(){return r.services.mcsClient.updateToken(t)}).then(function(){return r.configurationPromise});case 5:return e.abrupt("return",this);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getChannelBySid",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.channels.myChannelsRead.promise.then(function(){return r.channels.getChannel(t).then(function(e){return e||r.services.publicChannels.getChannelBySid(t).then(function(e){return r.channels.pushChannel(e)})})}));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getChannelByUniqueName",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.channels.myChannelsRead.promise.then(function(){return r.services.publicChannels.getChannelByUniqueName(t).then(function(e){return r.channels.pushChannel(e)})}));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getSubscribedChannels",value:function(e){return this.channelsPromise.then(function(t){return t.getChannels(e)})}},{key:"getLocalChannels",value:function(e){return this.channelsPromise.then(function(r){var n=[];r.channels.forEach(function(e){n.push(e)});var i=(null==e?void 0:e.order)||"ascending";return e&&e.criteria&&("lastMessage"===e.criteria?n.sort(function(e,r){return t.compareChannelsByLastMessage(e,r,i)}):"uniqueName"===e.criteria?n.sort(function(e,r){return t.compareChannelsByStringProperty(e.uniqueName,r.uniqueName,i)}):"friendlyName"===e.criteria&&n.sort(function(e,r){return t.compareChannelsByStringProperty(e.friendlyName,r.friendlyName,i)})),n})}},{key:"getPublicChannelDescriptors",value:function(){return this.services.publicChannels.getChannels()}},{key:"getUserChannelDescriptors",value:function(){return this.services.userChannels.getChannels()}},{key:"createChannel",value:function(e){return e=e||{},this.channelsPromise.then(function(t){return t.addChannel(e)})}},{key:"setPushRegistrationId",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r){var i=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribeToPushNotifications(t).then(function(){return i.services.notificationClient.setPushRegistrationId(r,t)});case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"unsetPushRegistrationId",value:function(){var e=(0,i.default)(n.default.mark(function e(r){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==t.supportedPushChannels.indexOf(r)){e.next=2;break}throw new Error("Invalid or unsupported channelType: "+r);case 2:return e.next=4,this.unsubscribeFromPushNotifications(r);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"handlePushNotification",value:function(){var e=(0,i.default)(n.default.mark(function e(r){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:D.debug("handlePushNotification, notificationPayload=",r),this.emit("pushNotification",t.parsePushNotification(r));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUser",value:function(e){return this.services.users.getUser(e)}},{key:"getUserDescriptor",value:function(){var e=(0,i.default)(n.default.mark(function e(t){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.users.getUserDescriptor(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getSubscribedUsers",value:function(){var e=(0,i.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.users.getSubscribedUsers());case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"user",get:function(){return this.services.users.myself}},{key:"reachabilityEnabled",get:function(){return this.configuration.reachabilityEnabled}},{key:"token",get:function(){return this.fpaToken}}],[{key:"create",value:function(){var e=(0,i.default)(n.default.mark(function e(r,i){var s;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=new t(r,i),e.next=3,s.initialize();case 3:return e.abrupt("return",s);case 4:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"compareChannelsByLastMessage",value:function(e,t,r){if(e.lastMessage&&t.lastMessage){if(e.lastMessage.dateCreated&&t.lastMessage.dateCreated)return e.lastMessage.dateCreated.getTime()<t.lastMessage.dateCreated.getTime()?"ascending"===r?-1:1:"ascending"===r?1:-1;if(e.lastMessage.dateCreated)return-1;if(t.lastMessage.dateCreated)return 1}return e.lastMessage?-1:t.lastMessage?1:0}},{key:"compareChannelsByStringProperty",value:function(e,t,r){return e&&t?"ascending"===r?e.localeCompare(t):-1*e.localeCompare(t):e?-1:t?1:0}},{key:"parsePushNotificationChatData",value:function(e){var r={};for(var n in t.supportedPushDataFields)void 0!==e[n]&&null!==e[n]&&("message_index"===n?null!==L.parseToNumber(e[n])&&(r[t.supportedPushDataFields[n]]=Number(e[n])):r[t.supportedPushDataFields[n]]=e[n]);return r}},{key:"parsePushNotification",value:function(e){if(D.debug("parsePushNotification, notificationPayload=",e),void 0!==e.aps){if(!e.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var r=t.parsePushNotificationChatData(e),n=e.aps,i=null,s=null;return"string"==typeof n.alert?i=n.alert||null:(i=n.alert.body||null,s=n.alert.title||null),new N.PushNotification({title:s,body:i,sound:n.sound||null,badge:n.badge||null,action:n.category||null,type:e.twi_message_type,data:r})}if(void 0!==e.data){var a=e.data;if(!a.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var o=t.parsePushNotificationChatData(e.data);return new N.PushNotification({title:a.twi_title||null,body:a.twi_body||null,sound:a.twi_sound||null,badge:null,action:a.twi_action||null,type:a.twi_message_type,data:o})}throw new Error("Provided push notification payload is not Programmable Chat notification")}}]),t}(g.EventEmitter);B.version=F,B.supportedPushChannels=["fcm","apn","gcm"],B.supportedPushDataFields={channel_sid:"channelSid",message_sid:"messageSid",message_index:"messageIndex"},v([U.validateTypesAsync(U.nonEmptyString),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"updateToken",null),v([U.validateTypesAsync(U.nonEmptyString),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"getChannelBySid",null),v([U.validateTypesAsync(U.nonEmptyString),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"getChannelByUniqueName",null),v([U.validateTypesAsync(["undefined",U.objectSchema("sorting options",{criteria:[U.literal("lastMessage","friendlyName","uniqueName"),"undefined"],order:[U.literal("ascending","descending"),"undefined"]})]),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",s.default)],B.prototype,"getLocalChannels",null),v([U.validateTypesAsync(["undefined",U.objectSchema("channel options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",s.default)],B.prototype,"createChannel",null),v([U.validateTypesAsync(U.literal("gcm","fcm","apn"),"string"),y("design:type",Function),y("design:paramtypes",[String,String]),y("design:returntype",s.default)],B.prototype,"setPushRegistrationId",null),v([U.validateTypesAsync(U.literal("gcm","fcm","apn")),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"unsetPushRegistrationId",null),v([U.validateTypesAsync(U.pureObject),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",s.default)],B.prototype,"handlePushNotification",null),v([U.validateTypesAsync(U.nonEmptyString),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"getUser",null),v([U.validateTypesAsync(U.nonEmptyString),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",s.default)],B.prototype,"getUserDescriptor",null),v([U.validateTypesAsync("string",["undefined",U.pureObject]),y("design:type",Function),y("design:paramtypes",[String,Object]),y("design:returntype",s.default)],B,"create",null),v([U.validateTypes(U.pureObject),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",N.PushNotification)],B,"parsePushNotification",null),r.Client=B,r.default=B},{"./../package.json":296,"./commandexecutor":4,"./configuration":5,"./data/channels":6,"./data/publicchannels":9,"./data/userchannels":10,"./data/users":12,"./interfaces/notificationtypes":13,"./logger":14,"./pushnotification":18,"./services/network":20,"./services/typingindicator":21,"./user":22,"./util":25,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/define-property":34,"babel-runtime/core-js/object/get-own-property-descriptor":36,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/reflect/metadata":42,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"twilio-mcs-client":219,"twilio-notifications":229,"twilio-sdk-type-validator":234,"twilio-sync":242,twilsock:270}],4:[function(e,t,r){"use strict";var n=l(e("babel-runtime/regenerator")),i=l(e("babel-runtime/core-js/json/stringify")),s=l(e("babel-runtime/core-js/object/entries")),a=l(e("babel-runtime/core-js/object/assign")),o=l(e("babel-runtime/helpers/asyncToGenerator")),u=l(e("babel-runtime/helpers/classCallCheck")),c=l(e("babel-runtime/helpers/createClass"));function l(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.CommandExecutor=void 0;var d=e("uuid"),f=e("operation-retrier"),p=function(e){return e.replace(/(^\/+|\/+$)/g,"")},h=function(){function e(t,r,n){(0,u.default)(this,e),this._serviceUrl=t,this._services=r,this._productId=n}return(0,c.default)(e,[{key:"_preProcessUrl",value:function(e){var t=p(e);return/^https?:\/\//.test(e)?t:p(this._serviceUrl)+"/"+t}},{key:"_makeRequest",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r,o,u){var c,l,d,f;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:c=this._preProcessUrl(r),l=(0,a.default)({"Content-Type":"application/json; charset=utf-8"},u||{}),d=void 0,e.t0=t,e.next="get"===e.t0?6:"post"===e.t0?12:"delete"===e.t0?16:20;break;case 6:return f=c,o&&(f+="?"+(0,s.default)(o).map(function(e){return e.map(encodeURIComponent).join("=")}).join("&")),e.next=10,this._services.transport.get(f,l,this._productId);case 10:return d=e.sent,e.abrupt("break",20);case 12:return e.next=14,this._services.transport.post(c,l,(0,i.default)(o),this._productId);case 14:return d=e.sent,e.abrupt("break",20);case 16:return e.next=18,this._services.transport.delete(c,l,this._productId);case 18:return d=e.sent,e.abrupt("break",20);case 20:if(!(d.status.code<200||d.status.code>=300)){e.next=22;break}throw new Error("Request responded with a non-success code "+d.status.code);case 22:return e.abrupt("return",d);case 23:case"end":return e.stop()}},e,this)}));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"fetchResource",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r){var i,s=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return 6,i=void 0,e.prev=2,e.next=5,new f.Retrier({min:50,max:1600,maxAttemptsCount:6}).run(function(){return s._makeRequest("get",t,r)});case 5:i=e.sent,e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(2),new Error('Fetch resource from "'+t+'" failed.');case 11:return e.abrupt("return",i.body);case 12:case"end":return e.stop()}},e,this,[[2,8]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"mutateResource",value:function(){var e=(0,o.default)(n.default.mark(function e(t,r,i){var s;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._makeRequest(t,r,i,{"X-Twilio-Mutation-Id":d.v4()});case 2:if(s=e.sent,202!==s.status.code){e.next=7;break}return e.next=6,this.fetchResource(s.body.resource_url);case 6:return e.abrupt("return",e.sent);case 7:return e.abrupt("return",s.body);case 8:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()}]),e}();r.CommandExecutor=h},{"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/entries":35,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55,"operation-retrier":206,uuid:291}],5:[function(e,t,r){"use strict";var n=s(e("babel-runtime/core-js/object/assign")),i=s(e("babel-runtime/helpers/classCallCheck"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Configuration=void 0;var a=e("iso8601-duration");r.Configuration=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments[1],s=arguments[2];(0,i.default)(this,e),this.typingIndicatorTimeoutDefault=5e3;var o=t.Chat||t.IPMessaging||t||{};this.productId=o.productId,this.links={myConversations:r.links.my_conversations,conversations:r.links.conversations,users:r.links.users,currentUser:r.links.current_user,typing:r.links.typing,mediaService:r.links.media_service,messagesReceipts:r.links.messages_receipts},this.typingIndicatorTimeoutOverride=o.typingIndicatorTimeoutOverride,this.backoffConfiguration=(0,n.default)({min:1e3,max:4e3,maxAttemptsCount:3},o.backoffConfigOverride),this.retryWhenThrottled=void 0===o.retryWhenThrottledOverride||o.retryWhenThrottledOverride,this.userInfosToSubscribe=o.userInfosToSubscribeOverride||r.options.user_infos_to_subscribe||100,this.reachabilityEnabled=r.options.reachability_enabled,this.userIdentity=r.identity,this.userInfo=r.sync_objects.my_user_info,this.myConversations=r.sync_objects.my_conversations;var u=o.httpCacheIntervalOverride||r.options.http_cache_interval||"PT5S";try{this.httpCacheInterval=a.toSeconds(a.parse(u))}catch(e){s.error("Failed to parse http cache interval "+u+", using default value PT5S"),this.httpCacheInterval=a.toSeconds(a.parse("PT5S"))}var c=o.consumptionReportIntervalOverride||r.options.consumption_report_interval||"PT5S";try{this.consumptionReportInterval=a.toSeconds(a.parse(c))}catch(e){s.error("Failed to parse consumption report interval "+c+", using default value PT5S"),this.consumptionReportInterval=a.toSeconds(a.parse("PT5S"))}}},{"babel-runtime/core-js/object/assign":32,"babel-runtime/helpers/classCallCheck":47,"iso8601-duration":202}],6:[function(e,t,r){"use strict";var n=v(e("babel-runtime/helpers/toConsumableArray")),i=v(e("babel-runtime/core-js/get-iterator")),s=v(e("babel-runtime/core-js/promise")),a=v(e("babel-runtime/core-js/object/assign")),o=v(e("babel-runtime/core-js/json/stringify")),u=v(e("babel-runtime/regenerator")),c=v(e("babel-runtime/helpers/asyncToGenerator")),l=v(e("babel-runtime/core-js/set")),d=v(e("babel-runtime/core-js/map")),f=v(e("babel-runtime/core-js/object/get-prototype-of")),p=v(e("babel-runtime/helpers/classCallCheck")),h=v(e("babel-runtime/helpers/createClass")),b=v(e("babel-runtime/helpers/possibleConstructorReturn")),m=v(e("babel-runtime/helpers/inherits"));function v(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Channels=r.Channel=void 0;var y=e("events"),g=e("../logger"),_=e("../channel");Object.defineProperty(r,"Channel",{enumerable:!0,get:function(){return _.Channel}});var k=e("../util/deferred"),w=e("../util"),x=g.Logger.scope("Channels"),C=function(e){function t(e,r){(0,p.default)(this,t);var n=(0,b.default)(this,(t.__proto__||(0,f.default)(t)).call(this));return n.configuration=e,n.services=r,n.channels=new d.default,n.tombstones=new l.default,n.myChannelsFetched=!1,n.myChannelsRead=new k.Deferred,n}return(0,m.default)(t,e),(0,h.default)(t,[{key:"getMap",value:function(){var e=(0,c.default)(u.default.mark(function e(){return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.syncClient.map({id:this.configuration.myConversations,mode:"open_existing"});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"addChannel",value:function(){var e=(0,c.default)(u.default.mark(function e(t){var r,n,i,s,c,l,d;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,r=void 0===t.attributes?{}:t.attributes,e.next=4,this.services.commandExecutor.mutateResource("post",this.configuration.links.conversations,{type:t.isPrivate?"private":"public",unique_name:t.uniqueName,friendly_name:t.friendlyName,attributes:void 0!==r?(0,o.default)(r):void 0});case 4:if(n=e.sent,i=n.sid||null,s=n.sync_objects.conversation||null,c=(0,a.default)({self:n.url},n.links),!(l=this.channels.get(i))){e.next=13;break}return e.next=12,l._subscribe();case 12:return e.abrupt("return",l);case 13:return d=new _.Channel({channel:s,entityName:null,uniqueName:null,attributes:null,createdBy:null,friendlyName:null,lastConsumedMessageIndex:null,type:t.isPrivate?"private":"public",dateCreated:null,dateUpdated:null},i,c,this.configuration,this.services),this.channels.set(d.sid,d),this.registerForEvents(d),e.next=18,d._subscribe();case 18:return this.emit("channelAdded",d),e.abrupt("return",d);case 20:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchChannels",value:function(){var e=(0,c.default)(u.default.mark(function e(){var t,r,n,a,o,c,l,d,f,p=this;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getMap();case 3:return(t=e.sent).on("itemAdded",function(e){x.debug("itemAdded: "+e.item.key),p.upsertChannel("sync",e.item.key,e.item.data)}),t.on("itemRemoved",function(e){x.debug("itemRemoved: "+e.key);var t=e.key;p.myChannelsFetched||p.tombstones.add(t);var r=p.channels.get(t);r&&("joined"!==r.status&&"invited"!==r.status||(r._setStatus("notParticipating","sync"),p.emit("channelLeft",r)),r.isPrivate&&(p.channels.delete(t),p.emit("channelRemoved",r),r.emit("removed",r)))}),t.on("itemUpdated",function(e){x.debug("itemUpdated: "+e.item.key),p.upsertChannel("sync",e.item.key,e.item.data)}),e.next=9,this._fetchMyChannels();case 9:for(r=e.sent,n=[],a=!0,o=!1,c=void 0,e.prev=14,l=(0,i.default)(r);!(a=(d=l.next()).done);a=!0)f=d.value,n.push(this.upsertChannel("rest",f.channel_sid,f));e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),o=!0,c=e.t0;case 22:e.prev=22,e.prev=23,!a&&l.return&&l.return();case 25:if(e.prev=25,!o){e.next=28;break}throw c;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return this.myChannelsRead.set(!0),e.next=33,s.default.all(n);case 33:return this.myChannelsFetched=!0,this.tombstones.clear(),x.debug("The channels list has been successfully fetched"),e.abrupt("return",this);case 39:throw e.prev=39,e.t1=e.catch(0),"Failed to fetch the channels list","disconnected"!==this.services.syncClient.connectionState&&x.error("Failed to fetch the channels list",e.t1),x.debug("ERROR: Failed to fetch the channels list",e.t1),e.t1;case 45:case"end":return e.stop()}},e,this,[[0,39],[14,18,22,30],[23,,25,29]])}));return function(){return e.apply(this,arguments)}}()},{key:"_wrapPaginator",value:function(e,t){var r=this;return t(e.items).then(function(n){return{items:n,hasNextPage:e.hasNextPage,hasPrevPage:e.hasPrevPage,nextPage:function(){return e.nextPage().then(function(e){return r._wrapPaginator(e,t)})},prevPage:function(){return e.prevPage().then(function(e){return r._wrapPaginator(e,t)})}}})}},{key:"getChannels",value:function(e){var t=this;return this.getMap().then(function(t){return t.getItems(e)}).then(function(e){return t._wrapPaginator(e,function(e){return s.default.all(e.map(function(e){return t.upsertChannel("sync",e.key,e.data)}))})})}},{key:"getChannel",value:function(e){var t=this;return this.getMap().then(function(t){return t.getItems({key:e})}).then(function(e){return e.items.map(function(e){return t.upsertChannel("sync",e.key,e.data)})}).then(function(e){return e.length>0?e[0]:null})}},{key:"pushChannel",value:function(e){var t=e.sid,r={entityName:null,lastConsumedMessageIndex:e.lastConsumedMessageIndex,type:e.type,status:e.status,friendlyName:e.friendlyName,dateUpdated:e.dateUpdated,dateCreated:e.dateCreated,uniqueName:e.uniqueName,createdBy:e.createdBy,attributes:e.attributes,channel:e.channel,notificationLevel:e.notificationLevel,sid:t};return this.upsertChannel("chat",t,r)}},{key:"_updateChannel",value:function(e,t,r){var n=this,i=void 0!==t._statusSource()&&e!==t._statusSource(),s="rest"!==e||"sync"===t._statusSource();if(i&&s&&"sync"!==e)x.trace("upsertChannel: the channel is known from sync and it came from chat, ignoring",{sid:t.sid,data:r.status,channel:t.status});else{if(["joined","invited"].includes(r.status)&&t.status!==r.status){t._setStatus(r.status,e);var a={};return void 0!==r.notificationLevel&&(a.notificationLevel=r.notificationLevel),void 0!==r.lastConsumedMessageIndex&&(a.lastConsumedMessageIndex=r.lastConsumedMessageIndex),w.isDeepEqual(a,{})||t._update(a),void t._subscribe().then(function(){n.emit("joined"===r.status?"channelJoined":"channelInvited",t)})}if(["joined","invited"].includes(t.status)&&"notParticipating"===r.status)return t._setStatus("notParticipating",e),t._update(r),void t._subscribe().then(function(){n.emit("channelLeft",t)});"private"!==r.type||"notParticipating"!==r.status?t._update(r):t._subscribe()}}},{key:"upsertChannel",value:function(e,t,r){var n=this;x.trace("upsertChannel called for "+t,r);var i=this.channels.get(t);if(i)return x.trace("upsertChannel: the channel "+i.sid+" is known;its status is known from source "+i._statusSource()+" and the update came from source "+e,i),this._updateChannel(e,i,r),i._subscribe().then(function(){return i});if(!["chat","rest"].includes(e)||!this.tombstones.has(t)){x.trace("upsertChannel: creating a local channel object with sid "+t,r);var s=this.configuration.links.conversations+"/"+t,a={self:s,messages:s+"/Messages",participants:s+"/Participants",invites:s+"/Invites"},o=new _.Channel(r,t,a,this.configuration,this.services);return this.channels.set(t,o),o._subscribe().then(function(){return n.registerForEvents(o),n.emit("channelAdded",o),["joined","invited"].includes(r.status)&&(o._setStatus(r.status,e),n.emit("joined"===r.status?"channelJoined":"channelInvited",o)),o})}x.trace("upsertChannel: the channel is deleted but reappeared again from chat, ignoring",t)}},{key:"onChannelRemoved",value:function(e){var t=this.channels.get(e);t&&(this.channels.delete(e),this.emit("channelRemoved",t))}},{key:"registerForEvents",value:function(e){var t=this;e.on("removed",function(){return t.onChannelRemoved(e.sid)}),e.on("updated",function(e){return t.emit("channelUpdated",e)}),e.on("memberJoined",this.emit.bind(this,"memberJoined")),e.on("memberLeft",this.emit.bind(this,"memberLeft")),e.on("memberUpdated",function(e){return t.emit("memberUpdated",e)}),e.on("messageAdded",this.emit.bind(this,"messageAdded")),e.on("messageUpdated",function(e){return t.emit("messageUpdated",e)}),e.on("messageRemoved",this.emit.bind(this,"messageRemoved")),e.on("typingStarted",this.emit.bind(this,"typingStarted")),e.on("typingEnded",this.emit.bind(this,"typingEnded"))}},{key:"_fetchMyChannels",value:function(){var e=(0,c.default)(u.default.mark(function e(){var t,r,i,s,a;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=null;case 2:return i=new w.UriBuilder(this.configuration.links.myConversations),r&&i.arg("PageToken",r),e.next=6,this.services.network.get(i.build());case 6:s=e.sent,a=s.body.conversations.map(function(e){return{descriptor:e,channel_sid:e.conversation_sid,status:e.status,channel:e.sync_objects.conversation,messages:e.sync_objects.messages,roster:e.conversation_sid+".roster",lastConsumedMessageIndex:e.last_consumed_message_index,notificationLevel:e.notification_level}}),r=s.body.meta.next_token,t=[].concat((0,n.default)(t),(0,n.default)(a));case 10:if(r){e.next=2;break}case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}(y.EventEmitter);r.Channels=C},{"../channel":1,"../logger":14,"../util":25,"../util/deferred":24,"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/set":43,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/toConsumableArray":53,"babel-runtime/regenerator":55,events:201}],7:[function(e,t,r){"use strict";var n=d(e("babel-runtime/core-js/promise")),i=d(e("babel-runtime/regenerator")),s=d(e("babel-runtime/helpers/asyncToGenerator")),a=d(e("babel-runtime/core-js/object/get-prototype-of")),o=d(e("babel-runtime/helpers/classCallCheck")),u=d(e("babel-runtime/helpers/createClass")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Members=void 0;var f=e("events"),p=e("../member"),h=e("../logger").Logger.scope("Members"),b=function(e){function t(e,r,n,i,s){(0,o.default)(this,t);var u=(0,c.default)(this,(t.__proto__||(0,a.default)(t)).call(this));return u.channel=e,u.members=r,u.links=n,u.configuration=i,u.services=s,u}return(0,l.default)(t,e),(0,u.default)(t,[{key:"unsubscribe",value:function(){var e=(0,s.default)(i.default.mark(function e(){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rosterEntityPromise){e.next=6;break}return e.next=3,this.rosterEntityPromise;case 3:e.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"subscribe",value:function(e){var t=this;return this.rosterEntityPromise=this.rosterEntityPromise||this.services.syncClient.map({id:e,mode:"open_existing"}).then(function(e){e.on("itemAdded",function(e){h.debug(t.channel.sid+" itemAdded: "+e.item.key),t.upsertMember(e.item.key,e.item.data).then(function(e){t.emit("memberJoined",e)})}),e.on("itemRemoved",function(e){h.debug(t.channel.sid+" itemRemoved: "+e.key);var r=e.key;if(t.members.has(r)){var n=t.members.get(r);t.members.delete(r),t.emit("memberLeft",n)}}),e.on("itemUpdated",function(e){h.debug(t.channel.sid+" itemUpdated: "+e.item.key),t.upsertMember(e.item.key,e.item.data)});var r=[],i=t;return e.getItems().then(function e(t){return t.items.forEach(function(e){r.push(i.upsertMember(e.key,e.data))}),t.hasNextPage?t.nextPage().then(e):null}).then(function(){return n.default.all(r)}).then(function(){return e})}).catch(function(e){throw t.rosterEntityPromise=null,"disconnected"!=t.services.syncClient.connectionState&&h.error("Failed to get roster object for channel",t.channel.sid,e),h.debug("ERROR: Failed to get roster object for channel",t.channel.sid,e),e})}},{key:"upsertMember",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var n,s,a=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.members.get(t))){e.next=3;break}return e.abrupt("return",n._update(r));case 3:return s={self:this.links.participants+"/"+t},n=new p.Member(r,t,this.channel,s,this.services),this.members.set(t,n),n.on("updated",function(e){return a.emit("memberUpdated",e)}),e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"getMembers",value:function(){var e=this;return this.rosterEntityPromise.then(function(){var t=[];return e.members.forEach(function(e){return t.push(e)}),t})}},{key:"getMemberBySid",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise.then(function(){var e=r.members.get(t);if(!e)throw new Error("Member with SID "+t+" was not found");return e}));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getMemberByIdentity",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=null,e.abrupt("return",this.rosterEntityPromise.then(function(){if(n.members.forEach(function(e){e.identity===t&&(r=e)}),!r)throw new Error("Member with identity "+t+" was not found");return r}));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"add",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:t});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"invite",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.channel.links.invites,{identity:t});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.participants+"/"+t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),t}(f.EventEmitter);r.Members=b},{"../logger":14,"../member":16,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201}],8:[function(e,t,r){"use strict";var n=p(e("babel-runtime/core-js/promise")),i=p(e("babel-runtime/core-js/json/stringify")),s=p(e("babel-runtime/regenerator")),a=p(e("babel-runtime/helpers/asyncToGenerator")),o=p(e("babel-runtime/core-js/map")),u=p(e("babel-runtime/core-js/object/get-prototype-of")),c=p(e("babel-runtime/helpers/classCallCheck")),l=p(e("babel-runtime/helpers/createClass")),d=p(e("babel-runtime/helpers/possibleConstructorReturn")),f=p(e("babel-runtime/helpers/inherits"));function p(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Messages=void 0;var h=e("events"),b=e("../logger"),m=e("../message"),v=b.Logger.scope("Messages"),y=function(e){function t(e,r,n){(0,c.default)(this,t);var i=(0,d.default)(this,(t.__proto__||(0,u.default)(t)).call(this));return i.channel=e,i.configuration=r,i.services=n,i.messagesByIndex=new o.default,i.messagesListPromise=null,i}return(0,f.default)(t,e),(0,l.default)(t,[{key:"subscribe",value:function(e){var t=this;return this.messagesListPromise=this.messagesListPromise||this.services.syncClient.list({id:e,mode:"open_existing"}).then(function(e){return e.on("itemAdded",function(e){v.debug(t.channel.sid+" itemAdded: "+e.item.index);var r={self:t.channel.links.messages+"/"+e.item.data.sid,conversation:t.channel.links.self,messages_receipts:t.channel.links.messages+"/"+e.item.data.sid+"/Receipts"},n=new m.Message(e.item.index,e.item.data,t.channel,r,t.configuration,t.services);t.messagesByIndex.has(n.index)?v.debug("Message arrived, but already known and ignored",t.channel.sid,n.index):(t.messagesByIndex.set(n.index,n),n.on("updated",function(e){return t.emit("messageUpdated",e)}),t.emit("messageAdded",n))}),e.on("itemRemoved",function(e){v.debug(t.channel.sid+" itemRemoved: "+e.index);var r=e.index;if(t.messagesByIndex.has(r)){var n=t.messagesByIndex.get(r);t.messagesByIndex.delete(n.index),n.removeAllListeners("updated"),t.emit("messageRemoved",n)}}),e.on("itemUpdated",function(e){v.debug(t.channel.sid+" itemUpdated: "+e.item.index);var r=t.messagesByIndex.get(e.item.index);r&&r._update(e.item.data)}),e}).catch(function(e){throw t.messagesListPromise=null,"disconnected"!=t.services.syncClient.connectionState&&v.error("Failed to get messages object for channel",t.channel.sid,e),v.debug("ERROR: Failed to get messages object for channel",t.channel.sid,e),e})}},{key:"unsubscribe",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.messagesListPromise){e.next=6;break}return e.next=3,this.messagesListPromise;case 3:e.sent.close(),this.messagesListPromise=null;case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"send",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return v.debug("Sending text message",t,r),e.next=3,this.services.commandExecutor.mutateResource("post",this.channel.links.messages,{body:t||"",attributes:void 0!==r?(0,i.default)(r):void 0});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"sendMedia",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(v.debug("Sending media message",t,a),r=void 0,!("undefined"!=typeof FormData&&t instanceof FormData)){e.next=9;break}return v.debug("Sending media message as FormData",t,a),e.next=6,this.services.mcsClient.postFormData(t);case 6:r=e.sent,e.next=16;break;case 9:if(v.debug("Sending media message as SendMediaOptions",t,a),(n=t).contentType&&n.media){e.next=13;break}throw new Error("Media content <Channel#SendMediaOptions> must contain non-empty contentType and media");case 13:return e.next=15,this.services.mcsClient.post(n.contentType,n.media);case 15:r=e.sent;case 16:return e.next=18,this.services.commandExecutor.mutateResource("post",this.channel.links.messages,{media_sid:r.sid,attributes:void 0!==a?(0,i.default)(a):void 0});case 18:return e.abrupt("return",e.sent);case 19:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getMessages",value:function(e,t,r){return t=void 0!==t?t:"end",r=r||"backwards",this._getMessages(e,t,r)}},{key:"wrapPaginator",value:function(e,t,r){var n=this,i="desc"===e,s=function(){return t.nextPage().then(function(t){return n.wrapPaginator(e,t,r)})},a=function(){return t.prevPage().then(function(t){return n.wrapPaginator(e,t,r)})};return r(t.items).then(function(e){return{items:e.sort(function(e,t){return e.index-t.index}),hasPrevPage:i?t.hasNextPage:t.hasPrevPage,hasNextPage:i?t.hasPrevPage:t.hasNextPage,prevPage:i?s:a,nextPage:i?a:s}})}},{key:"_upsertMessage",value:function(e,t){var r=this,n=this.messagesByIndex.get(e);if(n)return n;var i={self:this.channel.links.messages+"/"+t.sid,conversation:this.channel.links.self,messages_receipts:this.channel.links.messages+"/"+t.sid+"/Receipts"},s=new m.Message(e,t,this.channel,i,this.configuration,this.services);return this.messagesByIndex.set(s.index,s),s.on("updated",function(e){return r.emit("messageUpdated",e)}),s}},{key:"_getMessages",value:function(e,t,r){var i=this;t=void 0!==t?t:"end",e=e||30;var s="backwards"===r?"desc":"asc";return this.messagesListPromise.then(function(r){return r.getItems({from:"end"!==t?t:void 0,pageSize:e,order:s})}).then(function(e){return i.wrapPaginator(s,e,function(e){return n.default.all(e.map(function(e){return i._upsertMessage(e.index,e.data)}))})})}}]),t}(h.EventEmitter);r.Messages=y},{"../logger":14,"../message":17,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201}],9:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.PublicChannels=void 0;var u=e("../util/index"),c=e("../restpaginator"),l=e("../channeldescriptor"),d=function(){function e(t,r,n){(0,s.default)(this,e),this.client=t,this.services=r,this.url=n}return(0,a.default)(e,[{key:"getChannels",value:function(){var e=(0,i.default)(n.default.mark(function e(){var t,r,i=this,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new u.UriBuilder(this.url).arg("PageToken",s.pageToken).build(),e.next=3,this.services.network.get(t);case 3:return r=e.sent,e.abrupt("return",new c.RestPaginator(r.body.conversations.map(function(e){return new l.ChannelDescriptor(i.client,e)}),function(e){return i.getChannels({pageToken:e})},r.body.meta.previous_token,r.body.meta.next_token));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getChannelBySid",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new u.UriBuilder(this.url).path(t).build(),e.next=3,this.services.network.get(r);case 3:return i=e.sent,e.abrupt("return",new l.ChannelDescriptor(this.client,i.body));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getChannelByUniqueName",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new u.UriBuilder(this.url).path(t).build(),e.next=3,this.services.network.get(r);case 3:return i=e.sent,e.abrupt("return",new l.ChannelDescriptor(this.client,i.body));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();r.PublicChannels=d},{"../channeldescriptor":2,"../restpaginator":19,"../util/index":25,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],10:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.UserChannels=void 0;var u=e("../util/index"),c=e("../restpaginator"),l=e("../channeldescriptor"),d=function(){function e(t,r,n){(0,s.default)(this,e),this.client=t,this.services=r,this.url=n}return(0,a.default)(e,[{key:"getChannels",value:function(){var e=(0,i.default)(n.default.mark(function e(){var t,r,i=this,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new u.UriBuilder(this.url).arg("PageToken",s.pageToken).build(),e.next=3,this.services.network.get(t);case 3:return r=e.sent,e.abrupt("return",new c.RestPaginator(r.body.conversations.map(function(e){return new l.ChannelDescriptor(i.client,e)}),function(e){return i.getChannels({pageToken:e})},r.body.meta.previous_token,r.body.meta.next_token));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}();r.UserChannels=d},{"../channeldescriptor":2,"../restpaginator":19,"../util/index":25,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],11:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.UserDescriptors=void 0;var u=e("../util/index"),c=e("../restpaginator"),l=e("../userdescriptor"),d=function(){function e(t,r){(0,s.default)(this,e),this.configuration=t,this.services=r}return(0,a.default)(e,[{key:"getUserDescriptor",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new u.UriBuilder(this.configuration.links.users).path(t).build(),e.next=3,this.services.network.get(r);case 3:return i=e.sent,e.abrupt("return",new l.UserDescriptor(this.services,i.body));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getChannelUserDescriptors",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i,s=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new u.UriBuilder(this.configuration.links.users).arg("ConversationSid",t).arg("PageToken",a.pageToken).build(),e.next=3,this.services.network.get(r);case 3:return i=e.sent,e.abrupt("return",new c.RestPaginator(i.body.users.map(function(e){return new l.UserDescriptor(s.services,e)}),function(e){return s.getChannelUserDescriptors(t,{pageToken:e})},i.body.meta.prev_token,i.body.meta.next_token));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();r.UserDescriptors=d},{"../restpaginator":19,"../userdescriptor":23,"../util/index":25,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],12:[function(e,t,r){"use strict";var n=f(e("babel-runtime/regenerator")),i=f(e("babel-runtime/helpers/asyncToGenerator")),s=f(e("babel-runtime/core-js/object/assign")),a=f(e("babel-runtime/core-js/map")),o=f(e("babel-runtime/core-js/object/get-prototype-of")),u=f(e("babel-runtime/helpers/classCallCheck")),c=f(e("babel-runtime/helpers/createClass")),l=f(e("babel-runtime/helpers/possibleConstructorReturn")),d=f(e("babel-runtime/helpers/inherits"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Users=void 0;var p=e("events"),h=e("../user"),b=e("./userdescriptors"),m=function(e){function t(e,r){(0,u.default)(this,t);var n=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));n.configuration=e,n.services=r;var i={self:e.links.users+"/"+e.userIdentity};return n.fifoStack=[],n.myself=new h.User(n.configuration.userIdentity,n.configuration.userInfo,i,n.configuration,n.services),n.myself.on("updated",function(e){return n.emit("userUpdated",e)}),n.myself.on("userSubscribed",function(){return n.emit("userSubscribed",n.myself)}),n.myself.on("userUnsubscribed",function(){n.emit("userUnsubscribed",n.myself),n.myself._ensureFetched()}),n.subscribedUsers=new a.default,n.userDescriptors=new b.UserDescriptors(n.configuration,(0,s.default)((0,s.default)({},n.services),{users:n})),n}return(0,d.default)(t,e),(0,c.default)(t,[{key:"handleUnsubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)&&this.subscribedUsers.delete(e.identity);var t=-1;this.fifoStack.find(function(r,n){return r==e.identity&&(t=n,!0)})&&this.fifoStack.splice(t,1),this.emit("userUnsubscribed",e)}},{key:"handleSubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)||(this.fifoStack.length>=this.configuration.userInfosToSubscribe&&this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe(),this.fifoStack.push(e.identity),this.subscribedUsers.set(e.identity,e),this.emit("userSubscribed",e))}},{key:"getUser",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i,s,a=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:if(t!=this.myself.identity){e.next=4;break}return e.abrupt("return",this.myself);case 4:if(r=this.subscribedUsers.get(t)){e.next=18;break}if(o){e.next=11;break}return e.next=9,this.getUserDescriptor(t);case 9:i=e.sent,o=i._getDescriptor().sync_objects.user_info_map;case 11:return s={self:this.configuration.links.users+"/"+t},(r=new h.User(t,o,s,this.configuration,this.services)).on("updated",function(e){return a.emit("userUpdated",e)}),r.on("userSubscribed",function(){return a.handleSubscribeUser(r)}),r.on("userUnsubscribed",function(){return a.handleUnsubscribeUser(r)}),e.next=18,r._ensureFetched();case 18:return e.abrupt("return",r);case 19:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUserDescriptor",value:function(){var e=(0,i.default)(n.default.mark(function e(t){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.userDescriptors.getUserDescriptor(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getChannelUserDescriptors",value:function(){var e=(0,i.default)(n.default.mark(function e(t){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.userDescriptors.getChannelUserDescriptors(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getSubscribedUsers",value:function(){var e=(0,i.default)(n.default.mark(function e(){var t;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:return t=[this.myself],this.subscribedUsers.forEach(function(e){return t.push(e)}),e.abrupt("return",t);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),t}(p.EventEmitter);r.Users=m},{"../user":22,"./userdescriptors":11,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201}],13:[function(e,t,r){"use strict";var n,i=e("babel-runtime/helpers/classCallCheck"),s=(n=i)&&n.__esModule?n:{default:n};Object.defineProperty(r,"__esModule",{value:!0}),r.NotificationTypes=void 0;var a=function e(){(0,s.default)(this,e)};r.NotificationTypes=a,a.TYPING_INDICATOR="twilio.ipmsg.typing_indicator",a.NEW_MESSAGE="twilio.channel.new_message",a.ADDED_TO_CHANNEL="twilio.channel.added_to_channel",a.INVITED_TO_CHANNEL="twilio.channel.invited_to_channel",a.REMOVED_FROM_CHANNEL="twilio.channel.removed_from_channel",a.CONSUMPTION_UPDATE="twilio.channel.consumption_update"},{"babel-runtime/helpers/classCallCheck":47}],14:[function(e,t,r){"use strict";var n=a(e("babel-runtime/helpers/classCallCheck")),i=a(e("babel-runtime/helpers/createClass")),s=a(e("babel-runtime/core-js/array/from"));function a(e){return e&&e.__esModule?e:{default:e}}function o(e,t){return[(new Date).toISOString()+" Chat "+e+":"].concat((0,s.default)(t))}Object.defineProperty(r,"__esModule",{value:!0}),r.Logger=void 0;var u=e("loglevel").getLogger("twilio-chat"),c=function(){function e(t){(0,n.default)(this,e),this.prefix="",this.prefix=null!=t&&t.length>0?t+" ":""}return(0,i.default)(e,[{key:"setLevel",value:function(e){u.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.trace.apply(null,o(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.debug.apply(null,o(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.info.apply(null,o(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.warn.apply(null,o(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.error.apply(null,o(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){u.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.trace.apply(null,o("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.debug.apply(null,o("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.info.apply(null,o("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.warn.apply(null,o("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];u.error.apply(null,o("E",t))}}]),e}();r.Logger=c},{"babel-runtime/core-js/array/from":26,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,loglevel:204}],15:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Media=void 0;var u=function(){function e(t,r){(0,s.default)(this,e),this.mcsMedia=null,this.services=r,this.state={sid:t.sid,filename:t.filename,contentType:t.contentType,size:t.size}}return(0,a.default)(e,[{key:"getContentTemporaryUrl",value:function(){var e=(0,i.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mcsMedia){e.next=8;break}if(!this.services.mcsClient){e.next=7;break}return e.next=4,this.services.mcsClient.get(this.state.sid);case 4:this.mcsMedia=e.sent,e.next=8;break;case 7:throw new Error("Media Content Service is unavailable");case 8:return e.abrupt("return",this.mcsMedia.getContentUrl());case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}}]),e}();r.Media=u},{"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],16:[function(e,t,r){"use strict";var n=v(e("babel-runtime/core-js/promise")),i=v(e("babel-runtime/core-js/json/stringify")),s=v(e("babel-runtime/regenerator")),a=v(e("babel-runtime/helpers/asyncToGenerator")),o=v(e("babel-runtime/core-js/number/is-integer")),u=v(e("babel-runtime/core-js/object/get-prototype-of")),c=v(e("babel-runtime/helpers/classCallCheck")),l=v(e("babel-runtime/helpers/createClass")),d=v(e("babel-runtime/helpers/possibleConstructorReturn")),f=v(e("babel-runtime/helpers/inherits")),p=v(e("babel-runtime/core-js/reflect/metadata")),h=v(e("babel-runtime/core-js/object/define-property")),b=v(e("babel-runtime/helpers/typeof")),m=v(e("babel-runtime/core-js/object/get-own-property-descriptor"));function v(e){return e&&e.__esModule?e:{default:e}}var y=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=(0,m.default)(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,b.default)(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&(0,h.default)(t,r,a),a},g=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":(0,b.default)(Reflect))&&"function"==typeof p.default)return(0,p.default)(e,t)};Object.defineProperty(r,"__esModule",{value:!0}),r.Member=void 0;var _=e("events"),k=e("./util"),w=e("./logger"),x=e("twilio-sdk-type-validator"),C=w.Logger.scope("Member"),j=function(e){function t(e,r,n,i,s){(0,c.default)(this,t);var a=(0,d.default)(this,(t.__proto__||(0,u.default)(t)).call(this));if(a.channel=n,a.links=i,a.services=s,a.services=s,a.state={attributes:k.parseAttributes(e.attributes,"Retrieved malformed attributes from the server for member: "+r,C),dateCreated:e.dateCreated?k.parseTime(e.dateCreated):null,dateUpdated:e.dateCreated?k.parseTime(e.dateUpdated):null,sid:r,typingTimeout:null,isTyping:!1,identity:e.identity||null,roleSid:e.roleSid||null,lastConsumedMessageIndex:(0,o.default)(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,lastConsumptionTimestamp:e.lastConsumptionTimestamp?k.parseTime(e.lastConsumptionTimestamp):null,type:e.type||"chat",userInfo:e.userInfo},!e.identity&&!e.type)throw new Error("Received invalid Member object from server: Missing identity or type of Member.");return a}return(0,f.default)(t,e),(0,l.default)(t,[{key:"_startTyping",value:function(e){var t=this;return clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit("typingStarted",this),this.channel.emit("typingStarted",this),this.state.typingTimeout=setTimeout(function(){return t._endTyping()},e),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit("typingEnded",this),this.channel.emit("typingEnded",this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(e){var t=[],r=k.parseAttributes(e.attributes,"Retrieved malformed attributes from the server for member: "+this.state.sid,C);e.attributes&&!k.isDeepEqual(this.state.attributes,r)&&(this.state.attributes=r,t.push("attributes"));var n=k.parseTime(e.dateUpdated);e.dateUpdated&&n.getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=n,t.push("dateUpdated"));var i=k.parseTime(e.dateCreated);if(e.dateCreated&&i.getTime()!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=i,t.push("dateCreated")),e.roleSid&&this.state.roleSid!==e.roleSid&&(this.state.roleSid=e.roleSid,t.push("roleSid")),!(0,o.default)(e.lastConsumedMessageIndex)&&null!==e.lastConsumedMessageIndex||this.state.lastConsumedMessageIndex===e.lastConsumedMessageIndex||(this.state.lastConsumedMessageIndex=e.lastConsumedMessageIndex,t.push("lastConsumedMessageIndex")),e.lastConsumptionTimestamp){var s=new Date(e.lastConsumptionTimestamp);this.state.lastConsumptionTimestamp&&this.state.lastConsumptionTimestamp.getTime()===s.getTime()||(this.state.lastConsumptionTimestamp=s,t.push("lastConsumptionTimestamp"))}return t.length>0&&this.emit("updated",{member:this,updateReasons:t}),this}},{key:"getUserDescriptor",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"==this.type){e.next=2;break}throw new Error("Getting User Descriptor is not supported for this Member type: "+this.type);case 2:return e.abrupt("return",this.services.users.getUserDescriptor(this.state.identity));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getUser",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"==this.type){e.next=2;break}throw new Error("Getting User is not supported for this Member type: "+this.type);case 2:return e.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.channel.removeMember(this));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"updateAttributes",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?(0,i.default)(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastConsumedMessageIndex",get:function(){return this.state.lastConsumedMessageIndex}},{key:"lastConsumptionTimestamp",get:function(){return this.state.lastConsumptionTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}}]),t}(_.EventEmitter);y([x.validateTypesAsync(["string","number","boolean","object",x.literal(null)]),g("design:type",Function),g("design:paramtypes",[Object]),g("design:returntype",n.default)],j.prototype,"updateAttributes",null),r.Member=j},{"./logger":14,"./util":25,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/number/is-integer":31,"babel-runtime/core-js/object/define-property":34,"babel-runtime/core-js/object/get-own-property-descriptor":36,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/reflect/metadata":42,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"twilio-sdk-type-validator":234}],17:[function(e,t,r){"use strict";var n=m(e("babel-runtime/core-js/promise")),i=m(e("babel-runtime/core-js/json/stringify")),s=m(e("babel-runtime/regenerator")),a=m(e("babel-runtime/helpers/asyncToGenerator")),o=m(e("babel-runtime/core-js/object/get-prototype-of")),u=m(e("babel-runtime/helpers/classCallCheck")),c=m(e("babel-runtime/helpers/createClass")),l=m(e("babel-runtime/helpers/possibleConstructorReturn")),d=m(e("babel-runtime/helpers/inherits")),f=m(e("babel-runtime/core-js/reflect/metadata")),p=m(e("babel-runtime/core-js/object/define-property")),h=m(e("babel-runtime/helpers/typeof")),b=m(e("babel-runtime/core-js/object/get-own-property-descriptor"));function m(e){return e&&e.__esModule?e:{default:e}}var v=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=(0,b.default)(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&(0,p.default)(t,r,a),a},y=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof f.default)return(0,f.default)(e,t)};Object.defineProperty(r,"__esModule",{value:!0}),r.Message=void 0;var g=e("events"),_=e("./util"),k=e("./logger"),w=e("./media"),x=e("twilio-sdk-type-validator"),C=k.Logger.scope("Message"),j=function(e){function t(e,r,n,i,s,a){(0,u.default)(this,t);var c=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return c.channel=n,c.links=i,c.configuration=s,c.services=a,c.state={sid:r.sid,index:e,author:null==r.author?null:r.author,body:r.text,timestamp:r.timestamp?new Date(r.timestamp):null,dateUpdated:r.dateUpdated?new Date(r.dateUpdated):null,lastUpdatedBy:r.lastUpdatedBy?r.lastUpdatedBy:null,attributes:_.parseAttributes(r.attributes,"Got malformed attributes for the message "+r.sid,C),type:r.type?r.type:"text",media:r.type&&"media"===r.type&&r.media?new w.Media(r.media,c.services):null,memberSid:null==r.memberSid?null:r.memberSid},c}return(0,d.default)(t,e),(0,c.default)(t,[{key:"_update",value:function(e){var t=[];!e.text&&"string"!=typeof e.text||e.text===this.state.body||(this.state.body=e.text,t.push("body")),e.lastUpdatedBy&&e.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=e.lastUpdatedBy,t.push("lastUpdatedBy")),e.author&&e.author!==this.state.author&&(this.state.author=e.author,t.push("author")),e.dateUpdated&&new Date(e.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(e.dateUpdated),t.push("dateUpdated")),e.timestamp&&new Date(e.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(e.timestamp),t.push("dateCreated"));var r=_.parseAttributes(e.attributes,"Got malformed attributes for the message "+this.sid,C);_.isDeepEqual(this.state.attributes,r)||(this.state.attributes=r,t.push("attributes")),t.length>0&&this.emit("updated",{message:this,updateReasons:t})}},{key:"getMember",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t,r,n=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,!this.state.memberSid){e.next=5;break}return e.next=4,this.channel.getMemberBySid(this.memberSid).catch(function(){return C.debug('Member with sid "'+n.memberSid+'" not found for message '+n.sid),null});case 4:t=e.sent;case 5:if(t||!this.state.author){e.next=9;break}return e.next=8,this.channel.getMemberByIdentity(this.state.author).catch(function(){return C.debug('Member with identity "'+n.author+'" not found for message '+n.sid),null});case 8:t=e.sent;case 9:if(!t){e.next=11;break}return e.abrupt("return",t);case 11:throw r="Member with ",this.state.memberSid&&(r+="SID '"+this.state.memberSid+"' "),this.state.author&&(this.state.memberSid&&(r+="or "),r+="identity '"+this.state.author+"' "),"Member with "===r&&(r="Member "),r+="was not found",new Error(r);case 17:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"updateBody",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{body:t});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateAttributes",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?(0,i.default)(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"body",get:function(){return"media"===this.type?null:this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"memberSid",get:function(){return this.state.memberSid}}]),t}(g.EventEmitter);v([x.validateTypesAsync("string"),y("design:type",Function),y("design:paramtypes",[String]),y("design:returntype",n.default)],j.prototype,"updateBody",null),v([x.validateTypesAsync(["string","number","boolean","object",x.literal(null)]),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",n.default)],j.prototype,"updateAttributes",null),r.Message=j},{"./logger":14,"./media":15,"./util":25,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/define-property":34,"babel-runtime/core-js/object/get-own-property-descriptor":36,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/reflect/metadata":42,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"twilio-sdk-type-validator":234}],18:[function(e,t,r){"use strict";var n,i=e("babel-runtime/helpers/classCallCheck"),s=(n=i)&&n.__esModule?n:{default:n};Object.defineProperty(r,"__esModule",{value:!0}),r.PushNotification=void 0;r.PushNotification=function e(t){(0,s.default)(this,e),this.title=t.title||null,this.body=t.body||null,this.sound=t.sound||null,this.badge=t.badge||null,this.action=t.action||null,this.type=t.type||null,this.data=t.data||{}}},{"babel-runtime/helpers/classCallCheck":47}],19:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/promise")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.RestPaginator=void 0;var o=function(){function e(t,r,n,s){(0,i.default)(this,e),this.state={prevToken:n,nextToken:s,source:r,items:t}}return(0,s.default)(e,[{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):n.default.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):n.default.reject(new Error("No previous page"))}},{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}}]),e}();r.RestPaginator=o},{"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],20:[function(e,t,r){"use strict";var n=d(e("babel-runtime/regenerator")),i=d(e("babel-runtime/helpers/asyncToGenerator")),s=d(e("babel-runtime/core-js/promise")),a=d(e("babel-runtime/core-js/get-iterator")),o=d(e("babel-runtime/helpers/slicedToArray")),u=d(e("babel-runtime/core-js/map")),c=d(e("babel-runtime/helpers/classCallCheck")),l=d(e("babel-runtime/helpers/createClass"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Network=void 0;var f=e("operation-retrier"),p=function(){function e(t,r){(0,c.default)(this,e),this.configuration=t,this.services=r,this.cache=new u.default,this.cacheLifetime=100*this.configuration.httpCacheInterval,this.cleanupCache()}return(0,l.default)(e,[{key:"isExpired",value:function(e){return!this.cacheLifetime||Date.now()-e>this.cacheLifetime}},{key:"cleanupCache",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=(0,a.default)(this.cache);!(e=(n=i.next()).done);e=!0){var s=n.value,u=(0,o.default)(s,2),c=u[0],l=u[1];this.isExpired(l.timestamp)&&this.cache.delete(c)}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var e=this;this.timer=this.timer||setInterval(function(){return e.cleanupCache()},2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new s.default(function(n,i){var s=[502,503,504];r&&s.push(429);var a=new f.Retrier(t.configuration.backoffConfiguration);a.on("attempt",function(){e().then(function(e){return a.succeeded(e)}).catch(function(e){s.indexOf(e.status)>-1?a.failed(e):"Twilsock disconnected"===e.message?a.failed(e):(a.removeAllListeners(),a.cancel(),i(e))})}),a.on("succeeded",function(e){n(e)}),a.on("cancelled",function(e){return i(e)}),a.on("failed",function(e){return i(e)}),a.start()})}},{key:"get",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i,s,a=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.cache.get(t))||this.isExpired(r.timestamp)){e.next=3;break}return e.abrupt("return",r.response);case 3:return i={},e.next=6,this.executeWithRetry(function(){return a.services.transport.get(t,i,a.configuration.productId)},this.configuration.retryWhenThrottled);case 6:return s=e.sent,this.cache.set(t,{response:s,timestamp:Date.now()}),this.pokeTimer(),e.abrupt("return",s);case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();r.Network=p},{"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/map":30,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/slicedToArray":52,"babel-runtime/regenerator":55,"operation-retrier":206}],21:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/promise")),i=o(e("babel-runtime/core-js/map")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.TypingIndicator=void 0;var u=e("../logger"),c=e("../interfaces/notificationtypes"),l=u.Logger.scope("TypingIndicator"),d=function(){function e(t,r,n){(0,s.default)(this,e),this.getChannel=t,this.configuration=r,this.services=n,this.serviceTypingTimeout=null,this.sentUpdates=new i.default}return(0,a.default)(e,[{key:"initialize",value:function(){var e=this;this.services.notificationClient.subscribe(c.NotificationTypes.TYPING_INDICATOR,"twilsock"),this.services.notificationClient.on("message",function(t,r){t===c.NotificationTypes.TYPING_INDICATOR&&e.handleRemoteTyping(r)})}},{key:"handleRemoteTyping",value:function(e){var t=this;l.trace("Got new typing indicator ",e),this.getChannel(e.channel_sid).then(function(r){r&&r.members.forEach(function(r){if(r.identity===e.identity){var n=t.configuration.typingIndicatorTimeoutOverride+1e3||1e3*e.typing_timeout;r._startTyping(n)}})}).catch(function(e){throw l.error(e),e})}},{key:"send",value:function(e){var t=this.sentUpdates.get(e);return t&&t>Date.now()-this.typingTimeout?n.default.resolve():(this.sentUpdates.set(e,Date.now()),this._send(e))}},{key:"_send",value:function(e){var t=this;l.trace("Sending typing indicator");var r=this.configuration.links.typing,n="ChannelSid="+e;return this.services.transport.post(r,{"Content-Type":"application/x-www-form-urlencoded"},n,this.configuration.productId).then(function(e){e.body.hasOwnProperty("typing_timeout")&&(t.serviceTypingTimeout=1e3*e.body.typing_timeout)}).catch(function(e){throw l.error("Failed to send typing indicator:",e),e})}},{key:"typingTimeout",get:function(){return this.configuration.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.configuration.typingIndicatorTimeoutDefault}}]),e}();r.TypingIndicator=d},{"../interfaces/notificationtypes":13,"../logger":14,"babel-runtime/core-js/map":30,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],22:[function(e,t,r){"use strict";var n=m(e("babel-runtime/core-js/json/stringify")),i=m(e("babel-runtime/regenerator")),s=m(e("babel-runtime/core-js/promise")),a=m(e("babel-runtime/helpers/asyncToGenerator")),o=m(e("babel-runtime/core-js/object/get-prototype-of")),u=m(e("babel-runtime/helpers/classCallCheck")),c=m(e("babel-runtime/helpers/createClass")),l=m(e("babel-runtime/helpers/possibleConstructorReturn")),d=m(e("babel-runtime/helpers/inherits")),f=m(e("babel-runtime/core-js/reflect/metadata")),p=m(e("babel-runtime/core-js/object/define-property")),h=m(e("babel-runtime/helpers/typeof")),b=m(e("babel-runtime/core-js/object/get-own-property-descriptor"));function m(e){return e&&e.__esModule?e:{default:e}}var v=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=(0,b.default)(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&(0,p.default)(t,r,a),a},y=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":(0,h.default)(Reflect))&&"function"==typeof f.default)return(0,f.default)(e,t)};Object.defineProperty(r,"__esModule",{value:!0}),r.User=void 0;var g=e("events"),_=e("./logger"),k=e("./util"),w=e("twilio-sdk-type-validator"),x=_.Logger.scope("User"),C=function(e){function t(e,r,n,i,s){(0,u.default)(this,t);var a=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return a.links=n,a.configuration=i,a.services=s,a.subscribed="initializing",a.setMaxListeners(0),a.state={identity:e,entityName:r,friendlyName:null,attributes:{},online:null,notifiable:null},a}return(0,d.default)(t,e),(0,c.default)(t,[{key:"_update",value:function(e,t){var r=[];switch(x.debug("User for",this.state.identity,"updated:",e,t),e){case"friendlyName":this.state.friendlyName!==t.value&&(r.push("friendlyName"),this.state.friendlyName=t.value);break;case"attributes":var n=k.parseAttributes(t.value,"Retrieved malformed attributes from the server for user: "+this.state.identity,x);k.isDeepEqual(this.state.attributes,n)||(this.state.attributes=n,r.push("attributes"));break;case"reachability":this.state.online!==t.online&&(this.state.online=t.online,r.push("online")),this.state.notifiable!==t.notifiable&&(this.state.notifiable=t.notifiable,r.push("notifiable"));break;default:return}r.length>0&&this.emit("updated",{user:this,updateReasons:r})}},{key:"_updateReachabilityInfo",value:function(){var e=(0,a.default)(i.default.mark(function e(t,r){var n=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.configuration.reachabilityEnabled){e.next=2;break}return e.abrupt("return",s.default.resolve());case 2:return e.abrupt("return",t.get("reachability").then(r).catch(function(e){x.warn("Failed to get reachability info for ",n.state.identity,e)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_fetch",value:function(){var e=(0,a.default)(i.default.mark(function e(){var t=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.entityName){e.next=2;break}return e.abrupt("return",this);case 2:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then(function(e){return t.entity=e,e.on("itemUpdated",function(e){return x.debug(t.state.entityName+" ("+t.state.identity+") itemUpdated: "+e.item.key),t._update(e.item.key,e.item.data)}),s.default.all([e.get("friendlyName").then(function(e){return t._update(e.key,e.data)}),e.get("attributes").then(function(e){return t._update(e.key,e.data)}),t._updateReachabilityInfo(e,function(e){return t._update(e.key,e.data)})])}).then(function(){return x.debug("Fetched for",t.identity),t.subscribed="subscribed",t.emit("userSubscribed",t),t}).catch(function(e){throw t.promiseToFetch=null,e}),e.abrupt("return",this.promiseToFetch);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_ensureFetched",value:function(){return this.promiseToFetch||this._fetch()}},{key:"updateAttributes",value:function(){var e=(0,a.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("unsubscribed"!=this.subscribed){e.next=2;break}throw new Error("Can't modify unsubscribed object");case 2:return e.next=4,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:(0,n.default)(t)});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateFriendlyName",value:function(){var e=(0,a.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("unsubscribed"!=this.subscribed){e.next=2;break}throw new Error("Can't modify unsubscribed object");case 2:return e.next=4,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"unsubscribe",value:function(){var e=(0,a.default)(i.default.mark(function e(){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.promiseToFetch){e.next=7;break}return e.next=3,this.promiseToFetch;case 3:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"identity",get:function(){return this.state.identity},set:function(e){this.state.identity=e}},{key:"entityName",set:function(e){this.state.entityName=e}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"online",get:function(){return this.state.online}},{key:"notifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}}]),t}(g.EventEmitter);v([w.validateTypesAsync(["string","number","boolean","object",w.literal(null)]),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",s.default)],C.prototype,"updateAttributes",null),v([w.validateTypesAsync("string"),y("design:type",Function),y("design:paramtypes",[Object]),y("design:returntype",s.default)],C.prototype,"updateFriendlyName",null),r.User=C},{"./logger":14,"./util":25,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/define-property":34,"babel-runtime/core-js/object/get-own-property-descriptor":36,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/reflect/metadata":42,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"twilio-sdk-type-validator":234}],23:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.UserDescriptor=void 0;var a=e("./logger"),o=e("./util"),u=a.Logger.scope("UserDescriptor"),c=function(){function e(t,r){(0,n.default)(this,e),this.services=t,this.descriptor=r,this.identity=r.identity,this.friendlyName=r.friendly_name,this.attributes=o.parseAttributes(r.attributes,"Failed to parse user attributes",u),this.online=r.is_online,this.notifiable=r.is_notifiable}return(0,i.default)(e,[{key:"subscribe",value:function(){return this.services.users.getUser(this.identity,this.descriptor.sync_unique_name)}},{key:"_getDescriptor",value:function(){return this.descriptor}}]),e}();r.UserDescriptor=c},{"./logger":14,"./util":25,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],24:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/promise")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Deferred=void 0;var o=function(){function e(){var t=this;(0,i.default)(this,e),this._promise=new n.default(function(e,r){t._resolve=e,t._reject=r})}return(0,s.default)(e,[{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}},{key:"promise",get:function(){return this._promise}}]),e}();r.Deferred=o},{"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],25:[function(e,t,r){"use strict";var n=a(e("babel-runtime/helpers/classCallCheck")),i=a(e("babel-runtime/helpers/createClass")),s=a(e("babel-runtime/core-js/json/stringify"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.parseAttributes=r.parseTime=r.parseToNumber=r.UriBuilder=r.deepClone=r.isDeepEqual=void 0;var o=e("rfc6902");r.isDeepEqual=function(e,t){return 0===o.createPatch(e,t).length},r.deepClone=function(e){return JSON.parse((0,s.default)(e))},r.parseToNumber=function(e){return void 0===e||isNaN(Number(e))?null:Number(e)},r.parseTime=function(e){try{return new Date(e)}catch(e){return null}},r.parseAttributes=function(e,t,r){var n={};if(e)try{n=JSON.parse(e)}catch(e){r.warn(t,e)}return n};var u=function(){function e(t){(0,n.default)(this,e),this.base=t.replace(/\/$/,""),this.args=[],this.paths=[]}return(0,i.default)(e,[{key:"arg",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"path",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}();r.UriBuilder=u},{"babel-runtime/core-js/json/stringify":29,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,rfc6902:213}],26:[function(e,t,r){t.exports={default:e("core-js/library/fn/array/from"),__esModule:!0}},{"core-js/library/fn/array/from":57}],27:[function(e,t,r){t.exports={default:e("core-js/library/fn/get-iterator"),__esModule:!0}},{"core-js/library/fn/get-iterator":58}],28:[function(e,t,r){t.exports={default:e("core-js/library/fn/is-iterable"),__esModule:!0}},{"core-js/library/fn/is-iterable":59}],29:[function(e,t,r){t.exports={default:e("core-js/library/fn/json/stringify"),__esModule:!0}},{"core-js/library/fn/json/stringify":60}],30:[function(e,t,r){t.exports={default:e("core-js/library/fn/map"),__esModule:!0}},{"core-js/library/fn/map":61}],31:[function(e,t,r){t.exports={default:e("core-js/library/fn/number/is-integer"),__esModule:!0}},{"core-js/library/fn/number/is-integer":62}],32:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/assign"),__esModule:!0}},{"core-js/library/fn/object/assign":63}],33:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/create"),__esModule:!0}},{"core-js/library/fn/object/create":64}],34:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/define-property"),__esModule:!0}},{"core-js/library/fn/object/define-property":65}],35:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/entries"),__esModule:!0}},{"core-js/library/fn/object/entries":66}],36:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/get-own-property-descriptor"),__esModule:!0}},{"core-js/library/fn/object/get-own-property-descriptor":67}],37:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/get-prototype-of"),__esModule:!0}},{"core-js/library/fn/object/get-prototype-of":68}],38:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/keys"),__esModule:!0}},{"core-js/library/fn/object/keys":69}],39:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/set-prototype-of"),__esModule:!0}},{"core-js/library/fn/object/set-prototype-of":70}],40:[function(e,t,r){t.exports={default:e("core-js/library/fn/promise"),__esModule:!0}},{"core-js/library/fn/promise":71}],41:[function(e,t,r){t.exports={default:e("core-js/library/fn/reflect/construct"),__esModule:!0}},{"core-js/library/fn/reflect/construct":72}],42:[function(e,t,r){t.exports={default:e("core-js/library/fn/reflect/metadata"),__esModule:!0}},{"core-js/library/fn/reflect/metadata":73}],43:[function(e,t,r){t.exports={default:e("core-js/library/fn/set"),__esModule:!0}},{"core-js/library/fn/set":74}],44:[function(e,t,r){t.exports={default:e("core-js/library/fn/symbol"),__esModule:!0}},{"core-js/library/fn/symbol":75}],45:[function(e,t,r){t.exports={default:e("core-js/library/fn/symbol/iterator"),__esModule:!0}},{"core-js/library/fn/symbol/iterator":76}],46:[function(e,t,r){"use strict";r.__esModule=!0;var n,i=e("../core-js/promise"),s=(n=i)&&n.__esModule?n:{default:n};r.default=function(e){return function(){var t=e.apply(this,arguments);return new s.default(function(e,r){return function n(i,a){try{var o=t[i](a),u=o.value}catch(e){return void r(e)}if(!o.done)return s.default.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}("next")})}}},{"../core-js/promise":40}],47:[function(e,t,r){"use strict";r.__esModule=!0,r.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],48:[function(e,t,r){"use strict";r.__esModule=!0;var n,i=e("../core-js/object/define-property"),s=(n=i)&&n.__esModule?n:{default:n};r.default=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),(0,s.default)(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}()},{"../core-js/object/define-property":34}],49:[function(e,t,r){"use strict";r.__esModule=!0;var n=s(e("../core-js/object/get-prototype-of")),i=s(e("../core-js/object/get-own-property-descriptor"));function s(e){return e&&e.__esModule?e:{default:e}}r.default=function e(t,r,s){null===t&&(t=Function.prototype);var a=(0,i.default)(t,r);if(void 0===a){var o=(0,n.default)(t);return null===o?void 0:e(o,r,s)}if("value"in a)return a.value;var u=a.get;return void 0!==u?u.call(s):void 0}},{"../core-js/object/get-own-property-descriptor":36,"../core-js/object/get-prototype-of":37}],50:[function(e,t,r){"use strict";r.__esModule=!0;var n=a(e("../core-js/object/set-prototype-of")),i=a(e("../core-js/object/create")),s=a(e("../helpers/typeof"));function a(e){return e&&e.__esModule?e:{default:e}}r.default=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,s.default)(t)));e.prototype=(0,i.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(n.default?(0,n.default)(e,t):e.__proto__=t)}},{"../core-js/object/create":33,"../core-js/object/set-prototype-of":39,"../helpers/typeof":54}],51:[function(e,t,r){"use strict";r.__esModule=!0;var n,i=e("../helpers/typeof"),s=(n=i)&&n.__esModule?n:{default:n};r.default=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,s.default)(t))&&"function"!=typeof t?e:t}},{"../helpers/typeof":54}],52:[function(e,t,r){"use strict";r.__esModule=!0;var n=s(e("../core-js/is-iterable")),i=s(e("../core-js/get-iterator"));function s(e){return e&&e.__esModule?e:{default:e}}r.default=function(){return function(e,t){if(Array.isArray(e))return e;if((0,n.default)(Object(e)))return function(e,t){var r=[],n=!0,s=!1,a=void 0;try{for(var o,u=(0,i.default)(e);!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){s=!0,a=e}finally{try{!n&&u.return&&u.return()}finally{if(s)throw a}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()},{"../core-js/get-iterator":27,"../core-js/is-iterable":28}],53:[function(e,t,r){"use strict";r.__esModule=!0;var n,i=e("../core-js/array/from"),s=(n=i)&&n.__esModule?n:{default:n};r.default=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return(0,s.default)(e)}},{"../core-js/array/from":26}],54:[function(e,t,r){"use strict";r.__esModule=!0;var n=a(e("../core-js/symbol/iterator")),i=a(e("../core-js/symbol")),s="function"==typeof i.default&&"symbol"==typeof n.default?function(e){return typeof e}:function(e){return e&&"function"==typeof i.default&&e.constructor===i.default&&e!==i.default.prototype?"symbol":typeof e};function a(e){return e&&e.__esModule?e:{default:e}}r.default="function"==typeof i.default&&"symbol"===s(n.default)?function(e){return void 0===e?"undefined":s(e)}:function(e){return e&&"function"==typeof i.default&&e.constructor===i.default&&e!==i.default.prototype?"symbol":void 0===e?"undefined":s(e)}},{"../core-js/symbol":44,"../core-js/symbol/iterator":45}],55:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":209}],56:[function(e,t,r){},{}],57:[function(e,t,r){e("../../modules/es6.string.iterator"),e("../../modules/es6.array.from"),t.exports=e("../../modules/_core").Array.from},{"../../modules/_core":93,"../../modules/es6.array.from":170,"../../modules/es6.string.iterator":185}],58:[function(e,t,r){e("../modules/web.dom.iterable"),e("../modules/es6.string.iterator"),t.exports=e("../modules/core.get-iterator")},{"../modules/core.get-iterator":168,"../modules/es6.string.iterator":185,"../modules/web.dom.iterable":200}],59:[function(e,t,r){e("../modules/web.dom.iterable"),e("../modules/es6.string.iterator"),t.exports=e("../modules/core.is-iterable")},{"../modules/core.is-iterable":169,"../modules/es6.string.iterator":185,"../modules/web.dom.iterable":200}],60:[function(e,t,r){var n=e("../../modules/_core"),i=n.JSON||(n.JSON={stringify:JSON.stringify});t.exports=function(e){return i.stringify.apply(i,arguments)}},{"../../modules/_core":93}],61:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.map"),e("../modules/es7.map.to-json"),e("../modules/es7.map.of"),e("../modules/es7.map.from"),t.exports=e("../modules/_core").Map},{"../modules/_core":93,"../modules/es6.map":172,"../modules/es6.object.to-string":181,"../modules/es6.string.iterator":185,"../modules/es7.map.from":188,"../modules/es7.map.of":189,"../modules/es7.map.to-json":190,"../modules/web.dom.iterable":200}],62:[function(e,t,r){e("../../modules/es6.number.is-integer"),t.exports=e("../../modules/_core").Number.isInteger},{"../../modules/_core":93,"../../modules/es6.number.is-integer":173}],63:[function(e,t,r){e("../../modules/es6.object.assign"),t.exports=e("../../modules/_core").Object.assign},{"../../modules/_core":93,"../../modules/es6.object.assign":174}],64:[function(e,t,r){e("../../modules/es6.object.create");var n=e("../../modules/_core").Object;t.exports=function(e,t){return n.create(e,t)}},{"../../modules/_core":93,"../../modules/es6.object.create":175}],65:[function(e,t,r){e("../../modules/es6.object.define-property");var n=e("../../modules/_core").Object;t.exports=function(e,t,r){return n.defineProperty(e,t,r)}},{"../../modules/_core":93,"../../modules/es6.object.define-property":176}],66:[function(e,t,r){e("../../modules/es7.object.entries"),t.exports=e("../../modules/_core").Object.entries},{"../../modules/_core":93,"../../modules/es7.object.entries":191}],67:[function(e,t,r){e("../../modules/es6.object.get-own-property-descriptor");var n=e("../../modules/_core").Object;t.exports=function(e,t){return n.getOwnPropertyDescriptor(e,t)}},{"../../modules/_core":93,"../../modules/es6.object.get-own-property-descriptor":177}],68:[function(e,t,r){e("../../modules/es6.object.get-prototype-of"),t.exports=e("../../modules/_core").Object.getPrototypeOf},{"../../modules/_core":93,"../../modules/es6.object.get-prototype-of":178}],69:[function(e,t,r){e("../../modules/es6.object.keys"),t.exports=e("../../modules/_core").Object.keys},{"../../modules/_core":93,"../../modules/es6.object.keys":179}],70:[function(e,t,r){e("../../modules/es6.object.set-prototype-of"),t.exports=e("../../modules/_core").Object.setPrototypeOf},{"../../modules/_core":93,"../../modules/es6.object.set-prototype-of":180}],71:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.promise"),e("../modules/es7.promise.finally"),e("../modules/es7.promise.try"),t.exports=e("../modules/_core").Promise},{"../modules/_core":93,"../modules/es6.object.to-string":181,"../modules/es6.promise":182,"../modules/es6.string.iterator":185,"../modules/es7.promise.finally":192,"../modules/es7.promise.try":193,"../modules/web.dom.iterable":200}],72:[function(e,t,r){e("../../modules/es6.reflect.construct"),t.exports=e("../../modules/_core").Reflect.construct},{"../../modules/_core":93,"../../modules/es6.reflect.construct":183}],73:[function(e,t,r){e("../../modules/es7.reflect.metadata"),t.exports=e("../../modules/_core").Reflect.metadata},{"../../modules/_core":93,"../../modules/es7.reflect.metadata":194}],74:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.set"),e("../modules/es7.set.to-json"),e("../modules/es7.set.of"),e("../modules/es7.set.from"),t.exports=e("../modules/_core").Set},{"../modules/_core":93,"../modules/es6.object.to-string":181,"../modules/es6.set":184,"../modules/es6.string.iterator":185,"../modules/es7.set.from":195,"../modules/es7.set.of":196,"../modules/es7.set.to-json":197,"../modules/web.dom.iterable":200}],75:[function(e,t,r){e("../../modules/es6.symbol"),e("../../modules/es6.object.to-string"),e("../../modules/es7.symbol.async-iterator"),e("../../modules/es7.symbol.observable"),t.exports=e("../../modules/_core").Symbol},{"../../modules/_core":93,"../../modules/es6.object.to-string":181,"../../modules/es6.symbol":186,"../../modules/es7.symbol.async-iterator":198,"../../modules/es7.symbol.observable":199}],76:[function(e,t,r){e("../../modules/es6.string.iterator"),e("../../modules/web.dom.iterable"),t.exports=e("../../modules/_wks-ext").f("iterator")},{"../../modules/_wks-ext":165,"../../modules/es6.string.iterator":185,"../../modules/web.dom.iterable":200}],77:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],78:[function(e,t,r){t.exports=function(){}},{}],79:[function(e,t,r){t.exports=function(e,t,r,n){if(!(e instanceof t)||void 0!==n&&n in e)throw TypeError(r+": incorrect invocation!");return e}},{}],80:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":114}],81:[function(e,t,r){var n=e("./_for-of");t.exports=function(e,t){var r=[];return n(e,!1,r.push,r,t),r}},{"./_for-of":103}],82:[function(e,t,r){var n=e("./_to-iobject"),i=e("./_to-length"),s=e("./_to-absolute-index");t.exports=function(e){return function(t,r,a){var o,u=n(t),c=i(u.length),l=s(a,c);if(e&&r!=r){for(;c>l;)if((o=u[l++])!=o)return!0}else for(;c>l;l++)if((e||l in u)&&u[l]===r)return e||l||0;return!e&&-1}}},{"./_to-absolute-index":155,"./_to-iobject":157,"./_to-length":158}],83:[function(e,t,r){var n=e("./_ctx"),i=e("./_iobject"),s=e("./_to-object"),a=e("./_to-length"),o=e("./_array-species-create");t.exports=function(e,t){var r=1==e,u=2==e,c=3==e,l=4==e,d=6==e,f=5==e||d,p=t||o;return function(t,o,h){for(var b,m,v=s(t),y=i(v),g=n(o,h,3),_=a(y.length),k=0,w=r?p(t,_):u?p(t,0):void 0;_>k;k++)if((f||k in y)&&(m=g(b=y[k],k,v),e))if(r)w[k]=m;else if(m)switch(e){case 3:return!0;case 5:return b;case 6:return k;case 2:w.push(b)}else if(l)return!1;return d?-1:c||l?l:w}}},{"./_array-species-create":85,"./_ctx":95,"./_iobject":110,"./_to-length":158,"./_to-object":159}],84:[function(e,t,r){var n=e("./_is-object"),i=e("./_is-array"),s=e("./_wks")("species");t.exports=function(e){var t;return i(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!i(t.prototype)||(t=void 0),n(t)&&null===(t=t[s])&&(t=void 0)),void 0===t?Array:t}},{"./_is-array":112,"./_is-object":114,"./_wks":166}],85:[function(e,t,r){var n=e("./_array-species-constructor");t.exports=function(e,t){return new(n(e))(t)}},{"./_array-species-constructor":84}],86:[function(e,t,r){"use strict";var n=e("./_a-function"),i=e("./_is-object"),s=e("./_invoke"),a=[].slice,o={};t.exports=Function.bind||function(e){var t=n(this),r=a.call(arguments,1),u=function(){var n=r.concat(a.call(arguments));return this instanceof u?function(e,t,r){if(!(t in o)){for(var n=[],i=0;i<t;i++)n[i]="a["+i+"]";o[t]=Function("F,a","return new F("+n.join(",")+")")}return o[t](e,r)}(t,n.length,n):s(t,n,e)};return i(t.prototype)&&(u.prototype=t.prototype),u}},{"./_a-function":77,"./_invoke":109,"./_is-object":114}],87:[function(e,t,r){var n=e("./_cof"),i=e("./_wks")("toStringTag"),s="Arguments"==n(function(){return arguments}());t.exports=function(e){var t,r,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),i))?r:s?n(t):"Object"==(a=n(t))&&"function"==typeof t.callee?"Arguments":a}},{"./_cof":88,"./_wks":166}],88:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],89:[function(e,t,r){"use strict";var n=e("./_object-dp").f,i=e("./_object-create"),s=e("./_redefine-all"),a=e("./_ctx"),o=e("./_an-instance"),u=e("./_for-of"),c=e("./_iter-define"),l=e("./_iter-step"),d=e("./_set-species"),f=e("./_descriptors"),p=e("./_meta").fastKey,h=e("./_validate-collection"),b=f?"_s":"size",m=function(e,t){var r,n=p(t);if("F"!==n)return e._i[n];for(r=e._f;r;r=r.n)if(r.k==t)return r};t.exports={getConstructor:function(e,t,r,c){var l=e(function(e,n){o(e,l,t,"_i"),e._t=t,e._i=i(null),e._f=void 0,e._l=void 0,e[b]=0,null!=n&&u(n,r,e[c],e)});return s(l.prototype,{clear:function(){for(var e=h(this,t),r=e._i,n=e._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete r[n.i];e._f=e._l=void 0,e[b]=0},delete:function(e){var r=h(this,t),n=m(r,e);if(n){var i=n.n,s=n.p;delete r._i[n.i],n.r=!0,s&&(s.n=i),i&&(i.p=s),r._f==n&&(r._f=i),r._l==n&&(r._l=s),r[b]--}return!!n},forEach:function(e){h(this,t);for(var r,n=a(e,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(n(r.v,r.k,this);r&&r.r;)r=r.p},has:function(e){return!!m(h(this,t),e)}}),f&&n(l.prototype,"size",{get:function(){return h(this,t)[b]}}),l},def:function(e,t,r){var n,i,s=m(e,t);return s?s.v=r:(e._l=s={i:i=p(t,!0),k:t,v:r,p:n=e._l,n:void 0,r:!1},e._f||(e._f=s),n&&(n.n=s),e[b]++,"F"!==i&&(e._i[i]=s)),e},getEntry:m,setStrong:function(e,t,r){c(e,t,function(e,r){this._t=h(e,t),this._k=r,this._l=void 0},function(){for(var e=this._k,t=this._l;t&&t.r;)t=t.p;return this._t&&(this._l=t=t?t.n:this._t._f)?l(0,"keys"==e?t.k:"values"==e?t.v:[t.k,t.v]):(this._t=void 0,l(1))},r?"entries":"values",!r,!0),d(t)}}},{"./_an-instance":79,"./_ctx":95,"./_descriptors":97,"./_for-of":103,"./_iter-define":117,"./_iter-step":119,"./_meta":122,"./_object-create":127,"./_object-dp":128,"./_redefine-all":143,"./_set-species":148,"./_validate-collection":163}],90:[function(e,t,r){var n=e("./_classof"),i=e("./_array-from-iterable");t.exports=function(e){return function(){if(n(this)!=e)throw TypeError(e+"#toJSON isn't generic");return i(this)}}},{"./_array-from-iterable":81,"./_classof":87}],91:[function(e,t,r){"use strict";var n=e("./_redefine-all"),i=e("./_meta").getWeak,s=e("./_an-object"),a=e("./_is-object"),o=e("./_an-instance"),u=e("./_for-of"),c=e("./_array-methods"),l=e("./_has"),d=e("./_validate-collection"),f=c(5),p=c(6),h=0,b=function(e){return e._l||(e._l=new m)},m=function(){this.a=[]},v=function(e,t){return f(e.a,function(e){return e[0]===t})};m.prototype={get:function(e){var t=v(this,e);if(t)return t[1]},has:function(e){return!!v(this,e)},set:function(e,t){var r=v(this,e);r?r[1]=t:this.a.push([e,t])},delete:function(e){var t=p(this.a,function(t){return t[0]===e});return~t&&this.a.splice(t,1),!!~t}},t.exports={getConstructor:function(e,t,r,s){var c=e(function(e,n){o(e,c,t,"_i"),e._t=t,e._i=h++,e._l=void 0,null!=n&&u(n,r,e[s],e)});return n(c.prototype,{delete:function(e){if(!a(e))return!1;var r=i(e);return!0===r?b(d(this,t)).delete(e):r&&l(r,this._i)&&delete r[this._i]},has:function(e){if(!a(e))return!1;var r=i(e);return!0===r?b(d(this,t)).has(e):r&&l(r,this._i)}}),c},def:function(e,t,r){var n=i(s(t),!0);return!0===n?b(e).set(t,r):n[e._i]=r,e},ufstore:b}},{"./_an-instance":79,"./_an-object":80,"./_array-methods":83,"./_for-of":103,"./_has":105,"./_is-object":114,"./_meta":122,"./_redefine-all":143,"./_validate-collection":163}],92:[function(e,t,r){"use strict";var n=e("./_global"),i=e("./_export"),s=e("./_meta"),a=e("./_fails"),o=e("./_hide"),u=e("./_redefine-all"),c=e("./_for-of"),l=e("./_an-instance"),d=e("./_is-object"),f=e("./_set-to-string-tag"),p=e("./_object-dp").f,h=e("./_array-methods")(0),b=e("./_descriptors");t.exports=function(e,t,r,m,v,y){var g=n[e],_=g,k=v?"set":"add",w=_&&_.prototype,x={};return b&&"function"==typeof _&&(y||w.forEach&&!a(function(){(new _).entries().next()}))?(_=t(function(t,r){l(t,_,e,"_c"),t._c=new g,null!=r&&c(r,v,t[k],t)}),h("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),function(e){var t="add"==e||"set"==e;e in w&&(!y||"clear"!=e)&&o(_.prototype,e,function(r,n){if(l(this,_,e),!t&&y&&!d(r))return"get"==e&&void 0;var i=this._c[e](0===r?0:r,n);return t?this:i})}),y||p(_.prototype,"size",{get:function(){return this._c.size}})):(_=m.getConstructor(t,e,v,k),u(_.prototype,r),s.NEED=!0),f(_,e),x[e]=_,i(i.G+i.W+i.F,x),y||m.setStrong(_,e,v),_}},{"./_an-instance":79,"./_array-methods":83,"./_descriptors":97,"./_export":101,"./_fails":102,"./_for-of":103,"./_global":104,"./_hide":106,"./_is-object":114,"./_meta":122,"./_object-dp":128,"./_redefine-all":143,"./_set-to-string-tag":149}],93:[function(e,t,r){var n=t.exports={version:"2.6.12"};"number"==typeof __e&&(__e=n)},{}],94:[function(e,t,r){"use strict";var n=e("./_object-dp"),i=e("./_property-desc");t.exports=function(e,t,r){t in e?n.f(e,t,i(0,r)):e[t]=r}},{"./_object-dp":128,"./_property-desc":142}],95:[function(e,t,r){var n=e("./_a-function");t.exports=function(e,t,r){if(n(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}}},{"./_a-function":77}],96:[function(e,t,r){t.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},{}],97:[function(e,t,r){t.exports=!e("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":102}],98:[function(e,t,r){var n=e("./_is-object"),i=e("./_global").document,s=n(i)&&n(i.createElement);t.exports=function(e){return s?i.createElement(e):{}}},{"./_global":104,"./_is-object":114}],99:[function(e,t,r){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},{}],100:[function(e,t,r){var n=e("./_object-keys"),i=e("./_object-gops"),s=e("./_object-pie");t.exports=function(e){var t=n(e),r=i.f;if(r)for(var a,o=r(e),u=s.f,c=0;o.length>c;)u.call(e,a=o[c++])&&t.push(a);return t}},{"./_object-gops":133,"./_object-keys":136,"./_object-pie":137}],101:[function(e,t,r){var n=e("./_global"),i=e("./_core"),s=e("./_ctx"),a=e("./_hide"),o=e("./_has"),u=function(e,t,r){var c,l,d,f=e&u.F,p=e&u.G,h=e&u.S,b=e&u.P,m=e&u.B,v=e&u.W,y=p?i:i[t]||(i[t]={}),g=y.prototype,_=p?n:h?n[t]:(n[t]||{}).prototype;for(c in p&&(r=t),r)(l=!f&&_&&void 0!==_[c])&&o(y,c)||(d=l?_[c]:r[c],y[c]=p&&"function"!=typeof _[c]?r[c]:m&&l?s(d,n):v&&_[c]==d?function(e){var t=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(d):b&&"function"==typeof d?s(Function.call,d):d,b&&((y.virtual||(y.virtual={}))[c]=d,e&u.R&&g&&!g[c]&&a(g,c,d)))};u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,t.exports=u},{"./_core":93,"./_ctx":95,"./_global":104,"./_has":105,"./_hide":106}],102:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(e){return!0}}},{}],103:[function(e,t,r){var n=e("./_ctx"),i=e("./_iter-call"),s=e("./_is-array-iter"),a=e("./_an-object"),o=e("./_to-length"),u=e("./core.get-iterator-method"),c={},l={};(r=t.exports=function(e,t,r,d,f){var p,h,b,m,v=f?function(){return e}:u(e),y=n(r,d,t?2:1),g=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(s(v)){for(p=o(e.length);p>g;g++)if((m=t?y(a(h=e[g])[0],h[1]):y(e[g]))===c||m===l)return m}else for(b=v.call(e);!(h=b.next()).done;)if((m=i(b,y,h.value,t))===c||m===l)return m}).BREAK=c,r.RETURN=l},{"./_an-object":80,"./_ctx":95,"./_is-array-iter":111,"./_iter-call":115,"./_to-length":158,"./core.get-iterator-method":167}],104:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],105:[function(e,t,r){var n={}.hasOwnProperty;t.exports=function(e,t){return n.call(e,t)}},{}],106:[function(e,t,r){var n=e("./_object-dp"),i=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,i(1,r))}:function(e,t,r){return e[t]=r,e}},{"./_descriptors":97,"./_object-dp":128,"./_property-desc":142}],107:[function(e,t,r){var n=e("./_global").document;t.exports=n&&n.documentElement},{"./_global":104}],108:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")(function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":97,"./_dom-create":98,"./_fails":102}],109:[function(e,t,r){t.exports=function(e,t,r){var n=void 0===r;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],110:[function(e,t,r){var n=e("./_cof");t.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==n(e)?e.split(""):Object(e)}},{"./_cof":88}],111:[function(e,t,r){var n=e("./_iterators"),i=e("./_wks")("iterator"),s=Array.prototype;t.exports=function(e){return void 0!==e&&(n.Array===e||s[i]===e)}},{"./_iterators":120,"./_wks":166}],112:[function(e,t,r){var n=e("./_cof");t.exports=Array.isArray||function(e){return"Array"==n(e)}},{"./_cof":88}],113:[function(e,t,r){var n=e("./_is-object"),i=Math.floor;t.exports=function(e){return!n(e)&&isFinite(e)&&i(e)===e}},{"./_is-object":114}],114:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],115:[function(e,t,r){var n=e("./_an-object");t.exports=function(e,t,r,i){try{return i?t(n(r)[0],r[1]):t(r)}catch(t){var s=e.return;throw void 0!==s&&n(s.call(e)),t}}},{"./_an-object":80}],116:[function(e,t,r){"use strict";var n=e("./_object-create"),i=e("./_property-desc"),s=e("./_set-to-string-tag"),a={};e("./_hide")(a,e("./_wks")("iterator"),function(){return this}),t.exports=function(e,t,r){e.prototype=n(a,{next:i(1,r)}),s(e,t+" Iterator")}},{"./_hide":106,"./_object-create":127,"./_property-desc":142,"./_set-to-string-tag":149,"./_wks":166}],117:[function(e,t,r){"use strict";var n=e("./_library"),i=e("./_export"),s=e("./_redefine"),a=e("./_hide"),o=e("./_iterators"),u=e("./_iter-create"),c=e("./_set-to-string-tag"),l=e("./_object-gpo"),d=e("./_wks")("iterator"),f=!([].keys&&"next"in[].keys()),p=function(){return this};t.exports=function(e,t,r,h,b,m,v){u(r,t,h);var y,g,_,k=function(e){if(!f&&e in j)return j[e];switch(e){case"keys":case"values":return function(){return new r(this,e)}}return function(){return new r(this,e)}},w=t+" Iterator",x="values"==b,C=!1,j=e.prototype,S=j[d]||j["@@iterator"]||b&&j[b],T=S||k(b),E=b?x?k("entries"):T:void 0,M="Array"==t&&j.entries||S;if(M&&(_=l(M.call(new e)))!==Object.prototype&&_.next&&(c(_,w,!0),n||"function"==typeof _[d]||a(_,d,p)),x&&S&&"values"!==S.name&&(C=!0,T=function(){return S.call(this)}),n&&!v||!f&&!C&&j[d]||a(j,d,T),o[t]=T,o[w]=p,b)if(y={values:x?T:k("values"),keys:m?T:k("keys"),entries:E},v)for(g in y)g in j||s(j,g,y[g]);else i(i.P+i.F*(f||C),t,y);return y}},{"./_export":101,"./_hide":106,"./_iter-create":116,"./_iterators":120,"./_library":121,"./_object-gpo":134,"./_redefine":144,"./_set-to-string-tag":149,"./_wks":166}],118:[function(e,t,r){var n=e("./_wks")("iterator"),i=!1;try{var s=[7][n]();s.return=function(){i=!0},Array.from(s,function(){throw 2})}catch(e){}t.exports=function(e,t){if(!t&&!i)return!1;var r=!1;try{var s=[7],a=s[n]();a.next=function(){return{done:r=!0}},s[n]=function(){return a},e(s)}catch(e){}return r}},{"./_wks":166}],119:[function(e,t,r){t.exports=function(e,t){return{value:t,done:!!e}}},{}],120:[function(e,t,r){t.exports={}},{}],121:[function(e,t,r){t.exports=!0},{}],122:[function(e,t,r){var n=e("./_uid")("meta"),i=e("./_is-object"),s=e("./_has"),a=e("./_object-dp").f,o=0,u=Object.isExtensible||function(){return!0},c=!e("./_fails")(function(){return u(Object.preventExtensions({}))}),l=function(e){a(e,n,{value:{i:"O"+ ++o,w:{}}})},d=t.exports={KEY:n,NEED:!1,fastKey:function(e,t){if(!i(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!s(e,n)){if(!u(e))return"F";if(!t)return"E";l(e)}return e[n].i},getWeak:function(e,t){if(!s(e,n)){if(!u(e))return!0;if(!t)return!1;l(e)}return e[n].w},onFreeze:function(e){return c&&d.NEED&&u(e)&&!s(e,n)&&l(e),e}}},{"./_fails":102,"./_has":105,"./_is-object":114,"./_object-dp":128,"./_uid":161}],123:[function(e,t,r){var n=e("./es6.map"),i=e("./_export"),s=e("./_shared")("metadata"),a=s.store||(s.store=new(e("./es6.weak-map"))),o=function(e,t,r){var i=a.get(e);if(!i){if(!r)return;a.set(e,i=new n)}var s=i.get(t);if(!s){if(!r)return;i.set(t,s=new n)}return s};t.exports={store:a,map:o,has:function(e,t,r){var n=o(t,r,!1);return void 0!==n&&n.has(e)},get:function(e,t,r){var n=o(t,r,!1);return void 0===n?void 0:n.get(e)},set:function(e,t,r,n){o(r,n,!0).set(e,t)},keys:function(e,t){var r=o(e,t,!1),n=[];return r&&r.forEach(function(e,t){n.push(t)}),n},key:function(e){return void 0===e||"symbol"==typeof e?e:String(e)},exp:function(e){i(i.S,"Reflect",e)}}},{"./_export":101,"./_shared":151,"./es6.map":172,"./es6.weak-map":187}],124:[function(e,t,r){var n=e("./_global"),i=e("./_task").set,s=n.MutationObserver||n.WebKitMutationObserver,a=n.process,o=n.Promise,u="process"==e("./_cof")(a);t.exports=function(){var e,t,r,c=function(){var n,i;for(u&&(n=a.domain)&&n.exit();e;){i=e.fn,e=e.next;try{i()}catch(n){throw e?r():t=void 0,n}}t=void 0,n&&n.enter()};if(u)r=function(){a.nextTick(c)};else if(!s||n.navigator&&n.navigator.standalone)if(o&&o.resolve){var l=o.resolve(void 0);r=function(){l.then(c)}}else r=function(){i.call(n,c)};else{var d=!0,f=document.createTextNode("");new s(c).observe(f,{characterData:!0}),r=function(){f.data=d=!d}}return function(n){var i={fn:n,next:void 0};t&&(t.next=i),e||(e=i,r()),t=i}}},{"./_cof":88,"./_global":104,"./_task":154}],125:[function(e,t,r){"use strict";
// 25.4.1.5 NewPromiseCapability(C)
var n=e("./_a-function");function i(e){var t,r;this.promise=new e(function(e,n){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=n}),this.resolve=n(t),this.reject=n(r)}t.exports.f=function(e){return new i(e)}},{"./_a-function":77}],126:[function(e,t,r){"use strict";var n=e("./_descriptors"),i=e("./_object-keys"),s=e("./_object-gops"),a=e("./_object-pie"),o=e("./_to-object"),u=e("./_iobject"),c=Object.assign;t.exports=!c||e("./_fails")(function(){var e={},t={},r=Symbol(),n="abcdefghijklmnopqrst";return e[r]=7,n.split("").forEach(function(e){t[e]=e}),7!=c({},e)[r]||Object.keys(c({},t)).join("")!=n})?function(e,t){for(var r=o(e),c=arguments.length,l=1,d=s.f,f=a.f;c>l;)for(var p,h=u(arguments[l++]),b=d?i(h).concat(d(h)):i(h),m=b.length,v=0;m>v;)p=b[v++],n&&!f.call(h,p)||(r[p]=h[p]);return r}:c},{"./_descriptors":97,"./_fails":102,"./_iobject":110,"./_object-gops":133,"./_object-keys":136,"./_object-pie":137,"./_to-object":159}],127:[function(e,t,r){var n=e("./_an-object"),i=e("./_object-dps"),s=e("./_enum-bug-keys"),a=e("./_shared-key")("IE_PROTO"),o=function(){},u=function(){var t,r=e("./_dom-create")("iframe"),n=s.length;for(r.style.display="none",e("./_html").appendChild(r),r.src="javascript:",(t=r.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),u=t.F;n--;)delete u.prototype[s[n]];return u()};t.exports=Object.create||function(e,t){var r;return null!==e?(o.prototype=n(e),r=new o,o.prototype=null,r[a]=e):r=u(),void 0===t?r:i(r,t)}},{"./_an-object":80,"./_dom-create":98,"./_enum-bug-keys":99,"./_html":107,"./_object-dps":129,"./_shared-key":150}],128:[function(e,t,r){var n=e("./_an-object"),i=e("./_ie8-dom-define"),s=e("./_to-primitive"),a=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function(e,t,r){if(n(e),t=s(t,!0),n(r),i)try{return a(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},{"./_an-object":80,"./_descriptors":97,"./_ie8-dom-define":108,"./_to-primitive":160}],129:[function(e,t,r){var n=e("./_object-dp"),i=e("./_an-object"),s=e("./_object-keys");t.exports=e("./_descriptors")?Object.defineProperties:function(e,t){i(e);for(var r,a=s(t),o=a.length,u=0;o>u;)n.f(e,r=a[u++],t[r]);return e}},{"./_an-object":80,"./_descriptors":97,"./_object-dp":128,"./_object-keys":136}],130:[function(e,t,r){var n=e("./_object-pie"),i=e("./_property-desc"),s=e("./_to-iobject"),a=e("./_to-primitive"),o=e("./_has"),u=e("./_ie8-dom-define"),c=Object.getOwnPropertyDescriptor;r.f=e("./_descriptors")?c:function(e,t){if(e=s(e),t=a(t,!0),u)try{return c(e,t)}catch(e){}if(o(e,t))return i(!n.f.call(e,t),e[t])}},{"./_descriptors":97,"./_has":105,"./_ie8-dom-define":108,"./_object-pie":137,"./_property-desc":142,"./_to-iobject":157,"./_to-primitive":160}],131:[function(e,t,r){var n=e("./_to-iobject"),i=e("./_object-gopn").f,s={}.toString,a="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(e){return a&&"[object Window]"==s.call(e)?function(e){try{return i(e)}catch(e){return a.slice()}}(e):i(n(e))}},{"./_object-gopn":132,"./_to-iobject":157}],132:[function(e,t,r){var n=e("./_object-keys-internal"),i=e("./_enum-bug-keys").concat("length","prototype");r.f=Object.getOwnPropertyNames||function(e){return n(e,i)}},{"./_enum-bug-keys":99,"./_object-keys-internal":135}],133:[function(e,t,r){r.f=Object.getOwnPropertySymbols},{}],134:[function(e,t,r){var n=e("./_has"),i=e("./_to-object"),s=e("./_shared-key")("IE_PROTO"),a=Object.prototype;t.exports=Object.getPrototypeOf||function(e){return e=i(e),n(e,s)?e[s]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?a:null}},{"./_has":105,"./_shared-key":150,"./_to-object":159}],135:[function(e,t,r){var n=e("./_has"),i=e("./_to-iobject"),s=e("./_array-includes")(!1),a=e("./_shared-key")("IE_PROTO");t.exports=function(e,t){var r,o=i(e),u=0,c=[];for(r in o)r!=a&&n(o,r)&&c.push(r);for(;t.length>u;)n(o,r=t[u++])&&(~s(c,r)||c.push(r));return c}},{"./_array-includes":82,"./_has":105,"./_shared-key":150,"./_to-iobject":157}],136:[function(e,t,r){var n=e("./_object-keys-internal"),i=e("./_enum-bug-keys");t.exports=Object.keys||function(e){return n(e,i)}},{"./_enum-bug-keys":99,"./_object-keys-internal":135}],137:[function(e,t,r){r.f={}.propertyIsEnumerable},{}],138:[function(e,t,r){var n=e("./_export"),i=e("./_core"),s=e("./_fails");t.exports=function(e,t){var r=(i.Object||{})[e]||Object[e],a={};a[e]=t(r),n(n.S+n.F*s(function(){r(1)}),"Object",a)}},{"./_core":93,"./_export":101,"./_fails":102}],139:[function(e,t,r){var n=e("./_descriptors"),i=e("./_object-keys"),s=e("./_to-iobject"),a=e("./_object-pie").f;t.exports=function(e){return function(t){for(var r,o=s(t),u=i(o),c=u.length,l=0,d=[];c>l;)r=u[l++],n&&!a.call(o,r)||d.push(e?[r,o[r]]:o[r]);return d}}},{"./_descriptors":97,"./_object-keys":136,"./_object-pie":137,"./_to-iobject":157}],140:[function(e,t,r){t.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},{}],141:[function(e,t,r){var n=e("./_an-object"),i=e("./_is-object"),s=e("./_new-promise-capability");t.exports=function(e,t){if(n(e),i(t)&&t.constructor===e)return t;var r=s.f(e);return(0,r.resolve)(t),r.promise}},{"./_an-object":80,"./_is-object":114,"./_new-promise-capability":125}],142:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],143:[function(e,t,r){var n=e("./_hide");t.exports=function(e,t,r){for(var i in t)r&&e[i]?e[i]=t[i]:n(e,i,t[i]);return e}},{"./_hide":106}],144:[function(e,t,r){t.exports=e("./_hide")},{"./_hide":106}],145:[function(e,t,r){"use strict";var n=e("./_export"),i=e("./_a-function"),s=e("./_ctx"),a=e("./_for-of");t.exports=function(e){n(n.S,e,{from:function(e){var t,r,n,o,u=arguments[1];return i(this),(t=void 0!==u)&&i(u),null==e?new this:(r=[],t?(n=0,o=s(u,arguments[2],2),a(e,!1,function(e){r.push(o(e,n++))})):a(e,!1,r.push,r),new this(r))}})}},{"./_a-function":77,"./_ctx":95,"./_export":101,"./_for-of":103}],146:[function(e,t,r){"use strict";var n=e("./_export");t.exports=function(e){n(n.S,e,{of:function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return new this(t)}})}},{"./_export":101}],147:[function(e,t,r){var n=e("./_is-object"),i=e("./_an-object"),s=function(e,t){if(i(e),!n(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,r,n){try{(n=e("./_ctx")(Function.call,e("./_object-gopd").f(Object.prototype,"__proto__").set,2))(t,[]),r=!(t instanceof Array)}catch(e){r=!0}return function(e,t){return s(e,t),r?e.__proto__=t:n(e,t),e}}({},!1):void 0),check:s}},{"./_an-object":80,"./_ctx":95,"./_is-object":114,"./_object-gopd":130}],148:[function(e,t,r){"use strict";var n=e("./_global"),i=e("./_core"),s=e("./_object-dp"),a=e("./_descriptors"),o=e("./_wks")("species");t.exports=function(e){var t="function"==typeof i[e]?i[e]:n[e];a&&t&&!t[o]&&s.f(t,o,{configurable:!0,get:function(){return this}})}},{"./_core":93,"./_descriptors":97,"./_global":104,"./_object-dp":128,"./_wks":166}],149:[function(e,t,r){var n=e("./_object-dp").f,i=e("./_has"),s=e("./_wks")("toStringTag");t.exports=function(e,t,r){e&&!i(e=r?e:e.prototype,s)&&n(e,s,{configurable:!0,value:t})}},{"./_has":105,"./_object-dp":128,"./_wks":166}],150:[function(e,t,r){var n=e("./_shared")("keys"),i=e("./_uid");t.exports=function(e){return n[e]||(n[e]=i(e))}},{"./_shared":151,"./_uid":161}],151:[function(e,t,r){var n=e("./_core"),i=e("./_global"),s=i["__core-js_shared__"]||(i["__core-js_shared__"]={});(t.exports=function(e,t){return s[e]||(s[e]=void 0!==t?t:{})})("versions",[]).push({version:n.version,mode:e("./_library")?"pure":"global",copyright:"\xa9 2020 Denis Pushkarev (zloirock.ru)"})},{"./_core":93,"./_global":104,"./_library":121}],152:[function(e,t,r){var n=e("./_an-object"),i=e("./_a-function"),s=e("./_wks")("species");t.exports=function(e,t){var r,a=n(e).constructor;return void 0===a||null==(r=n(a)[s])?t:i(r)}},{"./_a-function":77,"./_an-object":80,"./_wks":166}],153:[function(e,t,r){var n=e("./_to-integer"),i=e("./_defined");t.exports=function(e){return function(t,r){var s,a,o=String(i(t)),u=n(r),c=o.length;return u<0||u>=c?e?"":void 0:(s=o.charCodeAt(u))<55296||s>56319||u+1===c||(a=o.charCodeAt(u+1))<56320||a>57343?e?o.charAt(u):s:e?o.slice(u,u+2):a-56320+(s-55296<<10)+65536}}},{"./_defined":96,"./_to-integer":156}],154:[function(e,t,r){var n,i,s,a=e("./_ctx"),o=e("./_invoke"),u=e("./_html"),c=e("./_dom-create"),l=e("./_global"),d=l.process,f=l.setImmediate,p=l.clearImmediate,h=l.MessageChannel,b=l.Dispatch,m=0,v={},y=function(){var e=+this;if(v.hasOwnProperty(e)){var t=v[e];delete v[e],t()}},g=function(e){y.call(e.data)};f&&p||(f=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return v[++m]=function(){o("function"==typeof e?e:Function(e),t)},n(m),m},p=function(e){delete v[e]},"process"==e("./_cof")(d)?n=function(e){d.nextTick(a(y,e,1))}:b&&b.now?n=function(e){b.now(a(y,e,1))}:h?(s=(i=new h).port2,i.port1.onmessage=g,n=a(s.postMessage,s,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(n=function(e){l.postMessage(e+"","*")},l.addEventListener("message",g,!1)):n="onreadystatechange"in c("script")?function(e){u.appendChild(c("script")).onreadystatechange=function(){u.removeChild(this),y.call(e)}}:function(e){setTimeout(a(y,e,1),0)}),t.exports={set:f,clear:p}},{"./_cof":88,"./_ctx":95,"./_dom-create":98,"./_global":104,"./_html":107,"./_invoke":109}],155:[function(e,t,r){var n=e("./_to-integer"),i=Math.max,s=Math.min;t.exports=function(e,t){return(e=n(e))<0?i(e+t,0):s(e,t)}},{"./_to-integer":156}],156:[function(e,t,r){var n=Math.ceil,i=Math.floor;t.exports=function(e){return isNaN(e=+e)?0:(e>0?i:n)(e)}},{}],157:[function(e,t,r){var n=e("./_iobject"),i=e("./_defined");t.exports=function(e){return n(i(e))}},{"./_defined":96,"./_iobject":110}],158:[function(e,t,r){var n=e("./_to-integer"),i=Math.min;t.exports=function(e){return e>0?i(n(e),9007199254740991):0}},{"./_to-integer":156}],159:[function(e,t,r){var n=e("./_defined");t.exports=function(e){return Object(n(e))}},{"./_defined":96}],160:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e))return e;var r,i;if(t&&"function"==typeof(r=e.toString)&&!n(i=r.call(e)))return i;if("function"==typeof(r=e.valueOf)&&!n(i=r.call(e)))return i;if(!t&&"function"==typeof(r=e.toString)&&!n(i=r.call(e)))return i;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":114}],161:[function(e,t,r){var n=0,i=Math.random();t.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+i).toString(36))}},{}],162:[function(e,t,r){var n=e("./_global").navigator;t.exports=n&&n.userAgent||""},{"./_global":104}],163:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e}},{"./_is-object":114}],164:[function(e,t,r){var n=e("./_global"),i=e("./_core"),s=e("./_library"),a=e("./_wks-ext"),o=e("./_object-dp").f;t.exports=function(e){var t=i.Symbol||(i.Symbol=s?{}:n.Symbol||{});"_"==e.charAt(0)||e in t||o(t,e,{value:a.f(e)})}},{"./_core":93,"./_global":104,"./_library":121,"./_object-dp":128,"./_wks-ext":165}],165:[function(e,t,r){r.f=e("./_wks")},{"./_wks":166}],166:[function(e,t,r){var n=e("./_shared")("wks"),i=e("./_uid"),s=e("./_global").Symbol,a="function"==typeof s;(t.exports=function(e){return n[e]||(n[e]=a&&s[e]||(a?s:i)("Symbol."+e))}).store=n},{"./_global":104,"./_shared":151,"./_uid":161}],167:[function(e,t,r){var n=e("./_classof"),i=e("./_wks")("iterator"),s=e("./_iterators");t.exports=e("./_core").getIteratorMethod=function(e){if(null!=e)return e[i]||e["@@iterator"]||s[n(e)]}},{"./_classof":87,"./_core":93,"./_iterators":120,"./_wks":166}],168:[function(e,t,r){var n=e("./_an-object"),i=e("./core.get-iterator-method");t.exports=e("./_core").getIterator=function(e){var t=i(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return n(t.call(e))}},{"./_an-object":80,"./_core":93,"./core.get-iterator-method":167}],169:[function(e,t,r){var n=e("./_classof"),i=e("./_wks")("iterator"),s=e("./_iterators");t.exports=e("./_core").isIterable=function(e){var t=Object(e);return void 0!==t[i]||"@@iterator"in t||s.hasOwnProperty(n(t))}},{"./_classof":87,"./_core":93,"./_iterators":120,"./_wks":166}],170:[function(e,t,r){"use strict";var n=e("./_ctx"),i=e("./_export"),s=e("./_to-object"),a=e("./_iter-call"),o=e("./_is-array-iter"),u=e("./_to-length"),c=e("./_create-property"),l=e("./core.get-iterator-method");i(i.S+i.F*!e("./_iter-detect")(function(e){Array.from(e)}),"Array",{from:function(e){var t,r,i,d,f=s(e),p="function"==typeof this?this:Array,h=arguments.length,b=h>1?arguments[1]:void 0,m=void 0!==b,v=0,y=l(f);if(m&&(b=n(b,h>2?arguments[2]:void 0,2)),null==y||p==Array&&o(y))for(r=new p(t=u(f.length));t>v;v++)c(r,v,m?b(f[v],v):f[v]);else for(d=y.call(f),r=new p;!(i=d.next()).done;v++)c(r,v,m?a(d,b,[i.value,v],!0):i.value);return r.length=v,r}})},{"./_create-property":94,"./_ctx":95,"./_export":101,"./_is-array-iter":111,"./_iter-call":115,"./_iter-detect":118,"./_to-length":158,"./_to-object":159,"./core.get-iterator-method":167}],171:[function(e,t,r){"use strict";var n=e("./_add-to-unscopables"),i=e("./_iter-step"),s=e("./_iterators"),a=e("./_to-iobject");t.exports=e("./_iter-define")(Array,"Array",function(e,t){this._t=a(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=void 0,i(1)):i(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])},"values"),s.Arguments=s.Array,n("keys"),n("values"),n("entries")},{"./_add-to-unscopables":78,"./_iter-define":117,"./_iter-step":119,"./_iterators":120,"./_to-iobject":157}],172:[function(e,t,r){"use strict";var n=e("./_collection-strong"),i=e("./_validate-collection");t.exports=e("./_collection")("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{get:function(e){var t=n.getEntry(i(this,"Map"),e);return t&&t.v},set:function(e,t){return n.def(i(this,"Map"),0===e?0:e,t)}},n,!0)},{"./_collection":92,"./_collection-strong":89,"./_validate-collection":163}],173:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{isInteger:e("./_is-integer")})},{"./_export":101,"./_is-integer":113}],174:[function(e,t,r){var n=e("./_export");n(n.S+n.F,"Object",{assign:e("./_object-assign")})},{"./_export":101,"./_object-assign":126}],175:[function(e,t,r){var n=e("./_export");n(n.S,"Object",{create:e("./_object-create")})},{"./_export":101,"./_object-create":127}],176:[function(e,t,r){var n=e("./_export");n(n.S+n.F*!e("./_descriptors"),"Object",{defineProperty:e("./_object-dp").f})},{"./_descriptors":97,"./_export":101,"./_object-dp":128}],177:[function(e,t,r){var n=e("./_to-iobject"),i=e("./_object-gopd").f;e("./_object-sap")("getOwnPropertyDescriptor",function(){return function(e,t){return i(n(e),t)}})},{"./_object-gopd":130,"./_object-sap":138,"./_to-iobject":157}],178:[function(e,t,r){var n=e("./_to-object"),i=e("./_object-gpo");e("./_object-sap")("getPrototypeOf",function(){return function(e){return i(n(e))}})},{"./_object-gpo":134,"./_object-sap":138,"./_to-object":159}],179:[function(e,t,r){var n=e("./_to-object"),i=e("./_object-keys");e("./_object-sap")("keys",function(){return function(e){return i(n(e))}})},{"./_object-keys":136,"./_object-sap":138,"./_to-object":159}],180:[function(e,t,r){var n=e("./_export");n(n.S,"Object",{setPrototypeOf:e("./_set-proto").set})},{"./_export":101,"./_set-proto":147}],181:[function(e,t,r){arguments[4][56][0].apply(r,arguments)},{dup:56}],182:[function(e,t,r){"use strict";var n,i,s,a,o=e("./_library"),u=e("./_global"),c=e("./_ctx"),l=e("./_classof"),d=e("./_export"),f=e("./_is-object"),p=e("./_a-function"),h=e("./_an-instance"),b=e("./_for-of"),m=e("./_species-constructor"),v=e("./_task").set,y=e("./_microtask")(),g=e("./_new-promise-capability"),_=e("./_perform"),k=e("./_user-agent"),w=e("./_promise-resolve"),x=u.TypeError,C=u.process,j=C&&C.versions,S=j&&j.v8||"",T=u.Promise,E="process"==l(C),M=function(){},I=i=g.f,R=!!function(){try{var t=T.resolve(1),r=(t.constructor={})[e("./_wks")("species")]=function(e){e(M,M)};return(E||"function"==typeof PromiseRejectionEvent)&&t.then(M)instanceof r&&0!==S.indexOf("6.6")&&-1===k.indexOf("Chrome/66")}catch(e){}}(),P=function(e){var t;return!(!f(e)||"function"!=typeof(t=e.then))&&t},O=function(e,t){if(!e._n){e._n=!0;var r=e._c;y(function(){for(var n=e._v,i=1==e._s,s=0,a=function(t){var r,s,a,o=i?t.ok:t.fail,u=t.resolve,c=t.reject,l=t.domain;try{o?(i||(2==e._h&&U(e),e._h=1),!0===o?r=n:(l&&l.enter(),r=o(n),l&&(l.exit(),a=!0)),r===t.promise?c(x("Promise-chain cycle")):(s=P(r))?s.call(r,u,c):u(r)):c(n)}catch(e){l&&!a&&l.exit(),c(e)}};r.length>s;)a(r[s++]);e._c=[],e._n=!1,t&&!e._h&&N(e)})}},N=function(e){v.call(u,function(){var t,r,n,i=e._v,s=L(e);if(s&&(t=_(function(){E?C.emit("unhandledRejection",i,e):(r=u.onunhandledrejection)?r({promise:e,reason:i}):(n=u.console)&&n.error&&n.error("Unhandled promise rejection",i)}),e._h=E||L(e)?2:1),e._a=void 0,s&&t.e)throw t.v})},L=function(e){return 1!==e._h&&0===(e._a||e._c).length},U=function(e){v.call(u,function(){var t;E?C.emit("rejectionHandled",e):(t=u.onrejectionhandled)&&t({promise:e,reason:e._v})})},A=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),O(t,!0))},D=function(e){var t,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===e)throw x("Promise can't be resolved itself");(t=P(e))?y(function(){var n={_w:r,_d:!1};try{t.call(e,c(D,n,1),c(A,n,1))}catch(e){A.call(n,e)}}):(r._v=e,r._s=1,O(r,!1))}catch(e){A.call({_w:r,_d:!1},e)}}};R||(T=function(e){h(this,T,"Promise","_h"),p(e),n.call(this);try{e(c(D,this,1),c(A,this,1))}catch(e){A.call(this,e)}},(n=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=e("./_redefine-all")(T.prototype,{then:function(e,t){var r=I(m(this,T));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=E?C.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&O(this,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),s=function(){var e=new n;this.promise=e,this.resolve=c(D,e,1),this.reject=c(A,e,1)},g.f=I=function(e){return e===T||e===a?new s(e):i(e)}),d(d.G+d.W+d.F*!R,{Promise:T}),e("./_set-to-string-tag")(T,"Promise"),e("./_set-species")("Promise"),a=e("./_core").Promise,d(d.S+d.F*!R,"Promise",{reject:function(e){var t=I(this);return(0,t.reject)(e),t.promise}}),d(d.S+d.F*(o||!R),"Promise",{resolve:function(e){return w(o&&this===a?T:this,e)}}),d(d.S+d.F*!(R&&e("./_iter-detect")(function(e){T.all(e).catch(M)})),"Promise",{all:function(e){var t=this,r=I(t),n=r.resolve,i=r.reject,s=_(function(){var r=[],s=0,a=1;b(e,!1,function(e){var o=s++,u=!1;r.push(void 0),a++,t.resolve(e).then(function(e){u||(u=!0,r[o]=e,--a||n(r))},i)}),--a||n(r)});return s.e&&i(s.v),r.promise},race:function(e){var t=this,r=I(t),n=r.reject,i=_(function(){b(e,!1,function(e){t.resolve(e).then(r.resolve,n)})});return i.e&&n(i.v),r.promise}})},{"./_a-function":77,"./_an-instance":79,"./_classof":87,"./_core":93,"./_ctx":95,"./_export":101,"./_for-of":103,"./_global":104,"./_is-object":114,"./_iter-detect":118,"./_library":121,"./_microtask":124,"./_new-promise-capability":125,"./_perform":140,"./_promise-resolve":141,"./_redefine-all":143,"./_set-species":148,"./_set-to-string-tag":149,"./_species-constructor":152,"./_task":154,"./_user-agent":162,"./_wks":166}],183:[function(e,t,r){var n=e("./_export"),i=e("./_object-create"),s=e("./_a-function"),a=e("./_an-object"),o=e("./_is-object"),u=e("./_fails"),c=e("./_bind"),l=(e("./_global").Reflect||{}).construct,d=u(function(){function e(){}return!(l(function(){},[],e)instanceof e)}),f=!u(function(){l(function(){})});n(n.S+n.F*(d||f),"Reflect",{construct:function(e,t){s(e),a(t);var r=arguments.length<3?e:s(arguments[2]);if(f&&!d)return l(e,t,r);if(e==r){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var n=[null];return n.push.apply(n,t),new(c.apply(e,n))}var u=r.prototype,p=i(o(u)?u:Object.prototype),h=Function.apply.call(e,p,t);return o(h)?h:p}})},{"./_a-function":77,"./_an-object":80,"./_bind":86,"./_export":101,"./_fails":102,"./_global":104,"./_is-object":114,"./_object-create":127}],184:[function(e,t,r){"use strict";var n=e("./_collection-strong"),i=e("./_validate-collection");t.exports=e("./_collection")("Set",function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},{add:function(e){return n.def(i(this,"Set"),e=0===e?0:e,e)}},n)},{"./_collection":92,"./_collection-strong":89,"./_validate-collection":163}],185:[function(e,t,r){"use strict";var n=e("./_string-at")(!0);e("./_iter-define")(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,r=this._i;return r>=t.length?{value:void 0,done:!0}:(e=n(t,r),this._i+=e.length,{value:e,done:!1})})},{"./_iter-define":117,"./_string-at":153}],186:[function(e,t,r){"use strict";var n=e("./_global"),i=e("./_has"),s=e("./_descriptors"),a=e("./_export"),o=e("./_redefine"),u=e("./_meta").KEY,c=e("./_fails"),l=e("./_shared"),d=e("./_set-to-string-tag"),f=e("./_uid"),p=e("./_wks"),h=e("./_wks-ext"),b=e("./_wks-define"),m=e("./_enum-keys"),v=e("./_is-array"),y=e("./_an-object"),g=e("./_is-object"),_=e("./_to-object"),k=e("./_to-iobject"),w=e("./_to-primitive"),x=e("./_property-desc"),C=e("./_object-create"),j=e("./_object-gopn-ext"),S=e("./_object-gopd"),T=e("./_object-gops"),E=e("./_object-dp"),M=e("./_object-keys"),I=S.f,R=E.f,P=j.f,O=n.Symbol,N=n.JSON,L=N&&N.stringify,U=p("_hidden"),A=p("toPrimitive"),D={}.propertyIsEnumerable,F=l("symbol-registry"),q=l("symbols"),B=l("op-symbols"),G=Object.prototype,W="function"==typeof O&&!!T.f,z=n.QObject,K=!z||!z.prototype||!z.prototype.findChild,H=s&&c(function(){return 7!=C(R({},"a",{get:function(){return R(this,"a",{value:7}).a}})).a})?function(e,t,r){var n=I(G,t);n&&delete G[t],R(e,t,r),n&&e!==G&&R(G,t,n)}:R,Q=function(e){var t=q[e]=C(O.prototype);return t._k=e,t},J=W&&"symbol"==typeof O.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof O},V=function(e,t,r){return e===G&&V(B,t,r),y(e),t=w(t,!0),y(r),i(q,t)?(r.enumerable?(i(e,U)&&e[U][t]&&(e[U][t]=!1),r=C(r,{enumerable:x(0,!1)})):(i(e,U)||R(e,U,x(1,{})),e[U][t]=!0),H(e,t,r)):R(e,t,r)},$=function(e,t){y(e);for(var r,n=m(t=k(t)),i=0,s=n.length;s>i;)V(e,r=n[i++],t[r]);return e},X=function(e){var t=D.call(this,e=w(e,!0));return!(this===G&&i(q,e)&&!i(B,e))&&(!(t||!i(this,e)||!i(q,e)||i(this,U)&&this[U][e])||t)},Y=function(e,t){if(e=k(e),t=w(t,!0),e!==G||!i(q,t)||i(B,t)){var r=I(e,t);return!r||!i(q,t)||i(e,U)&&e[U][t]||(r.enumerable=!0),r}},Z=function(e){for(var t,r=P(k(e)),n=[],s=0;r.length>s;)i(q,t=r[s++])||t==U||t==u||n.push(t);return n},ee=function(e){for(var t,r=e===G,n=P(r?B:k(e)),s=[],a=0;n.length>a;)!i(q,t=n[a++])||r&&!i(G,t)||s.push(q[t]);return s};W||(o((O=function(){if(this instanceof O)throw TypeError("Symbol is not a constructor!");var e=f(arguments.length>0?arguments[0]:void 0),t=function(r){this===G&&t.call(B,r),i(this,U)&&i(this[U],e)&&(this[U][e]=!1),H(this,e,x(1,r))};return s&&K&&H(G,e,{configurable:!0,set:t}),Q(e)}).prototype,"toString",function(){return this._k}),S.f=Y,E.f=V,e("./_object-gopn").f=j.f=Z,e("./_object-pie").f=X,T.f=ee,s&&!e("./_library")&&o(G,"propertyIsEnumerable",X,!0),h.f=function(e){return Q(p(e))}),a(a.G+a.W+a.F*!W,{Symbol:O});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),re=0;te.length>re;)p(te[re++]);for(var ne=M(p.store),ie=0;ne.length>ie;)b(ne[ie++]);a(a.S+a.F*!W,"Symbol",{for:function(e){return i(F,e+="")?F[e]:F[e]=O(e)},keyFor:function(e){if(!J(e))throw TypeError(e+" is not a symbol!");for(var t in F)if(F[t]===e)return t},useSetter:function(){K=!0},useSimple:function(){K=!1}}),a(a.S+a.F*!W,"Object",{create:function(e,t){return void 0===t?C(e):$(C(e),t)},defineProperty:V,defineProperties:$,getOwnPropertyDescriptor:Y,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var se=c(function(){T.f(1)});a(a.S+a.F*se,"Object",{getOwnPropertySymbols:function(e){return T.f(_(e))}}),N&&a(a.S+a.F*(!W||c(function(){var e=O();return"[null]"!=L([e])||"{}"!=L({a:e})||"{}"!=L(Object(e))})),"JSON",{stringify:function(e){for(var t,r,n=[e],i=1;arguments.length>i;)n.push(arguments[i++]);if(r=t=n[1],(g(t)||void 0!==e)&&!J(e))return v(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!J(t))return t}),n[1]=t,L.apply(N,n)}}),O.prototype[A]||e("./_hide")(O.prototype,A,O.prototype.valueOf),d(O,"Symbol"),d(Math,"Math",!0),d(n.JSON,"JSON",!0)},{"./_an-object":80,"./_descriptors":97,"./_enum-keys":100,"./_export":101,"./_fails":102,"./_global":104,"./_has":105,"./_hide":106,"./_is-array":112,"./_is-object":114,"./_library":121,"./_meta":122,"./_object-create":127,"./_object-dp":128,"./_object-gopd":130,"./_object-gopn":132,"./_object-gopn-ext":131,"./_object-gops":133,"./_object-keys":136,"./_object-pie":137,"./_property-desc":142,"./_redefine":144,"./_set-to-string-tag":149,"./_shared":151,"./_to-iobject":157,"./_to-object":159,"./_to-primitive":160,"./_uid":161,"./_wks":166,"./_wks-define":164,"./_wks-ext":165}],187:[function(e,t,r){"use strict";var n,i=e("./_global"),s=e("./_array-methods")(0),a=e("./_redefine"),o=e("./_meta"),u=e("./_object-assign"),c=e("./_collection-weak"),l=e("./_is-object"),d=e("./_validate-collection"),f=e("./_validate-collection"),p=!i.ActiveXObject&&"ActiveXObject"in i,h=o.getWeak,b=Object.isExtensible,m=c.ufstore,v=function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},y={get:function(e){if(l(e)){var t=h(e);return!0===t?m(d(this,"WeakMap")).get(e):t?t[this._i]:void 0}},set:function(e,t){return c.def(d(this,"WeakMap"),e,t)}},g=t.exports=e("./_collection")("WeakMap",v,y,c,!0,!0);f&&p&&(u((n=c.getConstructor(v,"WeakMap")).prototype,y),o.NEED=!0,s(["delete","has","get","set"],function(e){var t=g.prototype,r=t[e];a(t,e,function(t,i){if(l(t)&&!b(t)){this._f||(this._f=new n);var s=this._f[e](t,i);return"set"==e?this:s}return r.call(this,t,i)})}))},{"./_array-methods":83,"./_collection":92,"./_collection-weak":91,"./_global":104,"./_is-object":114,"./_meta":122,"./_object-assign":126,"./_redefine":144,"./_validate-collection":163}],188:[function(e,t,r){e("./_set-collection-from")("Map")},{"./_set-collection-from":145}],189:[function(e,t,r){e("./_set-collection-of")("Map")},{"./_set-collection-of":146}],190:[function(e,t,r){var n=e("./_export");n(n.P+n.R,"Map",{toJSON:e("./_collection-to-json")("Map")})},{"./_collection-to-json":90,"./_export":101}],191:[function(e,t,r){var n=e("./_export"),i=e("./_object-to-array")(!0);n(n.S,"Object",{entries:function(e){return i(e)}})},{"./_export":101,"./_object-to-array":139}],192:[function(e,t,r){"use strict";var n=e("./_export"),i=e("./_core"),s=e("./_global"),a=e("./_species-constructor"),o=e("./_promise-resolve");n(n.P+n.R,"Promise",{finally:function(e){var t=a(this,i.Promise||s.Promise),r="function"==typeof e;return this.then(r?function(r){return o(t,e()).then(function(){return r})}:e,r?function(r){return o(t,e()).then(function(){throw r})}:e)}})},{"./_core":93,"./_export":101,"./_global":104,"./_promise-resolve":141,"./_species-constructor":152}],193:[function(e,t,r){"use strict";var n=e("./_export"),i=e("./_new-promise-capability"),s=e("./_perform");n(n.S,"Promise",{try:function(e){var t=i.f(this),r=s(e);return(r.e?t.reject:t.resolve)(r.v),t.promise}})},{"./_export":101,"./_new-promise-capability":125,"./_perform":140}],194:[function(e,t,r){var n=e("./_metadata"),i=e("./_an-object"),s=e("./_a-function"),a=n.key,o=n.set;n.exp({metadata:function(e,t){return function(r,n){o(e,t,(void 0!==n?i:s)(r),a(n))}}})},{"./_a-function":77,"./_an-object":80,"./_metadata":123}],195:[function(e,t,r){e("./_set-collection-from")("Set")},{"./_set-collection-from":145}],196:[function(e,t,r){e("./_set-collection-of")("Set")},{"./_set-collection-of":146}],197:[function(e,t,r){var n=e("./_export");n(n.P+n.R,"Set",{toJSON:e("./_collection-to-json")("Set")})},{"./_collection-to-json":90,"./_export":101}],198:[function(e,t,r){e("./_wks-define")("asyncIterator")},{"./_wks-define":164}],199:[function(e,t,r){e("./_wks-define")("observable")},{"./_wks-define":164}],200:[function(e,t,r){e("./es6.array.iterator");for(var n=e("./_global"),i=e("./_hide"),s=e("./_iterators"),a=e("./_wks")("toStringTag"),o="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),u=0;u<o.length;u++){var c=o[u],l=n[c],d=l&&l.prototype;d&&!d[a]&&i(d,a,c),s[c]=s.Array}},{"./_global":104,"./_hide":106,"./_iterators":120,"./_wks":166,"./es6.array.iterator":171}],201:[function(e,t,r){
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
var n=Object.create||function(e){var t=function(){};return t.prototype=e,new t},i=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return r},s=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function a(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=n(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0;var o,u=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),o=0===c.x}catch(e){o=!1}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,r,i){var s,a,o;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),a=e._events),o=a[t]):(a=e._events=n(null),e._eventsCount=0),o){if("function"==typeof o?o=a[t]=i?[r,o]:[o,r]:i?o.unshift(r):o.push(r),!o.warned&&(s=l(e))&&s>0&&o.length>s){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",u.name,u.message)}}else o=a[t]=r,++e._eventsCount;return e}function f(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function p(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=s.call(f,n);return i.listener=r,n.wrapFn=i,i}function h(e,t,r){var n=e._events;if(!n)return[];var i=n[t];return i?"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):m(i,i.length):[]}function b(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function m(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}o?Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');u=e}}):a.defaultMaxListeners=u,a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){var t,r,n,i,s,a,o="error"===e;if(a=this._events)o=o&&null==a.error;else if(!o)return!1;if(o){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var u=new Error('Unhandled "error" event. ('+t+")");throw u.context=t,u}if(!(r=a[e]))return!1;var c="function"==typeof r;switch(n=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var n=e.length,i=m(e,n),s=0;s<n;++s)i[s].call(r)}(r,c,this);break;case 2:!function(e,t,r,n){if(t)e.call(r,n);else for(var i=e.length,s=m(e,i),a=0;a<i;++a)s[a].call(r,n)}(r,c,this,arguments[1]);break;case 3:!function(e,t,r,n,i){if(t)e.call(r,n,i);else for(var s=e.length,a=m(e,s),o=0;o<s;++o)a[o].call(r,n,i)}(r,c,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,n,i,s){if(t)e.call(r,n,i,s);else for(var a=e.length,o=m(e,a),u=0;u<a;++u)o[u].call(r,n,i,s)}(r,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(n-1),s=1;s<n;s++)i[s-1]=arguments[s];!function(e,t,r,n){if(t)e.apply(r,n);else for(var i=e.length,s=m(e,i),a=0;a<i;++a)s[a].apply(r,n)}(r,c,this,i)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,i,s,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=n(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(s=-1,a=r.length-1;a>=0;a--)if(r[a]===t||r[a].listener===t){o=r[a].listener,s=a;break}if(s<0)return this;0===s?r.shift():function(e,t){for(var r=t,n=r+1,i=e.length;n<i;r+=1,n+=1)e[r]=e[n];e.pop()}(r,s),1===r.length&&(i[e]=r[0]),i.removeListener&&this.emit("removeListener",e,o||t)}return this},a.prototype.removeAllListeners=function(e){var t,r,s;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=n(null),this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=n(null):delete r[e]),this;if(0===arguments.length){var a,o=i(r);for(s=0;s<o.length;++s)"removeListener"!==(a=o[s])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=n(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},a.prototype.listeners=function(e){return h(this,e,!0)},a.prototype.rawListeners=function(e){return h(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):b.call(e,t)},a.prototype.listenerCount=b,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],202:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=["weeks","years","months","days","hours","minutes","seconds"],i=Object.freeze({years:0,months:0,weeks:0,days:0,hours:0,minutes:0,seconds:0}),s=r.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),a=r.parse=function(e){return e.match(s).slice(1).reduce(function(e,t,r){return e[n[r]]=parseFloat(t)||0,e},{})},o=r.end=function(e,t){e=Object.assign({},i,e);var r=t?t.getTime():Date.now(),n=new Date(r);return n.setFullYear(n.getFullYear()+e.years),n.setMonth(n.getMonth()+e.months),n.setDate(n.getDate()+e.days),n.setHours(n.getHours()+e.hours),n.setMinutes(n.getMinutes()+e.minutes),n.setMilliseconds(n.getMilliseconds()+1e3*e.seconds),n.setDate(n.getDate()+7*e.weeks),n},u=r.toSeconds=function(e,t){e=Object.assign({},i,e);var r=t?t.getTime():Date.now(),n=new Date(r);return(o(e,n).getTime()-n.getTime())/1e3};r.default={end:o,toSeconds:u,pattern:s,parse:a}},{}],203:[function(e,t,r){var n,i;n=this,i=function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t,r){"use strict";e.exports=function(e,t){var r,n,i;for(r=1;r<arguments.length;r++)for(i in n=arguments[r])n.hasOwnProperty(i)&&(e[i]=n[i]);return e}},function(e,t,r){"use strict";var n=r(0);e.exports={build:function(e,t){var r,i,s,a=t.plugins;for(r=0,i=a.length;r<i;r++)(s=a[r]).methods&&n(e,s.methods),s.properties&&Object.defineProperties(e,s.properties)},hook:function(e,t,r){var n,i,s,a,o=e.config.plugins,u=[e.context];for(r&&(u=u.concat(r)),n=0,i=o.length;n<i;n++)a=o[n],(s=o[n][t])&&s.apply(a,u)}}},function(e,t,r){"use strict";function n(e){if(0===e.length)return e;var t,r,n=e.split(/[_-]/);if(1===n.length&&n[0][0].toLowerCase()===n[0][0])return e;for(r=n[0].toLowerCase(),t=1;t<n.length;t++)r=r+n[t].charAt(0).toUpperCase()+n[t].substring(1).toLowerCase();return r}n.prepended=function(e,t){return e+(t=n(t))[0].toUpperCase()+t.substring(1)},e.exports=n},function(e,t,r){"use strict";var n=r(0),i=r(2);function s(e,t){e=e||{},this.options=e,this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}n(s.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=i.prepended("onEnter",e),this.lifecycle.onLeave[e]=i.prepended("onLeave",e),this.lifecycle.on[e]=i.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=i.prepended("onBefore",e),this.lifecycle.onAfter[e]=i.prepended("onAfter",e),this.lifecycle.on[e]=i.prepended("on",e)},mapTransition:function(e){var t=e.name,r=e.from,n=e.to;return this.addState(r),"function"!=typeof n&&this.addState(n),this.addTransition(t),this.map[r][t]=e,e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(n({},this.defaults.init,{to:e,active:!0})):"object"==typeof e?this.mapTransition(n({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"==typeof e?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){var r,n,i;for(r=0,n=(e=e||[]).length;r<n;r++)"function"==typeof(i=e[r])&&(e[r]=i=i()),i.configure&&i.configure(this);return e},configureTransitions:function(e){var t,r,n,i,s,a=this.defaults.wildcard;for(r=0;r<e.length;r++)for(n=e[r],i=Array.isArray(n.from)?n.from:[n.from||a],s=n.to||a,t=0;t<i.length;t++)this.mapTransition({name:n.name,from:i[t],to:s})},transitionFor:function(e,t){var r=this.defaults.wildcard;return this.map[e][t]||this.map[r][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=s},function(e,t,r){var n=r(0),i=r(6),s=r(1),a=[null,[]];function o(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}n(o.prototype,{init:function(e){if(n(this.context,this.config.data.apply(this.context,e)),s.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?e.indexOf(this.state)>=0:this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var r=this.config.defaults.wildcard,n=this.config.transitionFor(this.state,e),i=n&&n.to;return"function"==typeof i?i.apply(this.context,t):i===r?this.state:i},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,r,n){var i=this.config.lifecycle,s=this.config.options.observeUnchangedState||t!==r;return r?this.isPending()?this.context.onPendingTransition(e,t,r):(this.config.addState(r),this.beginTransit(),n.unshift({transition:e,from:t,to:r,fsm:this.context}),this.observeEvents([this.observersForEvent(i.onBefore.transition),this.observersForEvent(i.onBefore[e]),s?this.observersForEvent(i.onLeave.state):a,s?this.observersForEvent(i.onLeave[t]):a,this.observersForEvent(i.on.transition),s?["doTransit",[this]]:a,s?this.observersForEvent(i.onEnter.state):a,s?this.observersForEvent(i.onEnter[r]):a,s?this.observersForEvent(i.on[r]):a,this.observersForEvent(i.onAfter.transition),this.observersForEvent(i.onAfter[e]),this.observersForEvent(i.on[e])],n)):this.context.onInvalidTransition(e,t,r)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){if(2===e.length){var t={};t[e[0]]=e[1],this.observers.push(t)}else this.observers.push(e[0])},observersForEvent:function(e){for(var t,r=0,n=this.observers.length,i=[];r<n;r++)(t=this.observers[r])[e]&&i.push(t);return[e,i,!0]},observeEvents:function(e,t,r,n){if(0===e.length)return this.endTransit(void 0===n||n);var i=e[0][0],a=e[0][1],o=e[0][2];if(t[0].event=i,i&&o&&i!==r&&s.hook(this,"lifecycle",t),0===a.length)return e.shift(),this.observeEvents(e,t,i,n);var u=a.shift(),c=u[i].apply(u,t);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,e,t,i)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(e,t,i,c)},onInvalidTransition:function(e,t,r){throw new i("transition is invalid in current state",e,t,r,this.state)},onPendingTransition:function(e,t,r){throw new i("transition is invalid while previous transition is still in progress",e,t,r,this.state)}}),e.exports=o},function(e,t,r){"use strict";var n=r(0),i=r(2),s=r(1),a=r(3),o=r(4),u={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,r){return this._fsm.onInvalidTransition(e,t,r)},onPendingTransition:function(e,t,r){return this._fsm.onPendingTransition(e,t,r)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function l(e){return d(this||{},e)}function d(e,t){return f(e,new a(t,l)),e._fsm(),e}function f(e,t){if("object"!=typeof e||Array.isArray(e))throw Error("StateMachine can only be applied to objects");s.build(e,t),Object.defineProperties(e,c),n(e,u),n(e,t.methods),t.allTransitions().forEach(function(t){e[i(t)]=function(){return this._fsm.fire(t,[].slice.call(arguments))}}),e._fsm=function(){this._fsm=new o(this,t),this._fsm.init(arguments)}}l.version="3.0.1",l.factory=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[0],t=arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},t=arguments[0]||{});var r=new a(t,l);return f(e.prototype,r),e.prototype._fsm.config=r,e},l.apply=d,l.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=l},function(e,t,r){"use strict";e.exports=function(e,t,r,n,i){this.message=e,this.transition=t,this.from=r,this.to=n,this.current=i}}])},"object"==typeof r&&"object"==typeof t?t.exports=i():"object"==typeof r?r.StateMachine=i():n.StateMachine=i()},{}],204:[function(e,t,r){
/*
* loglevel - https://github.com/pimterry/loglevel
*
* Copyright (c) 2013 Tim Perry
* Licensed under the MIT license.
*/
!function(e,r){"use strict";"object"==typeof t&&t.exports?t.exports=r():e.log=r()}(this,function(){"use strict";var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function i(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(t,r){for(var i=0;i<n.length;i++){var s=n[i];this[s]=i<t?e:this.methodFactory(s,t,r)}this.log=this.debug}function o(n,o,u){return function(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?s:void 0!==console[n]?i(console,n):void 0!==console.log?i(console,"log"):e)}(n)||function(e,r,n){return function(){typeof console!==t&&(a.call(this,r,n),this[e].apply(this,arguments))}}.apply(this,arguments)}function u(e,r,i){var s,u=this,c="loglevel";function l(){var e;if(typeof window!==t&&c){try{e=window.localStorage[c]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(c)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}"string"==typeof e?c+=":"+e:"symbol"==typeof e&&(c=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=i||o,u.getLevel=function(){return s},u.setLevel=function(r,i){if("string"==typeof r&&void 0!==u.levels[r.toUpperCase()]&&(r=u.levels[r.toUpperCase()]),!("number"==typeof r&&r>=0&&r<=u.levels.SILENT))throw"log.setLevel() called with invalid level: "+r;if(s=r,!1!==i&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&c){try{return void(window.localStorage[c]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"="+r+";"}catch(e){}}}(r),a.call(u,r,e),typeof console===t&&r<u.levels.SILENT)return"No console available for logging"},u.setDefaultLevel=function(e){l()||u.setLevel(e,!1)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)};var d=l();null==d&&(d=null==r?"WARN":r),u.setLevel(d,!1)}var c=new u,l={};c.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=l[e];return t||(t=l[e]=new u(e,c.getLevel(),c.methodFactory)),t};var d=typeof window!==t?window.log:void 0;return c.noConflict=function(){return typeof window!==t&&window.log===c&&(window.log=d),c},c.getLoggers=function(){return l},c.default=c,c})},{}],205:[function(e,t,r){"use strict";var n=u(e("babel-runtime/core-js/object/get-prototype-of")),i=u(e("babel-runtime/helpers/classCallCheck")),s=u(e("babel-runtime/helpers/createClass")),a=u(e("babel-runtime/helpers/possibleConstructorReturn")),o=u(e("babel-runtime/helpers/inherits"));function u(e){return e&&e.__esModule?e:{default:e}}function c(e){return null!=e}Object.defineProperty(r,"__esModule",{value:!0});var l=function(e){function t(e){(0,i.default)(this,t);var r=(0,a.default)(this,(t.__proto__||(0,n.default)(t)).call(this));if(c((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(c(e.maxDelay)&&e.maxDelay<=1)throw new Error("The maximal timeout must be greater than 1.");if(c(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");if(c(e.factor)&&e.factor<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=e.initialDelay||100,r.maxDelay=e.maxDelay||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=e.randomisationFactor||0,r.factor=e.factor||2,r.maxNumberOfRetry=-1,r.reset(),r}return(0,o.default)(t,e),(0,s.default)(t,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got "+e);this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new t(e)}}]),t}(e("events").EventEmitter);r.Backoff=l,r.default=l},{"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201}],206:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./retrier");r.Retrier=n.Retrier;var i=e("./backoff");r.Backoff=i.Backoff,r.default=n.Retrier},{"./backoff":205,"./retrier":207}],207:[function(e,t,r){"use strict";var n=c(e("babel-runtime/core-js/promise")),i=c(e("babel-runtime/core-js/object/get-prototype-of")),s=c(e("babel-runtime/helpers/classCallCheck")),a=c(e("babel-runtime/helpers/createClass")),o=c(e("babel-runtime/helpers/possibleConstructorReturn")),u=c(e("babel-runtime/helpers/inherits"));function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var l=function(e){function t(e){(0,s.default)(this,t);var r=(0,o.default)(this,(t.__proto__||(0,i.default)(t)).call(this));return r.minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return(0,u.default)(t,e),(0,a.default)(t,[{key:"attempt",value:function(){clearTimeout(this.timeout),this.attemptNum++,this.timeout=null,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,r=Math.round(Math.random()*t*2-t);return Math.max(0,e+r)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached")),void this.reject(new Error("Maximum attempt count reached"));var r=this.nextDelay(e);if(r=this.randomize(r),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+r)return this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached")),void this.reject(new Error("Maximum attempt time limit reached"));this.timeout=setTimeout(function(){return t.attempt()},r)}},{key:"cleanup",value:function(){clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){var e=this;if(this.inProgress)throw new Error("Retrier is already in progress");return this.inProgress=!0,new n.default(function(t,r){e.resolve=t,e.reject=r,e.startTimestamp=Date.now(),e.scheduleAttempt(e.initialDelay)})}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"),this.reject(new Error("Cancelled")))}},{key:"succeeded",value:function(e){this.emit("succeeded",e),this.resolve(e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}},{key:"run",value:function(e){var t=this;return this.on("attempt",function(){e().then(function(e){return t.succeeded(e)}).catch(function(e){return t.failed(e)})}),this.start()}}]),t}(e("events").EventEmitter);r.Retrier=l,r.default=l},{"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201}],208:[function(e,t,r){(function(e){(function(){(function(){"use strict";var n={function:!0,object:!0},i=n[typeof window]&&window||this,s=n[typeof r]&&r,a=n[typeof t]&&t&&!t.nodeType&&t,o=s&&a&&"object"==typeof e&&e;!o||o.global!==o&&o.window!==o&&o.self!==o||(i=o);var u=Math.pow(2,53)-1,c=/\bOpera/,l=Object.prototype,d=l.hasOwnProperty,f=l.toString;function p(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function h(e){return e=g(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:p(e)}function b(e,t){for(var r in e)d.call(e,r)&&t(e[r],r,e)}function m(e){return null==e?p(e):f.call(e).slice(8,-1)}function v(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function y(e,t){var r=null;return function(e,t){var r=-1,n=e?e.length:0;if("number"==typeof n&&n>-1&&n<=u)for(;++r<n;)t(e[r],r,e);else b(e,t)}(e,function(n,i){r=t(r,n,i,e)}),r}function g(e){return String(e).replace(/^ +| +$/g,"")}var _=function e(t){var r=i,n=t&&"object"==typeof t&&"String"!=m(t);n&&(r=t,t=null);var s=r.navigator||{},a=s.userAgent||"";t||(t=a);var o,u,l,d,p,_=n?!!s.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(f.toString()),k=n?"Object":"ScriptBridgingProxyObject",w=n?"Object":"Environment",x=n&&r.java?"JavaPackage":m(r.java),C=n?"Object":"RuntimeObject",j=/\bJava/.test(x)&&r.java,S=j&&m(r.environment)==w,T=j?"a":"\u03b1",E=j?"b":"\u03b2",M=r.document||{},I=r.operamini||r.opera,R=c.test(R=n&&I?I["[[Class]]"]:m(I))?R:I=null,P=t,O=[],N=null,L=t==a,U=L&&I&&"function"==typeof I.version&&I.version(),A=y([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,r){return e||RegExp("\\b"+(r.pattern||v(r))+"\\b","i").exec(t)&&(r.label||r)}),D=function(e){return y(e,function(e,r){return e||RegExp("\\b"+(r.pattern||v(r))+"\\b","i").exec(t)&&(r.label||r)})}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),F=G([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),q=function(e){return y(e,function(e,r,n){return e||(r[F]||r[/^[a-z]+(?: +[a-z]+\b)*/i.exec(F)]||RegExp("\\b"+v(n)+"(?:\\b|\\w*\\d)","i").exec(t))&&n})}({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}}),B=function(e){return y(e,function(e,r){var n=r.pattern||v(r);return!e&&(e=RegExp("\\b"+n+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(e=function(e,t,r){var n={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return t&&r&&/^Win/i.test(e)&&!/^Windows Phone /i.test(e)&&(n=n[/[\d.]+$/.exec(e)])&&(e="Windows "+n),e=String(e),t&&r&&(e=e.replace(RegExp(t,"i"),r)),e=h(e.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(e,n,r.label||r)),e})}(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function G(e){return y(e,function(e,r){var n=r.pattern||v(r);return!e&&(e=RegExp("\\b"+n+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+n+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+n+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(r.label&&!RegExp(n,"i").test(r.label)?r.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),r=r.label||r,e=h(e[0].replace(RegExp(n,"i"),r).replace(RegExp("; *(?:"+r+"[_-])?","i")," ").replace(RegExp("("+r+")[-_.]?(\\w)","i"),"$1 $2"))),e})}function W(e){return y(e,function(e,r){return e||(RegExp(r+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null})}if(A&&(A=[A]),/\bAndroid\b/.test(B)&&!F&&(o=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(t))&&(F=g(o[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),q&&!F?F=G([q]):q&&F&&(F=F.replace(RegExp("^("+v(q)+")[-_.\\s]","i"),q+" ").replace(RegExp("^("+v(q)+")[-_.]?(\\w)","i"),q+" $2")),(o=/\bGoogle TV\b/.exec(F))&&(F=o[0]),/\bSimulator\b/i.test(t)&&(F=(F?F+" ":"")+"Simulator"),"Opera Mini"==D&&/\bOPiOS\b/.test(t)&&O.push("running in Turbo/Uncompressed mode"),"IE"==D&&/\blike iPhone OS\b/.test(t)?(q=(o=e(t.replace(/like iPhone OS/,""))).manufacturer,F=o.product):/^iP/.test(F)?(D||(D="Safari"),B="iOS"+((o=/ OS ([\d_]+)/i.exec(t))?" "+o[1].replace(/_/g,"."):"")):"Konqueror"==D&&/^Linux\b/i.test(B)?B="Kubuntu":q&&"Google"!=q&&(/Chrome/.test(D)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(F))||/\bAndroid\b/.test(B)&&/^Chrome/.test(D)&&/\bVersion\//i.test(t)?(D="Android Browser",B=/\bAndroid\b/.test(B)?B:"Android"):"Silk"==D?(/\bMobi/i.test(t)||(B="Android",O.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&O.unshift("accelerated")):"UC Browser"==D&&/\bUCWEB\b/.test(t)?O.push("speed mode"):"PaleMoon"==D&&(o=/\bFirefox\/([\d.]+)\b/.exec(t))?O.push("identifying as Firefox "+o[1]):"Firefox"==D&&(o=/\b(Mobile|Tablet|TV)\b/i.exec(t))?(B||(B="Firefox OS"),F||(F=o[1])):!D||(o=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(D))?(D&&!F&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(o+"/")+8))&&(D=null),(o=F||q||B)&&(F||q||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(B))&&(D=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(B)?B:o)+" Browser")):"Electron"==D&&(o=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&O.push("Chromium "+o),U||(U=W(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",v(D),"(?:Firefox|Minefield|NetFront)"])),(o=("iCab"==A&&parseFloat(U)>3?"WebKit":/\bOpera\b/.test(D)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(A)&&"WebKit"||!A&&/\bMSIE\b/i.test(t)&&("Mac OS"==B?"Tasman":"Trident")||"WebKit"==A&&/\bPlayStation\b(?! Vita\b)/i.test(D)&&"NetFront")&&(A=[o]),"IE"==D&&(o=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(D+=" Mobile",B="Windows Phone "+(/\+$/.test(o)?o:o+".x"),O.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(D="IE Mobile",B="Windows Phone 8.x",O.unshift("desktop mode"),U||(U=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=D&&"Trident"==A&&(o=/\brv:([\d.]+)/.exec(t))&&(D&&O.push("identifying as "+D+(U?" "+U:"")),D="IE",U=o[1]),L){if(d="global",p=null!=(l=r)?typeof l[d]:"number",/^(?:boolean|number|string|undefined)$/.test(p)||"object"==p&&!l[d])m(o=r.runtime)==k?(D="Adobe AIR",B=o.flash.system.Capabilities.os):m(o=r.phantom)==C?(D="PhantomJS",U=(o=o.version||null)&&o.major+"."+o.minor+"."+o.patch):"number"==typeof M.documentMode&&(o=/\bTrident\/(\d+)/i.exec(t))?(U=[U,M.documentMode],(o=+o[1]+4)!=U[1]&&(O.push("IE "+U[1]+" mode"),A&&(A[1]=""),U[1]=o),U="IE"==D?String(U[1].toFixed(1)):U[0]):"number"==typeof M.documentMode&&/^(?:Chrome|Firefox)\b/.test(D)&&(O.push("masking as "+D+" "+U),D="IE",U="11.0",A=["Trident"],B="Windows");else if(j&&(P=(o=j.lang.System).getProperty("os.arch"),B=B||o.getProperty("os.name")+" "+o.getProperty("os.version")),S){try{U=r.require("ringo/engine").version.join("."),D="RingoJS"}catch(e){(o=r.system)&&o.global.system==r.system&&(D="Narwhal",B||(B=o[0].os||null))}D||(D="Rhino")}else"object"==typeof r.process&&!r.process.browser&&(o=r.process)&&("object"==typeof o.versions&&("string"==typeof o.versions.electron?(O.push("Node "+o.versions.node),D="Electron",U=o.versions.electron):"string"==typeof o.versions.nw&&(O.push("Chromium "+U,"Node "+o.versions.node),D="NW.js",U=o.versions.nw)),D||(D="Node.js",P=o.arch,B=o.platform,U=(U=/[\d.]+/.exec(o.version))?U[0]:null));B=B&&h(B)}if(U&&(o=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(U)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(L&&s.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(N=/b/i.test(o)?"beta":"alpha",U=U.replace(RegExp(o+"\\+?$"),"")+("beta"==N?E:T)+(/\d+\+?/.exec(o)||"")),"Fennec"==D||"Firefox"==D&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(B))D="Firefox Mobile";else if("Maxthon"==D&&U)U=U.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(F))"Xbox 360"==F&&(B=null),"Xbox 360"==F&&/\bIEMobile\b/.test(t)&&O.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(D)&&(!D||F||/Browser|Mobi/.test(D))||"Windows CE"!=B&&!/Mobi/i.test(t))if("IE"==D&&L)try{null===r.external&&O.unshift("platform preview")}catch(e){O.unshift("embedded")}else(/\bBlackBerry\b/.test(F)||/\bBB10\b/.test(t))&&(o=(RegExp(F.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||U)?(B=((o=[o,/BB10/.test(t)])[1]?(F=null,q="BlackBerry"):"Device Software")+" "+o[0],U=null):this!=b&&"Wii"!=F&&(L&&I||/Opera/.test(D)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==D&&/\bOS X (?:\d+\.){2,}/.test(B)||"IE"==D&&(B&&!/^Win/.test(B)&&U>5.5||/\bWindows XP\b/.test(B)&&U>8||8==U&&!/\bTrident\b/.test(t)))&&!c.test(o=e.call(b,t.replace(c,"")+";"))&&o.name&&(o="ing as "+o.name+((o=o.version)?" "+o:""),c.test(D)?(/\bIE\b/.test(o)&&"Mac OS"==B&&(B=null),o="identify"+o):(o="mask"+o,D=R?h(R.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(o)&&(B=null),L||(U=null)),A=["Presto"],O.push(o));else D+=" Mobile";(o=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(o=[parseFloat(o.replace(/\.(\d)$/,".0$1")),o],"Safari"==D&&"+"==o[1].slice(-1)?(D="WebKit Nightly",N="alpha",U=o[1].slice(0,-1)):U!=o[1]&&U!=(o[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(U=null),o[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(t)||0)[1],537.36==o[0]&&537.36==o[2]&&parseFloat(o[1])>=28&&"WebKit"==A&&(A=["Blink"]),L&&(_||o[1])?(A&&(A[1]="like Chrome"),o=o[1]||((o=o[0])<530?1:o<532?2:o<532.05?3:o<533?4:o<534.03?5:o<534.07?6:o<534.1?7:o<534.13?8:o<534.16?9:o<534.24?10:o<534.3?11:o<535.01?12:o<535.02?"13+":o<535.07?15:o<535.11?16:o<535.19?17:o<536.05?18:o<536.1?19:o<537.01?20:o<537.11?"21+":o<537.13?23:o<537.18?24:o<537.24?25:o<537.36?26:"Blink"!=A?"27":"28")):(A&&(A[1]="like Safari"),o=(o=o[0])<400?1:o<500?2:o<526?3:o<533?4:o<534?"4+":o<535?5:o<537?6:o<538?7:o<601?8:o<602?9:o<604?10:o<606?11:o<608?12:"12"),A&&(A[1]+=" "+(o+="number"==typeof o?".x":/[.+]/.test(o)?"":"+")),"Safari"==D&&(!U||parseInt(U)>45)?U=o:"Chrome"==D&&/\bHeadlessChrome/i.test(t)&&O.unshift("headless")),"Opera"==D&&(o=/\bzbov|zvav$/.exec(B))?(D+=" ",O.unshift("desktop mode"),"zvav"==o?(D+="Mini",U=null):D+="Mobile",B=B.replace(RegExp(" *"+o+"$"),"")):"Safari"==D&&/\bChrome\b/.exec(A&&A[1])?(O.unshift("desktop mode"),D="Chrome Mobile",U=null,/\bOS X\b/.test(B)?(q="Apple",B="iOS 4.3+"):B=null):/\bSRWare Iron\b/.test(D)&&!U&&(U=W("Chrome")),U&&0==U.indexOf(o=/[\d.]+$/.exec(B))&&t.indexOf("/"+o+"-")>-1&&(B=g(B.replace(o,""))),B&&-1!=B.indexOf(D)&&!RegExp(D+" OS").test(B)&&(B=B.replace(RegExp(" *"+v(D)+" *"),"")),A&&!/\b(?:Avant|Nook)\b/.test(D)&&(/Browser|Lunascape|Maxthon/.test(D)||"Safari"!=D&&/^iOS/.test(B)&&/\bSafari\b/.test(A[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(D)&&A[1])&&(o=A[A.length-1])&&O.push(o),O.length&&(O=["("+O.join("; ")+")"]),q&&F&&F.indexOf(q)<0&&O.push("on "+q),F&&O.push((/^on /.test(O[O.length-1])?"":"on ")+F),B&&(o=/ ([\d.+]+)$/.exec(B),u=o&&"/"==B.charAt(B.length-o[0].length-1),B={architecture:32,family:o&&!u?B.replace(o[0],""):B,version:o?o[1]:null,toString:function(){var e=this.version;return this.family+(e&&!u?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(o=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(P))&&!/\bi686\b/i.test(P)?(B&&(B.architecture=64,B.family=B.family.replace(RegExp(" *"+o),"")),D&&(/\bWOW64\b/i.test(t)||L&&/\w(?:86|32)$/.test(s.cpuClass||s.platform)&&!/\bWin64; x64\b/i.test(t))&&O.unshift("32-bit")):B&&/^OS X/.test(B.family)&&"Chrome"==D&&parseFloat(U)>=39&&(B.architecture=64),t||(t=null);var z={};return z.description=t,z.layout=A&&A[0],z.manufacturer=q,z.name=D,z.prerelease=N,z.product=F,z.ua=t,z.version=D&&U,z.os=B||{architecture:null,family:null,version:null,toString:function(){return"null"}},z.parse=e,z.toString=function(){return this.description||""},z.version&&O.unshift(U),z.name&&O.unshift(D),B&&D&&(B!=String(B).split(" ")[0]||B!=D.split(" ")[0]&&!F)&&O.push(F?"("+B+")":"on "+B),O.length&&(z.description=O.join(" ")),z}();s&&a?b(_,function(e,t){s[t]=e}):i.platform=_}).call(this)}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],209:[function(e,t,r){
/**
 * Copyright (c) 2014-present, Facebook, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
var n=function(){return this}()||Function("return this")(),i=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,s=i&&n.regeneratorRuntime;if(n.regeneratorRuntime=void 0,t.exports=e("./runtime"),i)n.regeneratorRuntime=s;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}},{"./runtime":210}],210:[function(e,t,r){
/**
 * Copyright (c) 2014-present, Facebook, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
!function(e){"use strict";var r,n=Object.prototype,i=n.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",u=s.toStringTag||"@@toStringTag",c="object"==typeof t,l=e.regeneratorRuntime;if(l)c&&(t.exports=l);else{(l=e.regeneratorRuntime=c?t.exports:{}).wrap=_;var d="suspendedStart",f="suspendedYield",p="executing",h="completed",b={},m={};m[a]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(R([])));y&&y!==n&&i.call(y,a)&&(m=y);var g=C.prototype=w.prototype=Object.create(m);x.prototype=g.constructor=C,C.constructor=x,C[u]=x.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,C):(e.__proto__=C,u in e||(e[u]="GeneratorFunction")),e.prototype=Object.create(g),e},l.awrap=function(e){return{__await:e}},j(S.prototype),S.prototype[o]=function(){return this},l.AsyncIterator=S,l.async=function(e,t,r,n){var i=new S(_(e,t,r,n));return l.isGeneratorFunction(t)?i:i.next().then(function(e){return e.done?e.value:i.next()})},j(g),g[u]="Generator",g[a]=function(){return this},g.toString=function(){return"[object Generator]"},l.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},l.values=R,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(M),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,i){return o.type="throw",o.arg=e,t.next=n,i&&(t.method="next",t.arg=r),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var u=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&i.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var s=n;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var a=s?s.completion:{};return a.type=e,a.arg=t,s?(this.method="next",this.next=s.finallyLoc,b):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),b},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),M(r),b}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;M(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:R(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=r),b}}}function _(e,t,r,n){var i=t&&t.prototype instanceof w?t:w,s=Object.create(i.prototype),a=new I(n||[]);return s._invoke=function(e,t,r){var n=d;return function(i,s){if(n===p)throw new Error("Generator is already running");if(n===h){if("throw"===i)throw s;return P()}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var o=T(a,r);if(o){if(o===b)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var u=k(e,t,r);if("normal"===u.type){if(n=r.done?h:f,u.arg===b)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=h,r.method="throw",r.arg=u.arg)}}}(e,r,a),s}function k(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function w(){}function x(){}function C(){}function j(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function S(e){var t;this._invoke=function(r,n){function s(){return new Promise(function(t,s){!function t(r,n,s,a){var o=k(e[r],e,n);if("throw"!==o.type){var u=o.arg,c=u.value;return c&&"object"==typeof c&&i.call(c,"__await")?Promise.resolve(c.__await).then(function(e){t("next",e,s,a)},function(e){t("throw",e,s,a)}):Promise.resolve(c).then(function(e){u.value=e,s(u)},a)}a(o.arg)}(r,n,t,s)})}return t=t?t.then(s,s):s()}}function T(e,t){var n=e.iterator[t.method];if(n===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=r,T(e,t),"throw"===t.method))return b;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return b}var i=k(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,b;var s=i.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=r),t.delegate=null,b):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,b)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function M(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function R(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,s=function t(){for(;++n<e.length;)if(i.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=r,t.done=!0,t};return s.next=s}}return{next:P}}function P(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")())},{}],211:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.diffAny=r.diffObjects=r.diffArrays=r.intersection=r.subtract=r.isDestructive=void 0;var n=e("./equal"),i=e("./util");function s(e,t){var r={};for(var n in e)i.hasOwnProperty.call(e,n)&&void 0!==e[n]&&(r[n]=1);for(var s in t)i.hasOwnProperty.call(t,s)&&void 0!==t[s]&&delete r[s];return Object.keys(r)}function a(e){for(var t=e.length,r={},n=0;n<t;n++){var s=e[n];for(var a in s)i.hasOwnProperty.call(s,a)&&void 0!==s[a]&&(r[a]=(r[a]||0)+1)}for(var a in r)r[a]<t&&delete r[a];return Object.keys(r)}function o(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function u(e,t,r,i){void 0===i&&(i=l);var s={"0,0":{operations:[],cost:0}};var a=isNaN(e.length)||e.length<=0?0:e.length,u=isNaN(t.length)||t.length<=0?0:t.length;return function r(i,a){var u=i+","+a,c=s[u];if(void 0===c){if(i>0&&a>0&&n.compare(e[i-1],t[a-1]))c=r(i-1,a-1);else{var l=[];if(i>0){var d=r(i-1,a),f={op:"remove",index:i-1};l.push(o(d,f))}if(a>0){var p=r(i,a-1),h={op:"add",index:i-1,value:t[a-1]};l.push(o(p,h))}if(i>0&&a>0){var b=r(i-1,a-1),m={op:"replace",index:i-1,original:e[i-1],value:t[a-1]};l.push(o(b,m))}c=l.sort(function(e,t){return e.cost-t.cost})[0]}s[u]=c}return c}(a,u).operations.reduce(function(e,t){var n=e[0],s=e[1];if(function(e){return"add"===e.op}(t)){var o=t.index+1+s,u=o<a+s?String(o):"-",c={op:t.op,path:r.add(u).toString(),value:t.value};return[n.concat(c),s+1]}if(function(e){return"remove"===e.op}(t)){c={op:t.op,path:r.add(String(t.index+s)).toString()};return[n.concat(c),s-1]}var l=r.add(String(t.index+s)),d=i(t.original,t.value,l);return[n.concat.apply(n,d),s]},[[],0])[0]}function c(e,t,r,n){void 0===n&&(n=l);var i=[];return s(e,t).forEach(function(e){i.push({op:"remove",path:r.add(e).toString()})}),s(t,e).forEach(function(e){i.push({op:"add",path:r.add(e).toString(),value:t[e]})}),a([e,t]).forEach(function(s){i.push.apply(i,n(e[s],t[s],r.add(s)))}),i}function l(e,t,r,n){if(void 0===n&&(n=l),e===t)return[];var s=i.objectType(e),a=i.objectType(t);return"array"==s&&"array"==a?u(e,t,r,n):"object"==s&&"object"==a?c(e,t,r,n):[{op:"replace",path:r.toString(),value:t}]}r.isDestructive=function(e){var t=e.op;return"remove"===t||"replace"===t||"copy"===t||"move"===t},r.subtract=s,r.intersection=a,r.diffArrays=u,r.diffObjects=c,r.diffAny=l},{"./equal":212,"./util":216}],212:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.compare=void 0;var n=e("./util");function i(e,t){if(e===t)return!0;var r=n.objectType(e),s=n.objectType(t);return"array"==r&&"array"==s?function(e,t){var r=e.length;if(r!==t.length)return!1;for(var n=0;n<r;n++)if(!i(e[n],t[n]))return!1;return!0}(e,t):"object"==r&&"object"==s&&function(e,t){var r=Object.keys(e),s=Object.keys(t),a=r.length;if(a!==s.length)return!1;for(var o=0;o<a;o++){var u=r[o];if(!n.hasOwnProperty.call(t,u)||!i(e[u],t[u]))return!1}return!0}(e,t)}r.compare=i},{"./util":216}],213:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.createTests=r.createPatch=r.applyPatch=void 0;var n=e("./pointer"),i=e("./patch"),s=e("./diff");function a(e,t){var r=n.Pointer.fromJSON(t).evaluate(e);if(void 0!==r)return{op:"test",path:t,value:r.value}}r.applyPatch=function(e,t){return t.map(function(t){return i.apply(e,t)})},r.createPatch=function(e,t,r){var i=new n.Pointer;return(r?function(e){return function t(r,n,i){var a=e(r,n,i);return Array.isArray(a)?a:s.diffAny(r,n,i,t)}}(r):s.diffAny)(e,t,i)},r.createTests=function(e,t){var r=new Array;return t.filter(s.isDestructive).forEach(function(t){var n=a(e,t.path);if(n&&r.push(n),"from"in t){var i=a(e,t.from);i&&r.push(i)}}),r}},{"./diff":211,"./patch":214,"./pointer":215}],214:[function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(r,"__esModule",{value:!0}),r.apply=r.InvalidOperationError=r.test=r.copy=r.move=r.replace=r.remove=r.add=r.TestError=r.MissingError=void 0;var s=e("./pointer"),a=e("./util"),o=e("./equal"),u=function(e){function t(t){var r=e.call(this,"Value required at path: "+t)||this;return r.path=t,r.name="MissingError",r}return i(t,e),t}(Error);r.MissingError=u;var c=function(e){function t(t,r){var n=e.call(this,"Test failed: "+t+" != "+r)||this;return n.actual=t,n.expected=r,n.name="TestError",n}return i(t,e),t}(Error);function l(e,t,r){if(Array.isArray(e))if("-"==t)e.push(r);else{var n=parseInt(t,10);e.splice(n,0,r)}else e[t]=r}function d(e,t){if(Array.isArray(e)){var r=parseInt(t,10);e.splice(r,1)}else delete e[t]}function f(e,t){var r=s.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.parent?new u(t.path):(l(r.parent,r.key,a.clone(t.value)),null)}function p(e,t){var r=s.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.value?new u(t.path):(d(r.parent,r.key),null)}function h(e,t){var r=s.Pointer.fromJSON(t.path).evaluate(e);if(null===r.parent)return new u(t.path);if(Array.isArray(r.parent)){if(parseInt(r.key,10)>=r.parent.length)return new u(t.path)}else if(void 0===r.value)return new u(t.path);return r.parent[r.key]=t.value,null}function b(e,t){var r=s.Pointer.fromJSON(t.from).evaluate(e);if(void 0===r.value)return new u(t.from);var n=s.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.parent?new u(t.path):(d(r.parent,r.key),l(n.parent,n.key,r.value),null)}function m(e,t){var r=s.Pointer.fromJSON(t.from).evaluate(e);if(void 0===r.value)return new u(t.from);var n=s.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.parent?new u(t.path):(l(n.parent,n.key,a.clone(r.value)),null)}function v(e,t){var r=s.Pointer.fromJSON(t.path).evaluate(e);return o.compare(r.value,t.value)?null:new c(r.value,t.value)}r.TestError=c,r.add=f,r.remove=p,r.replace=h,r.move=b,r.copy=m,r.test=v;var y=function(e){function t(t){var r=e.call(this,"Invalid operation: "+t.op)||this;return r.operation=t,r.name="InvalidOperationError",r}return i(t,e),t}(Error);r.InvalidOperationError=y,r.apply=function(e,t){switch(t.op){case"add":return f(e,t);case"remove":return p(e,t);case"replace":return h(e,t);case"move":return b(e,t);case"copy":return m(e,t);case"test":return v(e,t)}return new y(t)}},{"./equal":212,"./pointer":215,"./util":216}],215:[function(e,t,r){"use strict";function n(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function i(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}Object.defineProperty(r,"__esModule",{value:!0}),r.Pointer=void 0;var s=function(){function e(e){void 0===e&&(e=[""]),this.tokens=e}return e.fromJSON=function(t){var r=t.split("/").map(n);if(""!==r[0])throw new Error("Invalid JSON Pointer: "+t);return new e(r)},e.prototype.toString=function(){return this.tokens.map(i).join("/")},e.prototype.evaluate=function(e){for(var t=null,r="",n=e,i=1,s=this.tokens.length;i<s;i++)n=((t=n)||{})[r=this.tokens[i]];return{parent:t,key:r,value:n}},e.prototype.get=function(e){return this.evaluate(e).value},e.prototype.set=function(e,t){for(var r=e,n=1,i=this.tokens.length-1,s=this.tokens[n];n<i;n++)r=(r||{})[s];r&&(r[this.tokens[this.tokens.length-1]]=t)},e.prototype.push=function(e){this.tokens.push(e)},e.prototype.add=function(t){return new e(this.tokens.concat(String(t)))},e}();r.Pointer=s},{}],216:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.clone=r.objectType=r.hasOwnProperty=void 0,r.hasOwnProperty=Object.prototype.hasOwnProperty,r.objectType=function(e){return void 0===e?"undefined":null===e?"null":Array.isArray(e)?"array":typeof e},r.clone=function e(t){if(null==t||"object"!=typeof t)return t;if(t.constructor==Array){for(var n=t.length,i=new Array(n),s=0;s<n;s++)i[s]=e(t[s]);return i}var a={};for(var o in t)r.hasOwnProperty.call(t,o)&&(a[o]=e(t[o]));return a}},{}],217:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.McsMedia=r.Media=r.McsClient=r.Client=void 0;var u=e("./logger"),c=e("./configuration"),l=e("./media");Object.defineProperty(r,"Media",{enumerable:!0,get:function(){return l.Media}}),Object.defineProperty(r,"McsMedia",{enumerable:!0,get:function(){return l.Media}});var d=e("./services/transport"),f=e("./services/network"),p=u.Logger.scope(""),h=e("./../package.json").version,b="A valid Twilio token should be provided",m=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if((0,s.default)(this,e),this.options=n,this.options.logLevel=this.options.logLevel||"silent",this.config=new c.Configuration(t,r,this.options),!t)throw new Error(b);p.setLevel(this.options.logLevel),this.options.transport=this.options.transport||new d.Transport,this.transport=this.options.transport,this.network=new f.Network(this.config,this.transport)}return(0,a.default)(e,[{key:"updateToken",value:function(e){if(p.info("updateToken"),!e)throw new Error(b);this.config.updateToken(e)}},{key:"get",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.get(this.config.baseUrl+"/"+t);case 2:return r=e.sent,e.abrupt("return",new l.Media(this.config,this.network,r.body));case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"post",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r){var i;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.post(this.config.baseUrl,r,t);case 2:return i=e.sent,e.abrupt("return",new l.Media(this.config,this.network,i.body));case 4:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"postFormData",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.post(this.config.baseUrl,t);case 2:return r=e.sent,e.abrupt("return",new l.Media(this.config,this.network,r.body));case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();r.Client=m,r.McsClient=m,m.version=h,r.default=m},{"./../package.json":225,"./configuration":218,"./logger":220,"./media":221,"./services/network":222,"./services/transport":223,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],218:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Configuration=void 0;var a=function(){function e(t,r,i){(0,n.default)(this,e);var s=i.MCS||i||{};this.region=s.region||i.region,this.baseUrl=r,this.token=t,this.retryWhenThrottledOverride=s.retryWhenThrottledOverride,this.backoffConfigOverride=s.backoffConfigOverride}return(0,i.default)(e,[{key:"updateToken",value:function(e){this.token=e}}],[{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}},{key:"retryWhenThrottledDefault",get:function(){return!0}}]),e}();r.Configuration=a},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],219:[function(e,t,r){"use strict";var n=e("./client");t.exports=n},{"./client":217}],220:[function(e,t,r){"use strict";var n=a(e("babel-runtime/helpers/classCallCheck")),i=a(e("babel-runtime/helpers/createClass")),s=a(e("babel-runtime/core-js/array/from"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Logger=void 0;var o=e("loglevel");function u(e,t){return[(new Date).toISOString()+" MCS Client "+e+":"].concat((0,s.default)(t))}var c=function(){function e(t){(0,n.default)(this,e),this.prefix="",this.prefix=null!=t&&t.length>0?t+" ":""}return(0,i.default)(e,[{key:"setLevel",value:function(e){o.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.trace.apply(null,u(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.info.apply(null,u(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.warn.apply(null,u(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.error.apply(null,u(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){o.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.trace.apply(null,u("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.info.apply(null,u("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.warn.apply(null,u("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.error.apply(null,u("E",t))}}]),e}();r.Logger=c},{"babel-runtime/core-js/array/from":26,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,loglevel:204}],221:[function(e,t,r){"use strict";var n=u(e("babel-runtime/regenerator")),i=u(e("babel-runtime/core-js/promise")),s=u(e("babel-runtime/helpers/asyncToGenerator")),a=u(e("babel-runtime/helpers/classCallCheck")),o=u(e("babel-runtime/helpers/createClass"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Media=void 0;var c=function(){function e(t,r,n){(0,a.default)(this,e),this.config=t,this.network=r,this._update(n)}return(0,o.default)(e,[{key:"getContentUrl",value:function(){var e=(0,s.default)(n.default.mark(function e(){var t;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.get(this.config.baseUrl+"/"+this.sid);case 2:return t=e.sent,this._update(t.body),e.abrupt("return",i.default.resolve(this.state.contentDirectUrl));case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_update",value:function(e){this.state={sid:e.sid,serviceSid:e.service_sid,channelSid:e.channel_sid,messageSid:e.message_sid,dateCreated:e.date_created?new Date(e.date_created):null,dateUpdated:e.date_updated?new Date(e.date_updated):null,size:e.size,contentType:e.content_type,url:e.url,contentUrl:e.links.content,contentDirectUrl:e.links.content_direct_temporary,filename:e.filename?e.filename:null}}},{key:"sid",get:function(){return this.state.sid}},{key:"serviceSid",get:function(){return this.state.serviceSid}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"fileName",get:function(){return this.state.filename}}]),e}();r.Media=c},{"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],222:[function(e,t,r){"use strict";var n=c(e("babel-runtime/regenerator")),i=c(e("babel-runtime/helpers/asyncToGenerator")),s=c(e("babel-runtime/core-js/promise")),a=c(e("babel-runtime/core-js/object/assign")),o=c(e("babel-runtime/helpers/classCallCheck")),u=c(e("babel-runtime/helpers/createClass"));function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Network=void 0;var l=e("operation-retrier"),d=e("../logger"),f=e("../configuration"),p=d.Logger.scope("Network"),h=function(){function e(t,r){(0,o.default)(this,e),this.config=t,this.transport=r}return(0,u.default)(e,[{key:"backoffConfig",value:function(){return(0,a.default)(f.Configuration.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){return void 0!==this.config.retryWhenThrottledOverride?this.config.retryWhenThrottledOverride:void 0!==f.Configuration.retryWhenThrottledDefault&&f.Configuration.retryWhenThrottledDefault}},{key:"executeWithRetry",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new s.default(function(n,i){var s=[502,503,504];r&&s.push(429);var a=new l.Retrier(t.backoffConfig());a.on("attempt",function(){e().then(function(e){return a.succeeded(e)}).catch(function(e){s.indexOf(e.status)>-1?a.failed(e):"Twilsock disconnected"===e.message?a.failed(e):(a.removeAllListeners(),a.cancel(),i(e))})}),a.on("succeeded",function(e){n(e)}),a.on("cancelled",function(e){return i(e)}),a.on("failed",function(e){return i(e)}),a.start()})}},{key:"get",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i,s=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={"X-Twilio-Token":this.config.token},p.trace("sending GET request to ",t," headers ",r),e.next=4,this.executeWithRetry(function(){return s.transport.get(t,r)},this.retryWhenThrottled());case 4:return i=e.sent,p.trace("response",i),e.abrupt("return",i);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"post",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r,i){var s,o;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={"X-Twilio-Token":this.config.token},"undefined"!=typeof FormData&&r instanceof FormData||!i||(0,a.default)(s,{"Content-Type":i}),o=void 0,p.trace("sending POST request to ",t," headers ",s),e.prev=4,e.next=7,this.transport.post(t,s,r);case 7:o=e.sent,e.next=18;break;case 10:if(e.prev=10,e.t0=e.catch(4),!(e.t0 instanceof TypeError)){e.next=17;break}throw p.trace("got error in post response",e.t0),new TypeError("Posting FormData supported only with browser engine's FormData");case 17:throw e.t0;case 18:return p.trace("response",o),e.abrupt("return",o);case 20:case"end":return e.stop()}},e,this,[[4,10]])}));return function(t,r,n){return e.apply(this,arguments)}}()}]),e}();r.Network=h},{"../configuration":218,"../logger":220,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55,"operation-retrier":206}],223:[function(e,t,r){(function(t){(function(){"use strict";var n=o(e("babel-runtime/core-js/json/stringify")),i=o(e("babel-runtime/core-js/promise")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Transport=void 0;var u=e("./transporterror"),c=t.XMLHttpRequest||e("xmlhttprequest").XMLHttpRequest;var l=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,[{key:"get",value:function(t,r){return e.request("GET",t,r)}},{key:"post",value:function(t,r,n){return e.request("POST",t,r,n)}}],[{key:"request",value:function(e,t,r,s){return new i.default(function(i,a){var o=new c;for(var l in o.open(e,t,!0),o.onreadystatechange=function(){if(4===o.readyState){var e,t=(e=o.getAllResponseHeaders())?e.split("\r\n").map(function(e){return e.split(": ")}).filter(function(e){return 2===e.length&&e[1].length>0}).reduce(function(e,t){return e[t[0]]=t[1],e},{}):{},r=function(e){var t=e.getResponseHeader("Content-Type");if(!t||0!==t.indexOf("application/json")||0===e.responseText.length)return e.responseText;try{return JSON.parse(e.responseText)}catch(t){return e.responseText}}(o);if(200<=o.status&&o.status<300)i({status:o.status,headers:t,body:r});else{var s=o.statusText&&o.statusText.code?o.statusText.code:"NONE",c=void 0;c="string"==typeof r?r&&1===r.split("\n",2).length?r:"":(0,n.default)(r);var l=o.status+": ["+s+"] "+c;a(new u.TransportError(l,o.status,r,s,t))}}},r)o.setRequestHeader(l,r[l]),"Content-Type"===l&&"application/json"===r[l]&&(s=(0,n.default)(s));o.send(s)})}}]),e}();r.Transport=l}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./transporterror":224,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,xmlhttprequest:56}],224:[function(e,t,r){"use strict";var n=d(e("babel-runtime/core-js/object/create")),i=d(e("babel-runtime/core-js/object/set-prototype-of")),s=d(e("babel-runtime/core-js/array/from")),a=d(e("babel-runtime/core-js/reflect/construct")),o=d(e("babel-runtime/core-js/object/get-prototype-of")),u=d(e("babel-runtime/helpers/classCallCheck")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.TransportError=void 0;var f=function(e){function t(e,r,n,i,s){(0,u.default)(this,t);var a=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e));return a.code=r,a.body=n,a.status=i,a.headers=s,a}return(0,l.default)(t,e),t}(function(e){function t(){var t=(0,a.default)(e,(0,s.default)(arguments));return(0,i.default)(t,(0,o.default)(this)),t}return t.prototype=(0,n.default)(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i.default?(0,i.default)(t,e):t.__proto__=e,t}(Error));r.TransportError=f},{"babel-runtime/core-js/array/from":26,"babel-runtime/core-js/object/create":33,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/object/set-prototype-of":39,"babel-runtime/core-js/reflect/construct":41,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],225:[function(e,t,r){t.exports={_from:"twilio-mcs-client@^0.4.1",_id:"twilio-mcs-client@0.4.1",_inBundle:!1,_integrity:"sha512-RetNbvpZn6MJZ26R4EMNiWmbIkvZ7CIctcOQ5pURLh7fsx2YO99jNW9YtmzL2SUf2Hfm5aFXN9/N9kzKBrF0GQ==",_location:"/twilio-mcs-client",_phantomChildren:{},_requested:{type:"range",registry:!0,raw:"twilio-mcs-client@^0.4.1",name:"twilio-mcs-client",escapedName:"twilio-mcs-client",rawSpec:"^0.4.1",saveSpec:null,fetchSpec:"^0.4.1"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/twilio-mcs-client/-/twilio-mcs-client-0.4.1.tgz",_shasum:"d8a3588131c22d7cfa7fc97fc1acb881e0e98b06",_spec:"twilio-mcs-client@^0.4.1",_where:"/home/circleci/project",author:{name:"Twilio"},browser:{xmlhttprequest:!1},browserify:{transform:["babelify"]},bundleDependencies:!1,dependencies:{loglevel:"^1.6.4","operation-retrier":"^3.0.1",xmlhttprequest:"^1.8.0"},deprecated:!1,description:"Twilio Media Content Service client library",devDependencies:{"@types/chai":"^4.2.2","@types/chai-as-promised":"^7.1.2","@types/chai-datetime":"0.0.33","@types/chai-string":"^1.4.2","@types/core-js":"^2.5.2","@types/express":"^4.17.7","@types/mocha":"^5.2.7","@types/node":"^12.7.4","@types/qs":"6.9.4","@types/sinon":"^7.0.13","@types/sinon-chai":"^3.2.3",async:"^3.1.0","async-test-tools":"^1.0.7","babel-core":"^6.26.0","babel-plugin-transform-builtin-extend":"^1.1.2","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.6.1","babel-runtime":"^6.26.0",babelify:"^8.0.0",browserify:"^16.0.0",chai:"^4.2.0","chai-as-promised":"^7.1.1","chai-datetime":"^1.5.0","chai-string":"^1.5.0",cheerio:"^1.0.0-rc.2","cross-env":"^5.2.1",del:"^5.1.0",dotenv:"^8.1.0",express:"^4.17.1",gulp:"^4.0.2","gulp-babel":"^7.0.1","gulp-derequire":"^2.1.0","gulp-if":"^3.0.0","gulp-insert":"^0.5.0","gulp-mocha":"^7.0.1","gulp-rename":"^1.4.0","gulp-sourcemaps":"^2.6.5","gulp-tap":"^2.0.0","gulp-tslint":"^8.1.4","gulp-typescript":"^5.0.1","gulp-uglify-es":"^1.0.0","ink-docstrap":"^1.3.2","isomorphic-form-data":"^2.0.0",jsdoc:"~3.5.5","jsdoc-strip-async-await":"^0.1.0",mocha:"^6.2.0",ngrok:"^3.2.5",nyc:"^14.1.1",sinon:"^7.4.2","sinon-chai":"^3.3.0","ts-node":"^8.3.0",tslint:"^5.19.0",twilio:"^3.55.0",typescript:"^3.6.2","uglify-save-license":"^0.4.1","vinyl-buffer":"^1.0.1","vinyl-source-stream":"^2.0.0"},engines:{node:">=6"},license:"MIT",main:"lib/index.js",name:"twilio-mcs-client",scripts:{integrationTest:"npx gulp integrationTest",unitTest:"npx gulp unitTest"},types:"./lib/client.d.ts",version:"0.4.1"}},{}],226:[function(e,t,r){"use strict";var n=l(e("babel-runtime/regenerator")),i=l(e("babel-runtime/helpers/asyncToGenerator")),s=l(e("babel-runtime/core-js/object/get-prototype-of")),a=l(e("babel-runtime/helpers/classCallCheck")),o=l(e("babel-runtime/helpers/createClass")),u=l(e("babel-runtime/helpers/possibleConstructorReturn")),c=l(e("babel-runtime/helpers/inherits"));function l(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Client=void 0;var d=e("events"),f=e("twilsock"),p=e("./configuration"),h=e("./registrar"),b=e("./logger"),m=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,a.default)(this,t);var n=(0,u.default)(this,(t.__proto__||(0,s.default)(t)).call(this));if(!e||0===e.length)throw new Error("Token is required for Notifications client");r.logLevel=r.logLevel||"error",b.log.setLevel(r.logLevel);r.minTokenRefreshInterval;var i=r.productId||"notifications";return r.twilsockClient=r.twilsockClient||new f.TwilsockClient(e,i,r),r.transport=r.transport||r.twilsockClient,n.services={twilsock:r.twilsockClient,transport:r.transport,config:new p.Configuration(null,r)},n.registrar=new h.Registrar(i,n.services.transport,n.services.twilsock,n.services.config),n.reliableTransportState={overall:!1,transport:!1,registration:!1,lastEmitted:null},n._onTransportStateChange(n.services.twilsock.isConnected),n.registrar.on("transportReady",function(e){n._onRegistrationStateChange(e?"registered":"")}),n.registrar.on("stateChanged",function(e){n._onRegistrationStateChange(e)}),n.registrar.on("needReliableTransport",n._onNeedReliableTransport.bind(n)),n.services.twilsock.on("message",function(e,t){return n._routeMessage(e,t)}),n.services.twilsock.on("connected",function(e){n._onTransportStateChange(!0),n.registrar.setNotificationId("twilsock",e)}),n.services.twilsock.on("disconnected",function(){n._onTransportStateChange(!1)}),n.services.config.updateToken(e),n.registrar.updateToken(e),n}return(0,c.default)(t,e),(0,o.default)(t,[{key:"_routeMessage",value:function(e,t){b.log.trace("Message arrived: ",e,t),this.emit("message",e,t)}},{key:"_onNeedReliableTransport",value:function(e){e?this.services.twilsock.connect():this.services.twilsock.disconnect()}},{key:"_onRegistrationStateChange",value:function(e){this.reliableTransportState.registration="registered"===e,this._updateTransportState()}},{key:"_onTransportStateChange",value:function(e){this.reliableTransportState.transport=e,this._updateTransportState()}},{key:"_updateTransportState",value:function(){var e=this.reliableTransportState.transport&&this.reliableTransportState.registration;this.reliableTransportState.overall!==e&&(this.reliableTransportState.overall=e,b.log.info("Transport ready:",e),this.emit("transportReady",e)),this.reliableTransportState.lastEmitted!==this.connectionState&&(this.reliableTransportState.lastEmitted=this.connectionState,this.emit("connectionStateChanged",this.connectionState))}},{key:"subscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"twilsock";return b.log.trace("Add subscriptions for message type: ",e,t),this.registrar.subscribe(e,t)}},{key:"unsubscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"twilsock";return b.log.trace("Remove subscriptions for message type: ",e,t),this.registrar.unsubscribe(e,t)}},{key:"handlePushNotification",value:function(e){return{messageType:e.twi_message_type,payload:e.payload}}},{key:"setPushRegistrationId",value:function(e,t){b.log.trace("Set push registration id",e,t),this.registrar.setNotificationId(t,e)}},{key:"updateToken",value:function(){var e=(0,i.default)(n.default.mark(function e(t){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(b.log.info("authTokenUpdated"),this.services.config.token!==t){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,this.services.twilsock.updateToken(t);case 5:this.services.config.updateToken(t),this.registrar.updateToken(t);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"connectionState",get:function(){return"disconnected"===this.services.twilsock.state?"disconnected":"disconnecting"===this.services.twilsock.state?"disconnecting":"connected"===this.services.twilsock.state&&this.reliableTransportState.registration?"connected":"rejected"===this.services.twilsock.state?"denied":"connecting"}}]),t}(d.EventEmitter);r.Client=m},{"./configuration":227,"./logger":230,"./registrar":232,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201,twilsock:270}],227:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Configuration=void 0;var a=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,n.default)(this,e);var i=r.notifications||{},s="https://ers."+(i.region||r.region||"us1")+".twilio.com/v1/registrations";this.registrarUrl=i.ersUrl||s,this._token=t}return(0,i.default)(e,[{key:"updateToken",value:function(e){this._token=e}},{key:"token",get:function(){return this._token}}]),e}();r.Configuration=a},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],228:[function(e,t,r){"use strict";var n=p(e("babel-runtime/helpers/slicedToArray")),i=p(e("babel-runtime/regenerator")),s=p(e("babel-runtime/helpers/asyncToGenerator")),a=p(e("babel-runtime/core-js/object/get-prototype-of")),o=p(e("babel-runtime/helpers/possibleConstructorReturn")),u=p(e("babel-runtime/helpers/inherits")),c=p(e("babel-runtime/helpers/toConsumableArray")),l=p(e("babel-runtime/core-js/set")),d=p(e("babel-runtime/helpers/classCallCheck")),f=p(e("babel-runtime/helpers/createClass"));function p(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Connector=r.RegistrationState=void 0;var h=e("events"),b=e("./logger"),m=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new l.default;(0,d.default)(this,e),this.token=t,this.notificationId=r,this.messageTypes=n}return(0,f.default)(e,[{key:"clone",value:function(){return new e(this.token,this.notificationId,new l.default(this.messageTypes))}}]),e}();function v(e,t){var r=new l.default;return e.notificationId!==t.notificationId&&r.add("notificationId"),e.token!==t.token&&r.add("token"),function(e,t){return[].concat((0,c.default)([].concat((0,c.default)(e)).filter(function(e){return!t.has(e)})),(0,c.default)([].concat((0,c.default)(t)).filter(function(t){return!e.has(t)})))}(e.messageTypes,t.messageTypes).length>0&&r.add("messageType"),[r.size>0,r]}r.RegistrationState=m;var y=function(e){function t(e){(0,d.default)(this,t);var r=(0,o.default)(this,(t.__proto__||(0,a.default)(t)).call(this));return r.config=e,r.desiredState=new m,r.currentState=new m,r.hasActiveAttempt=!1,r}return(0,u.default)(t,e),(0,f.default)(t,[{key:"subscribe",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.desiredState.messageTypes.has(t)){e.next=3;break}return b.log.debug("message type already registered ",t),e.abrupt("return");case 3:return this.desiredState.messageTypes.add(t),e.next=6,this.persistRegistration();case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"unsubscribe",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.desiredState.messageTypes.has(t)){e.next=2;break}return e.abrupt("return");case 2:return this.desiredState.messageTypes.delete(t),e.next=5,this.persistRegistration();case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateToken",value:function(e){this.desiredState.token=e,this.persistRegistration()}},{key:"persistRegistration",value:function(){var e=(0,s.default)(i.default.mark(function e(){var t,r,s,a,o,u,c=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.config.token&&0!==this.config.token.length){e.next=3;break}return b.log.trace("Can't persist registration: token is not set"),e.abrupt("return");case 3:if(!this.hasActiveAttempt){e.next=6;break}return b.log.trace("One registration attempt is already in progress"),e.abrupt("return");case 6:if(t=v(this.desiredState,this.currentState),r=(0,n.default)(t,2),s=r[0],a=r[1],s){e.next=9;break}return e.abrupt("return");case 9:if(this.currentState.notificationId||a.delete("notificationId"),b.log.trace("Persisting registration",a,this.desiredState),e.prev=11,this.hasActiveAttempt=!0,!((o=this.desiredState.clone()).messageTypes.size>0)){e.next=24;break}return e.next=17,this.updateRegistration(o,a);case 17:u=e.sent,this.currentState.token=u.token,this.currentState.notificationId=u.notificationId,this.currentState.messageTypes=u.messageTypes,this.emit("stateChanged","registered"),e.next=30;break;case 24:return e.next=26,this.removeRegistration();case 26:this.currentState.token=o.token,this.currentState.notificationId=o.notificationId,this.currentState.messageTypes.clear(),this.emit("stateChanged","unregistered");case 30:return e.prev=30,this.hasActiveAttempt=!1,setTimeout(function(){return c.persistRegistration()},0),e.finish(30);case 34:case"end":return e.stop()}},e,this,[[11,,30,34]])}));return function(){return e.apply(this,arguments)}}()},{key:"setNotificationId",value:function(e){this.desiredState.notificationId=e,this.persistRegistration()}}]),t}(h.EventEmitter);r.Connector=y},{"./logger":230,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/set":43,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/slicedToArray":52,"babel-runtime/helpers/toConsumableArray":53,"babel-runtime/regenerator":55,events:201}],229:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Notifications=void 0;var n=e("./client");Object.defineProperty(r,"Notifications",{enumerable:!0,get:function(){return n.Client}})},{"./client":226}],230:[function(e,t,r){"use strict";var n=a(e("babel-runtime/helpers/classCallCheck")),i=a(e("babel-runtime/helpers/createClass")),s=a(e("babel-runtime/core-js/array/from"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.log=r.Logger=void 0;var o=e("loglevel");function u(e,t){return[(new Date).toISOString()+" Notifications "+e+":"].concat((0,s.default)(t))}var c=function(){function e(){(0,n.default)(this,e),this.prefix=""}return(0,i.default)(e,[{key:"setLevel",value:function(e){o.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("T"+this.prefix,t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("D"+this.prefix,t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.info.apply(null,u("I"+this.prefix,t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.warn.apply(null,u("W"+this.prefix,t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.error.apply(null,u("E"+this.prefix,t))}}],[{key:"scope",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];return new e}}]),e}();r.Logger=c;var l=c.scope();r.log=l},{"babel-runtime/core-js/array/from":26,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,loglevel:204}],231:[function(e,t,r){"use strict";var n=f(e("babel-runtime/core-js/array/from")),i=f(e("babel-runtime/core-js/object/assign")),s=f(e("babel-runtime/regenerator")),a=f(e("babel-runtime/helpers/asyncToGenerator")),o=f(e("babel-runtime/core-js/object/get-prototype-of")),u=f(e("babel-runtime/helpers/classCallCheck")),c=f(e("babel-runtime/helpers/createClass")),l=f(e("babel-runtime/helpers/possibleConstructorReturn")),d=f(e("babel-runtime/helpers/inherits"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.RegistrarConnector=r.Connector=void 0;var p=e("operation-retrier"),h=e("./logger"),b=e("./connector");Object.defineProperty(r,"Connector",{enumerable:!0,get:function(){return b.Connector}});var m={min:2e3,max:12e4,randomness:.2},v=function(e){function t(e,r,n,i){(0,u.default)(this,t);var s=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this,i));return s.channelType=e,s.context=r,s.transport=n,s}return(0,d.default)(t,e),(0,c.default)(t,[{key:"updateRegistration",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.has("notificationId")){e.next=3;break}return e.next=3,this.removeRegistration();case 3:if(t.notificationId&&t.notificationId.length){e.next=5;break}return e.abrupt("return",t);case 5:return e.next=7,this.register(t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeRegistration",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t,r,n=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrationId){e.next=2;break}return e.abrupt("return");case 2:return t=this.config.registrarUrl+"/"+this.registrationId+"?productId="+this.context.productId,r={"Content-Type":"application/json","X-Twilio-Token":this.config.token},e.prev=4,h.log.trace("Removing registration for ",this.channelType),e.next=8,new p.Retrier((0,i.default)(m,{maxAttemptsCount:3})).run(function(){return n.transport.delete(t,r)});case 8:h.log.debug("Registration removed for",this.channelType),e.next=15;break;case 11:throw e.prev=11,e.t0=e.catch(4),h.log.error("Failed to remove of registration ",this.channelType,e.t0),e.t0;case 15:case"end":return e.stop()}},e,this,[[4,11]])}));return function(){return e.apply(this,arguments)}}()},{key:"register",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,i,a,o,u=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return h.log.trace("Registering",this.channelType,t),r={endpoint_platform:this.context.platform,channel_type:this.channelType,version:this.context.protocolVersion.toString(),message_types:(0,n.default)(t.messageTypes),data:{registration_id:t.notificationId},ttl:"PT24H"},i=this.config.registrarUrl+"?productId="+this.context.productId,a={"Content-Type":"application/json","X-Twilio-Token":t.token},h.log.trace("Creating registration for channel ",this.channelType),e.prev=5,e.next=8,new p.Retrier(m).run(function(){return u.transport.post(i,a,r)});case 8:o=e.sent,this.registrationId=o.body.id,h.log.debug("Registration created: ",o),e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(5),h.log.error("Registration failed: ",e.t0),e.t0;case 17:case"end":return e.stop()}},e,this,[[5,13]])}));return function(t){return e.apply(this,arguments)}}()}]),t}(b.Connector);r.RegistrarConnector=v},{"./connector":228,"./logger":230,"babel-runtime/core-js/array/from":26,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,"operation-retrier":206}],232:[function(e,t,r){"use strict";var n=c(e("babel-runtime/core-js/map")),i=c(e("babel-runtime/core-js/object/get-prototype-of")),s=c(e("babel-runtime/helpers/classCallCheck")),a=c(e("babel-runtime/helpers/createClass")),o=c(e("babel-runtime/helpers/possibleConstructorReturn")),u=c(e("babel-runtime/helpers/inherits"));function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.Registrar=void 0;var l=e("events"),d=e("./registrar.connector"),f=e("./twilsock.connector"),p=function(e){function t(e,r,a,u){(0,s.default)(this,t);var c=(0,o.default)(this,(t.__proto__||(0,i.default)(t)).call(this));c.config=u,c.connectors=new n.default;var l=c.detectPlatform();return c.connectors.set("gcm",new d.RegistrarConnector("gcm",{protocolVersion:3,productId:e,platform:l},r,u)),c.connectors.set("fcm",new d.RegistrarConnector("fcm",{protocolVersion:3,productId:e,platform:l},r,u)),c.connectors.set("apn",new d.RegistrarConnector("apn",{protocolVersion:4,productId:e,platform:l},r,u)),c.connectors.set("twilsock",new f.TwilsockConnector({productId:e,platform:l},a,u)),c.connectors.get("twilsock").on("transportReady",function(e){return c.emit("transportReady",e)}),c}return(0,u.default)(t,e),(0,a.default)(t,[{key:"setNotificationId",value:function(e,t){this.connector(e).setNotificationId(t)}},{key:"subscribe",value:function(e,t){return this.connector(t).subscribe(e)}},{key:"unsubscribe",value:function(e,t){return this.connector(t).unsubscribe(e)}},{key:"updateToken",value:function(e){this.connectors.forEach(function(t){return t.updateToken(e)})}},{key:"connector",value:function(e){var t=this.connectors.get(e);if(!t)throw new Error("Unknown channel type: "+e);return t}},{key:"detectPlatform",value:function(){var e="";return"undefined"!=typeof navigator?(e="unknown",void 0!==navigator.product&&(e=navigator.product),void 0!==navigator.userAgent&&(e=navigator.userAgent)):e="web",e.substring(0,128)}}]),t}(l.EventEmitter);r.Registrar=p},{"./registrar.connector":231,"./twilsock.connector":233,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201}],233:[function(e,t,r){"use strict";var n=d(e("babel-runtime/core-js/array/from")),i=d(e("babel-runtime/regenerator")),s=d(e("babel-runtime/helpers/asyncToGenerator")),a=d(e("babel-runtime/core-js/object/get-prototype-of")),o=d(e("babel-runtime/helpers/classCallCheck")),u=d(e("babel-runtime/helpers/createClass")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0}),r.TwilsockConnector=void 0;var f=e("uuid"),p=function(e){function t(e,r,n){(0,o.default)(this,t);var i=(0,c.default)(this,(t.__proto__||(0,a.default)(t)).call(this,n));return i.twilsock=r,i.context=e,e.id=f.v4(),i.twilsock.on("stateChanged",function(e){"connected"!==e&&i.emit("transportReady",!1)}),i.twilsock.on("registered",function(t){e&&t===e.id&&"connected"===r.state&&i.emit("transportReady",!0)}),i}return(0,l.default)(t,e),(0,u.default)(t,[{key:"setNotificationId",value:function(){}},{key:"updateToken",value:function(e){}},{key:"updateContextRequest",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={product_id:this.context.productId,notification_protocol_version:4,endpoint_platform:this.context.platform,message_types:t},this.emit("transportReady",!1),e.next=4,this.twilsock.setNotificationsContext(this.context.id,r);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateRegistration",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.has("messageType")){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.updateContextRequest((0,n.default)(t.messageTypes));case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeRegistration",value:function(){return this.twilsock.removeNotificationsContext(this.context.id)}}]),t}(e("./connector").Connector);r.TwilsockConnector=p},{"./connector":228,"babel-runtime/core-js/array/from":26,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,uuid:291}],234:[function(e,t,r){"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function n(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function i(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)a.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return a}Object.defineProperty(r,"__esModule",{value:!0});var s=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return{mode:"type",checks:e}},a=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return{mode:"custom",checks:e}},o=a(function(e){return["string"==typeof e&&e.length>0,"a non-empty string"]}),u=a(function(e){return["number"==typeof e&&Number.isInteger(e)&&e>=0,"a non-negative integer"]}),c=a(function(e){return["object"==typeof e&&null!==e&&!Array.isArray(e),"a pure object (non-null and non-array)"]}),l=function(e,t){var r,s;if(t.length>e.length)throw new Error("Expected at most "+e.length+" argument(s), but got "+t.length);for(;t.length<e.length;)t.push(void 0);try{for(var a=n(t.entries()),o=a.next();!o.done;o=a.next()){var u=i(o.value,2),c=u[0],l=u[1],d=i(h(e[c],l),4),f=d[0],p=d[1],b=d[2],m=d[3];if(!f)throw new Error("Argument "+(c+1)+" is expected to be "+b+m+" but got "+p)}}catch(e){r={error:e}}finally{try{o&&!o.done&&(s=a.return)&&s.call(a)}finally{if(r)throw r.error}}},d=function(e){var t,r,n;return["undefined","boolean","number","bigint","string"].includes(typeof e)&&(n="string"==typeof e?'"'+e+'"':""+e),"object"==typeof e&&"Object"!==(null===(t=null==e?void 0:e.constructor)||void 0===t?void 0:t.name)&&(n=null===e?"null":"instance of "+(null===(r=null==e?void 0:e.constructor)||void 0===r?void 0:r.name)),n||(n=typeof e),n},f=function(e){var t,r,i=[];try{for(var s=n(e),a=s.next();!a.done;a=s.next()){var o=a.value;i.push(p(o))}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return i},p=function(e){var t,r,i=[],a=Array.isArray(e)?e:[e];try{for(var o=n(a),u=o.next();!u.done;u=o.next()){var c=u.value;"string"!=typeof c&&"function"!=typeof c?i.push(c):i.push(s(c))}}catch(e){t={error:e}}finally{try{u&&!u.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return i},h=function(e,t){var r,s,a,o,u,c,l,f,p,h=[],b=!1;try{for(var m=n(e),v=m.next();!v.done;v=m.next()){var y=v.value;switch(y.mode){case"type":try{for(var g=(a=void 0,n(y.checks)),_=g.next();!_.done;_=g.next()){var k=_.value;"string"!=typeof k?(b=b||t instanceof k,h.push("an instance of "+k.name)):(b=b||typeof t===k,h.push("of type "+k))}}catch(e){a={error:e}}finally{try{_&&!_.done&&(o=g.return)&&o.call(g)}finally{if(a)throw a.error}}break;case"literal":try{for(var w=(u=void 0,n(y.checks)),x=w.next();!x.done;x=w.next()){var C=x.value;b=b||t===C,h.push("string"==typeof C?'"'+C+'"':""+C)}}catch(e){u={error:e}}finally{try{x&&!x.done&&(c=w.return)&&c.call(w)}finally{if(u)throw u.error}}break;case"custom":try{for(var j=(l=void 0,n(y.checks)),S=j.next();!S.done;S=j.next()){var T=i((0,S.value)(t),3),E=T[0],M=T[1],I=T[2];b=b||E,!p&&I&&(p=I),M&&h.push(M)}}catch(e){l={error:e}}finally{try{S&&!S.done&&(f=j.return)&&f.call(j)}finally{if(l)throw l.error}}}}}catch(e){r={error:e}}finally{try{v&&!v.done&&(s=m.return)&&s.call(m)}finally{if(r)throw r.error}}if(b)return[!0];var R=p||d(t),P=h.length-1;return[!1,R,P>0?h.slice(0,P).join(", ")+" or "+h[P]:h.join(", "),P>1?";":","]};r.custom=a,r.literal=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return{mode:"literal",checks:e}},r.nonEmptyString=o,r.nonNegativeInteger=u,r.objectSchema=function(e,t){return a(function(r){var s,a;if("object"!=typeof r||null===r||Array.isArray(r))return[!1,"valid "+e+" (should be a pure object)"];try{for(var o=n(Object.entries(t)),u=o.next();!u.done;u=o.next()){var c=i(u.value,2),l=c[0],d=c[1],f=i(h(p(d),r[l]),3),b=f[0],m=f[1],v=f[2];if(!b)return[!1,"valid "+e+' (key "'+l+'" should be '+v+")","malformed "+e+' (key "'+l+'" is '+m+")"]}}catch(e){s={error:e}}finally{try{u&&!u.done&&(a=o.return)&&a.call(o)}finally{if(s)throw s.error}}return[!0]})},r.pureObject=c,r.runtimeTypeValidation=l,r.stringifyReceivedType=d,r.type=s,r.validateTypes=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=f(e);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypes decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return l(r,e),i.apply(this,e)}}},r.validateTypesAsync=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=f(e);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypesAsync decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];try{l(r,e)}catch(e){return Promise.reject(e)}return i.apply(this,e)}}}},{}],235:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/get-iterator")),i=o(e("babel-runtime/helpers/slicedToArray")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=e("./utils/tree"),c=function(){function e(t,r){(0,s.default)(this,e),this.value=t,this.revision=r||0}return(0,a.default)(e,[{key:"isValid",get:function(){return!0}}]),e}(),l=function(){function e(t){(0,s.default)(this,e),this.revision=t}return(0,a.default)(e,[{key:"isValid",get:function(){return!1}}]),e}(),d=function(){function e(){(0,s.default)(this,e),this.items=new u.TreeMap}return(0,a.default)(e,[{key:"store",value:function(e,t,r){var n=this.items.get(e);return n&&n.revision>r?n.isValid?n.value:null:(this.items.set(e,new c(t,r)),t)}},{key:"delete",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.items.get(e);(!n||n.revision<t||n&&!0===r)&&this.items.set(e,new l(t))}},{key:"isKnown",value:function(e,t){var r=this.items.get(e);return r&&r.revision>=t}},{key:"get",value:function(e){var t=this.items.get(e);return t&&t.isValid?t.value:null}},{key:"has",value:function(e){var t=this.items.get(e);return t&&t.isValid}},{key:"forEach",value:function(e){if(this.items){var t=!0,r=!1,s=void 0;try{for(var a,o=(0,n.default)(this.items);!(t=(a=o.next()).done);t=!0){var u=a.value,c=(0,i.default)(u,2),l=c[0],d=c[1];d.isValid&&e(l,d.value)}}catch(e){r=!0,s=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw s}}}}}]),e}();r.Cache=d,r.default=d},{"./utils/tree":259,"babel-runtime/core-js/get-iterator":27,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/slicedToArray":52}],236:[function(e,t,r){"use strict";var n=f(e("babel-runtime/core-js/promise")),i=f(e("babel-runtime/regenerator")),s=f(e("babel-runtime/helpers/asyncToGenerator")),a=f(e("babel-runtime/core-js/object/get-prototype-of")),o=f(e("babel-runtime/helpers/classCallCheck")),u=f(e("babel-runtime/helpers/createClass")),c=f(e("babel-runtime/helpers/possibleConstructorReturn")),l=f(e("babel-runtime/helpers/inherits")),d=f(e("babel-runtime/core-js/object/assign"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("events"),h=e("twilsock"),b=e("twilio-notifications"),m=e("./utils/uri"),v=e("./utils/syncerror"),y=e("./utils/sanitize"),g=e("./utils/logger"),_=e("./configuration"),k=e("./subscriptions"),w=e("./router"),x=e("./services/network"),C=e("./syncdocument"),j=e("./synclist"),S=e("./syncmap"),T=e("./clientInfo"),E=e("./entitiesCache"),M=e("./services/storage"),I=e("./streams/syncstream"),R=e("./livequery"),P=e("./livequery"),O="data_sync",N=e("../package.json").version;function L(e){if(e){if("string"==typeof e)return{id:e,mode:"open_or_create"};y.validateOptionalTtl(e.ttl),y.validateId(e.id),e.mode&&y.validateMode(e.mode);var t=e.mode||(e.id?"open_or_create":"create_new");return(0,d.default)((0,d.default)({},e),{mode:t})}return{mode:"create_new"}}var U=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,o.default)(this,t);var n=(0,c.default)(this,(t.__proto__||(0,a.default)(t)).call(this));if(!e)throw new Error("Sync library needs a valid Twilio token to be passed");r.hasOwnProperty("logLevel")?g.default.setLevel(r.logLevel):g.default.setLevel("silent");var i=r.productId=r.productId||O;r.clientMetadata=r.clientMetadata||{},r.clientMetadata.hasOwnProperty("type")||(r.clientMetadata.type="sync"),r.clientMetadata.hasOwnProperty("sdk")||(r.clientMetadata.sdk="JS",r.clientMetadata.sdkv=N);var s=r.twilsockClient=r.twilsockClient||new h.Twilsock(e,i,r);s.on("tokenAboutToExpire",function(e){return n.emit("tokenAboutToExpire",e)}),s.on("tokenExpired",function(){return n.emit("tokenExpired")}),s.on("connectionError",function(e){return n.emit("connectionError",e)});var u=r.notificationsClient=r.notificationsClient||new b.Notifications(e,r),l=new _.Configuration(r),d=new x.NetworkService(new T.ClientInfo(N),l,s),f=new M.SessionStorage(l);n.localStorageId=null,s.connect(),n.services={config:l,twilsock:s,notifications:u,network:d,storage:f,router:null,subscriptions:null};var p=new k.Subscriptions(n.services),m=new w.Router({config:l,subscriptions:p,notifications:u});return n.services.router=m,n.services.subscriptions=p,n.entities=new E.EntitiesCache,u.on("connectionStateChanged",function(){n.emit("connectionStateChanged",n.services.notifications.connectionState)}),n}return(0,l.default)(t,e),(0,u.default)(t,[{key:"ensureReady",value:function(){var e=(0,s.default)(i.default.mark(function e(){var t;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.services.config.sessionStorageEnabled){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.services.twilsock.storageId();case 5:t=e.sent,this.services.storage.updateStorageId(t.id),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),g.default.warn("Failed to initialize storage",e.t0);case 12:case"end":return e.stop()}},e,this,[[2,9]])}));return function(){return e.apply(this,arguments)}}()},{key:"storeRootInSessionCache",value:function(e,t,r){if(this.services.config.sessionStorageEnabled&&t){var n=y.deepClone(r);e!==j.SyncList.type&&e!==S.SyncMap.type||(n.last_event_id=null,delete n.items),this.services.storage.store(e,t,n)}}},{key:"readRootFromSessionCache",value:function(e,t){return this.services.config.sessionStorageEnabled&&t?this.services.storage.read(e,t):null}},{key:"_get",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var n,s,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw new v.SyncError("Cannot get entity without id",404);case 2:return n=new m.UriBuilder(t).pathSegment(r).queryParam("Include",a?"items":void 0).build(),e.next=5,this.services.network.get(n);case 5:return s=e.sent,e.abrupt("return",s.body);case 7:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createDocument",value:function(e,t,r){var n={unique_name:e,data:t||{}};return void 0!==r&&(n.ttl=r),this.services.network.post(this.services.config.documentsUri,n).then(function(e){return e.body.data=n.data,e.body})}},{key:"_getDocument",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(C.SyncDocument.type,t)||this._get(this.services.config.documentsUri,t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_createList",value:function(e,t,r,n){var i={unique_name:e,purpose:t,context:r};return void 0!==n&&(i.ttl=n),this.services.network.post(this.services.config.listsUri,i).then(function(e){return e.body})}},{key:"_getList",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(j.SyncList.type,t)||this._get(this.services.config.listsUri,t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_createMap",value:function(e,t){var r={unique_name:e};return void 0!==t&&(r.ttl=t),this.services.network.post(this.services.config.mapsUri,r).then(function(e){return e.body})}},{key:"_getMap",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(S.SyncMap.type,t)||this._get(this.services.config.mapsUri,t,r));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getStream",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(I.SyncStream.type,t)||this._get(this.services.config.streamsUri,t,!1));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_createStream",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var n,s;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={unique_name:t},void 0!==r&&(n.ttl=r),e.next=4,this.services.network.post(this.services.config.streamsUri,n);case 4:return s=e.sent,e.abrupt("return",s.body);case 6:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_getLiveQuery",value:function(e){return this.readRootFromSessionCache(R.LiveQuery.type,e)}},{key:"getCached",value:function(e,t){return e&&this.entities.get(e,t)||null}},{key:"removeFromCacheAndSession",value:function(e,t,r){this.entities.remove(t),this.services.config.sessionStorageEnabled&&this.services.storage.remove(e,t,r)}},{key:"document",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s,a,o=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(r=L(t),n=void 0,"create_new"!==r.mode){e.next=10;break}return e.next=7,this._createDocument(r.id,r.data,r.ttl);case 7:n=e.sent,e.next=40;break;case 10:if(!(s=this.getCached(r.id,C.SyncDocument.type))){e.next=15;break}return e.abrupt("return",new C.SyncDocument(s));case 15:return e.prev=15,e.next=18,this._getDocument(r.id);case 18:n=e.sent,e.next=40;break;case 21:if(e.prev=21,e.t0=e.catch(15),404===e.t0.status&&"open_existing"!==r.mode){e.next=27;break}throw e.t0;case 27:return e.prev=27,e.next=30,this._createDocument(r.id,r.data,r.ttl);case 30:n=e.sent,e.next=40;break;case 33:if(e.prev=33,e.t1=e.catch(27),409!==e.t1.status){e.next=39;break}return e.abrupt("return",this.document(t));case 39:throw e.t1;case 40:return this.storeRootInSessionCache(C.SyncDocument.type,r.id,n),a=new C.SyncDocumentImpl(this.services,n,function(e,t,r){return o.removeFromCacheAndSession(e,t,r)}),a=this.entities.store(a),e.abrupt("return",new C.SyncDocument(a));case 44:case"end":return e.stop()}},e,this,[[15,21],[27,33]])}));return function(t){return e.apply(this,arguments)}}()},{key:"map",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s,a,o=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(r=L(t),n=void 0,"create_new"!==r.mode){e.next=10;break}return e.next=7,this._createMap(r.id,r.ttl);case 7:n=e.sent,e.next=40;break;case 10:if(!(s=this.getCached(r.id,S.SyncMap.type))){e.next=15;break}return e.abrupt("return",new S.SyncMap(s));case 15:return e.prev=15,e.next=18,this._getMap(r.id,r.includeItems);case 18:n=e.sent,e.next=40;break;case 21:if(e.prev=21,e.t0=e.catch(15),404===e.t0.status&&"open_existing"!==r.mode){e.next=27;break}throw e.t0;case 27:return e.prev=27,e.next=30,this._createMap(r.id,r.ttl);case 30:n=e.sent,e.next=40;break;case 33:if(e.prev=33,e.t1=e.catch(27),409!==e.t1.status){e.next=39;break}return e.abrupt("return",this.map(t));case 39:throw e.t1;case 40:return this.storeRootInSessionCache(S.SyncMap.type,r.id,n),a=new S.SyncMapImpl(this.services,n,function(e,t,r){return o.removeFromCacheAndSession(e,t,r)}),a=this.entities.store(a),e.abrupt("return",new S.SyncMap(a));case 44:case"end":return e.stop()}},e,this,[[15,21],[27,33]])}));return function(t){return e.apply(this,arguments)}}()},{key:"list",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s,a,o=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(r=L(t),n=void 0,"create_new"!==r.mode){e.next=10;break}return e.next=7,this._createList(r.id,r.purpose,r.context,r.ttl);case 7:n=e.sent,e.next=40;break;case 10:if(!(s=this.getCached(r.id,j.SyncList.type))){e.next=15;break}return e.abrupt("return",new j.SyncList(s));case 15:return e.prev=15,e.next=18,this._getList(r.id);case 18:n=e.sent,e.next=40;break;case 21:if(e.prev=21,e.t0=e.catch(15),404===e.t0.status&&"open_existing"!==r.mode){e.next=27;break}throw e.t0;case 27:return e.prev=27,e.next=30,this._createList(r.id,r.purpose,r.context,r.ttl);case 30:n=e.sent,e.next=40;break;case 33:if(e.prev=33,e.t1=e.catch(27),409!==e.t1.status){e.next=39;break}return e.abrupt("return",this.list(t));case 39:throw e.t1;case 40:return this.storeRootInSessionCache(j.SyncList.type,r.id,n),a=new j.SyncListImpl(this.services,n,function(e,t,r){return o.removeFromCacheAndSession(e,t,r)}),a=this.entities.store(a),e.abrupt("return",new j.SyncList(a));case 44:case"end":return e.stop()}},e,this,[[15,21],[27,33]])}));return function(t){return e.apply(this,arguments)}}()},{key:"stream",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s,a,o,u=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(r=L(t),n=void 0,"create_new"!==r.mode){e.next=10;break}return e.next=7,this._createStream(r.id,r.ttl);case 7:n=e.sent,e.next=40;break;case 10:if(!(s=this.getCached(r.id,I.SyncStream.type))){e.next=15;break}return e.abrupt("return",new I.SyncStream(s));case 15:return e.prev=15,e.next=18,this._getStream(r.id);case 18:n=e.sent,e.next=40;break;case 21:if(e.prev=21,e.t0=e.catch(15),404===e.t0.status&&"open_existing"!==r.mode){e.next=27;break}throw e.t0;case 27:return e.prev=27,e.next=30,this._createStream(r.id,r.ttl);case 30:n=e.sent,e.next=40;break;case 33:if(e.prev=33,e.t1=e.catch(27),409!==e.t1.status){e.next=39;break}return e.abrupt("return",this.stream(t));case 39:throw e.t1;case 40:return this.storeRootInSessionCache(I.SyncStream.type,r.id,n),a=function(e,t,r){return u.removeFromCacheAndSession(e,t,r)},o=new I.SyncStreamImpl(this.services,n,a),o=this.entities.store(o),e.abrupt("return",new I.SyncStream(o));case 45:case"end":return e.stop()}},e,this,[[15,21],[27,33]])}));return function(t){return e.apply(this,arguments)}}()},{key:"shutdown",value:function(){var e=(0,s.default)(i.default.mark(function e(){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.subscriptions.shutdown();case 2:return e.next=4,this.services.twilsock.disconnect();case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"updateToken",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",n.default.reject(new Error("A valid Twilio token should be provided")));case 2:return e.abrupt("return",this.services.twilsock.updateToken(t).catch(function(e){var t,r=null===(t=null==e?void 0:e.reply)||void 0===t?void 0:t.status;if(401===(null==r?void 0:r.code)&&"UNAUTHORIZED"===(null==r?void 0:r.status))throw new v.SyncError("Updated token was rejected by server",400,51130);throw e}));case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"liveQuery",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var n,s,a,o,u,c=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(t&&"string"==typeof t){e.next=4;break}throw new Error("Index name must contain a non-empty string value");case 4:return n=new m.UriBuilder(this.services.config.insightsUri).pathSegment(t).pathSegment("Items").build(),e.next=7,P.queryItems({network:this.services.network,uri:n,queryString:r,type:R.LiveQuery.type});case 7:return s=e.sent,(a=this.getCached(s.query_id,R.LiveQuery.type))||((o=this._getLiveQuery(s.query_id))||(o={indexName:t,queryExpression:r,sid:s.query_id,queryUri:n,last_event_id:s.last_event_id}),u=function(e,t,r){return c.removeFromCacheAndSession(e,t,r)},a=new R.LiveQueryImpl(o,this.services,u,s.items)),this.storeRootInSessionCache(R.LiveQuery.type,s.query_id,a.liveQueryDescriptor),a=this.entities.store(a),e.abrupt("return",new R.LiveQuery(a));case 13:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"instantQuery",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s=this;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return r=function(e,t){return s.liveQuery(e,t)},n=new R.InstantQuery({indexName:t,network:this.services.network,insightsUri:this.services.config.insightsUri,liveQueryCreator:r}),e.abrupt("return",n);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"connectionState",get:function(){return this.services.notifications.connectionState}}],[{key:"version",get:function(){return N}}]),t}(p.EventEmitter);r.Client=U,r.SyncClient=U,r.default=U},{"../package.json":261,"./clientInfo":237,"./configuration":239,"./entitiesCache":240,"./livequery":244,"./router":248,"./services/network":249,"./services/storage":250,"./streams/syncstream":251,"./subscriptions":252,"./syncdocument":253,"./synclist":254,"./syncmap":255,"./utils/logger":256,"./utils/sanitize":257,"./utils/syncerror":258,"./utils/uri":260,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201,"twilio-notifications":229,twilsock:270}],237:[function(e,t,r){"use strict";var n,i=e("babel-runtime/helpers/classCallCheck"),s=(n=i)&&n.__esModule?n:{default:n};Object.defineProperty(r,"__esModule",{value:!0});var a=e("platform"),o=function e(t){(0,s.default)(this,e),this.sdk="js",this.sdkVer=t,this.os=a.os.family,this.osVer=a.os.version,this.pl=a.name,this.plVer=a.version};r.ClientInfo=o,r.default=o},{"babel-runtime/helpers/classCallCheck":47,platform:208}],238:[function(e,t,r){"use strict";var n=u(e("babel-runtime/core-js/object/get-prototype-of")),i=u(e("babel-runtime/helpers/classCallCheck")),s=u(e("babel-runtime/helpers/createClass")),a=u(e("babel-runtime/helpers/possibleConstructorReturn")),o=u(e("babel-runtime/helpers/inherits"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var c=e("events"),l=e("uuid"),d=function(e){function t(){(0,i.default)(this,t);var e=(0,a.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return e.closed=!1,e.uuid=l(),e}return(0,o.default)(t,e),(0,s.default)(t,[{key:"close",value:function(){this.removeAllListeners(),this.closed=!0}},{key:"ensureNotClosed",value:function(){if(this.closed)throw new Error("Invalid operation on closed object")}},{key:"listenerUuid",get:function(){return this.uuid}}]),t}(c.EventEmitter);r.Closeable=d,r.default=d},{"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201,uuid:291}],239:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a="/v4/Subscriptions",o="/v3/Maps",u="/v3/Lists",c="/v3/Documents",l="/v3/Streams",d="/v3/Insights";var f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,n.default)(this,e);var r,i,s,f="https://cds."+(t.region||"us1")+".twilio.com",p=t.cdsUri||f;this.settings={subscriptionsUri:p+a,documentsUri:p+c,listsUri:p+u,mapsUri:p+o,streamsUri:p+l,insightsUri:p+d,sessionStorageEnabled:(r=t.Sync,i="enableSessionStorage",s=!0,r&&void 0!==r[i]?r[i]:s),productId:t.productId}}return(0,i.default)(e,[{key:"subscriptionsUri",get:function(){return this.settings.subscriptionsUri}},{key:"documentsUri",get:function(){return this.settings.documentsUri}},{key:"listsUri",get:function(){return this.settings.listsUri}},{key:"mapsUri",get:function(){return this.settings.mapsUri}},{key:"streamsUri",get:function(){return this.settings.streamsUri}},{key:"insightsUri",get:function(){return this.settings.insightsUri}},{key:"backoffConfig",get:function(){return this.settings.backoffConfig||{}}},{key:"sessionStorageEnabled",get:function(){return this.settings.sessionStorageEnabled}},{key:"productId",get:function(){return this.settings.productId}}]),e}();r.Configuration=f},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],240:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/map")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(){(0,i.default)(this,e),this.names=new n.default,this.entities=new n.default}return(0,s.default)(e,[{key:"store",value:function(e){var t=this.entities.get(e.sid);return t||(this.entities.set(e.sid,e),e.uniqueName&&this.names.set(e.type+"::"+e.uniqueName,e.sid),e)}},{key:"getResolved",value:function(e,t){var r=this.names.get(t+"::"+e);return r?this.entities.get(r):null}},{key:"get",value:function(e,t){return this.entities.get(e)||this.getResolved(e,t)||null}},{key:"remove",value:function(e){var t=this.entities.get(e);t&&(this.entities.delete(e),t.uniqueName&&this.names.delete(t.type+"::"+t.uniqueName))}}]),e}();r.EntitiesCache=o},{"babel-runtime/core-js/map":30,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],241:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/get-iterator")),i=o(e("babel-runtime/core-js/map")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(){function e(t,r){(0,s.default)(this,e),this.services=t,this.removalHandler=r,this.subscriptionState="none",this._attachedListeners=new i.default}return(0,a.default)(e,[{key:"_advanceLastEventId",value:function(e,t){}},{key:"reportFailure",value:function(e){404===e.status?this.onRemoved(!1):this.broadcastEventToListeners("failure",e)}},{key:"_subscribe",value:function(){this.services.router.subscribe(this.sid,this)}},{key:"_unsubscribe",value:function(){this.services.router.unsubscribe(this.sid)}},{key:"_setSubscriptionState",value:function(e){this.subscriptionState=e,this.broadcastEventToListeners("_subscriptionStateChanged",e)}},{key:"close",value:function(){this._unsubscribe(),null!=this.removalHandler&&this.removalHandler(this.type,this.sid,this.uniqueName)}},{key:"attach",value:function(e){var t=e.listenerUuid;this._attachedListeners.get(t)||(this._attachedListeners.size||this._subscribe(),this._attachedListeners.set(t,e))}},{key:"detach",value:function(e){this._attachedListeners.delete(e),this._attachedListeners.size||this.close()}},{key:"broadcastEventToListeners",value:function(e,t){var r=!0,i=!1,s=void 0;try{for(var a,o=(0,n.default)(this._attachedListeners.values());!(r=(a=o.next()).done);r=!0){a.value.emit(e,t)}}catch(e){i=!0,s=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw s}}}}]),e}();r.SyncEntity=u,r.default=u},{"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/map":30,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],242:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./client");r.SyncClient=n.SyncClient;var i=e("./syncdocument");r.SyncDocument=i.SyncDocument;var s=e("./synclist");r.SyncList=s.SyncList;var a=e("./listitem");r.SyncListItem=a.ListItem;var o=e("./syncmap");r.SyncMap=o.SyncMap;var u=e("./mapitem");r.SyncMapItem=u.MapItem,r.default=n.SyncClient,t.exports=n.SyncClient,t.exports.SyncClient=n.SyncClient},{"./client":236,"./listitem":243,"./mapitem":245,"./syncdocument":253,"./synclist":254,"./syncmap":255}],243:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(t){(0,n.default)(this,e),this.descriptor=t}return(0,i.default)(e,[{key:"update",value:function(e,t,r,n){return this.descriptor.lastEventId=e,this.descriptor.revision=t,this.descriptor.data=r,this.descriptor.dateUpdated=n,this}},{key:"updateDateExpires",value:function(e){this.descriptor.dateExpires=e}},{key:"uri",get:function(){return this.descriptor.uri}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.lastEventId}},{key:"dateUpdated",get:function(){return this.descriptor.dateUpdated}},{key:"dateExpires",get:function(){return this.descriptor.dateExpires}},{key:"index",get:function(){return this.descriptor.index}},{key:"data",get:function(){return this.descriptor.data}}]),e}();r.ListItem=a,r.default=a},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],244:[function(e,t,r){"use strict";var n,i=b(e("babel-runtime/core-js/promise")),s=b(e("babel-runtime/core-js/object/assign")),a=b(e("babel-runtime/helpers/get")),o=b(e("babel-runtime/regenerator")),u=b(e("babel-runtime/helpers/asyncToGenerator")),c=b(e("babel-runtime/core-js/object/get-prototype-of")),l=b(e("babel-runtime/helpers/createClass")),d=b(e("babel-runtime/helpers/possibleConstructorReturn")),f=b(e("babel-runtime/helpers/inherits")),p=b(e("babel-runtime/helpers/classCallCheck")),h=(n=(0,u.default)(o.default.mark(function e(t){var r,n,i,s,a,u;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.network,n=t.queryString,i=t.uri,s=t.type,null!=n){e.next=3;break}throw new v.SyncError("Invalid query",400,54507);case 3:return a={query_string:n},s===C.type&&(a.type=s),e.next=7,r.post(i,a,void 0,!0);case 7:return u=e.sent,e.abrupt("return",u.body);case 9:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)});function b(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var m=e("./utils/uri"),v=e("./utils/syncerror"),y=e("./utils/logger"),g=e("events"),_=e("./entity"),k=e("./closeable"),w=e("./cache");r.InsightsItem=function e(){(0,p.default)(this,e)};var x=function(e){function t(e,r,n,i){(0,p.default)(this,t);var s=(0,d.default)(this,(t.__proto__||(0,c.default)(t)).call(this,r,n));return s.descriptor=e,s.cache=new w.Cache,i&&i.forEach(function(e){s.cache.store(e.key,{key:e.key,value:e.data},e.revision)}),s}return(0,f.default)(t,e),(0,l.default)(t,[{key:"onRemoved",value:function(){}},{key:"getItems",value:function(){var e={};return this.cache.forEach(function(t,r){e[t]=r.value}),e}},{key:"_update",value:function(e,t){switch(e.type){case"live_query_item_updated":this.handleItemMutated(e.item_key,e.item_data,e.item_revision);break;case"live_query_item_removed":this.handleItemRemoved(e.item_key,e.item_revision);break;case"live_query_updated":this.handleBatchUpdate(e.items)}t&&this._advanceLastEventId(e.last_event_id)}},{key:"handleItemMutated",value:function(e,t,r){if(this.shouldIgnoreEvent(e,r))y.default.trace("Item "+e+" update skipped, revision: "+r);else{var n={key:e,value:t};this.cache.store(e,n,r),this.broadcastEventToListeners("itemUpdated",n)}}},{key:"handleItemRemoved",value:function(e,t){var r=null===t;this.shouldIgnoreEvent(e,t)?y.default.trace("Item "+e+" delete skipped, revision: "+t):(this.cache.delete(e,t,r),this.broadcastEventToListeners("itemRemoved",{key:e}))}},{key:"handleBatchUpdate",value:function(e){var t=this,r={};for(var n in null!=e&&e.forEach(function(e){r[e.key]={data:e.data,revision:e.revision}}),this.cache.forEach(function(e,n){var i=r[e];null!=i?t.handleItemMutated(e,i.data,i.revision):t.handleItemRemoved(e,null),delete r[e]}),r)this.handleItemMutated(n,r[n].data,r[n].revision)}},{key:"shouldIgnoreEvent",value:function(e,t){return null!=e&&null!=t&&this.cache.isKnown(e,t)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e)}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return null}},{key:"type",get:function(){return t.type}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"indexName",get:function(){return this.descriptor.indexName}},{key:"queryString",get:function(){return this.descriptor.queryExpression}},{key:"queryUri",get:function(){return this.descriptor.queryUri}},{key:"liveQueryDescriptor",get:function(){return this.descriptor}}],[{key:"type",get:function(){return"live_query"}}]),t}(_.SyncEntity);r.LiveQueryImpl=x,r.queryItems=h;var C=function(e){function t(e){(0,p.default)(this,t);var r=(0,d.default)(this,(t.__proto__||(0,c.default)(t)).call(this));return r.liveQueryImpl=e,r.liveQueryImpl.attach(r),r}return(0,f.default)(t,e),(0,l.default)(t,[{key:"close",value:function(){(0,a.default)(t.prototype.__proto__||(0,c.default)(t.prototype),"close",this).call(this),this.liveQueryImpl.detach(this.listenerUuid)}},{key:"getItems",value:function(){return this.ensureNotClosed(),this.liveQueryImpl.getItems()}},{key:"type",get:function(){return x.type}},{key:"lastEventId",get:function(){return this.liveQueryImpl.lastEventId}},{key:"sid",get:function(){return this.liveQueryImpl.sid}}],[{key:"type",get:function(){return x.type}}]),t}(k.Closeable);r.LiveQuery=C;var j=function(e){function t(e){(0,p.default)(this,t);var r=(0,d.default)(this,(t.__proto__||(0,c.default)(t)).call(this));return r.queryExpression=null,r.items={},(0,s.default)(r,e),r.updateIndexName(e.indexName),r}return(0,f.default)(t,e),(0,l.default)(t,[{key:"search",value:function(){var e=(0,u.default)(o.default.mark(function e(t){var r=this;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.items={},e.abrupt("return",h({network:this.network,uri:this.queryUri,queryString:t}).then(function(e){r.queryExpression=t,e.items&&e.items.forEach(function(e){r.items[e.key]=e.data}),r.emit("searchResult",r.getItems())}).catch(function(e){throw y.default.error("Error '"+e.message+"' while executing query '"+t+"'"),r.queryExpression=null,e}));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"subscribe",value:function(){var e=(0,u.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.queryExpression){e.next=2;break}return e.abrupt("return",i.default.reject(new v.SyncError("Invalid query",400,54507)));case 2:return e.abrupt("return",this.liveQueryCreator(this.indexName,this.queryExpression));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getItems",value:function(){return this.items}},{key:"updateIndexName",value:function(e){if(!e||"string"!=typeof e)throw new Error("Index name must contain a non-empty string value");this.indexName=e,this.queryUri=this.generateQueryUri(this.indexName)}},{key:"generateQueryUri",value:function(e){return new m.UriBuilder(this.insightsUri).pathSegment(e).pathSegment("Items").build()}},{key:"type",get:function(){return t.type}}],[{key:"type",get:function(){return"instant_query"}}]),t}(g.EventEmitter);r.InstantQuery=j,r.default=C},{"./cache":235,"./closeable":238,"./entity":241,"./utils/logger":256,"./utils/syncerror":258,"./utils/uri":260,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201}],245:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(t){(0,n.default)(this,e),this.descriptor=t}return(0,i.default)(e,[{key:"update",value:function(e,t,r,n){return this.descriptor.last_event_id=e,this.descriptor.revision=t,this.descriptor.data=r,this.descriptor.date_updated=n,this}},{key:"updateDateExpires",value:function(e){this.descriptor.date_expires=e}},{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"key",get:function(){return this.descriptor.key}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}}]),e}();r.MapItem=a},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],246:[function(e,t,r){"use strict";var n=c(e("babel-runtime/regenerator")),i=c(e("babel-runtime/helpers/asyncToGenerator")),s=c(e("babel-runtime/core-js/map")),a=c(e("babel-runtime/core-js/promise")),o=c(e("babel-runtime/helpers/classCallCheck")),u=c(e("babel-runtime/helpers/createClass"));function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var l=function(){function e(t){(0,o.default)(this,e),this.queuedRequests=[],this.isRequestInFlight=!1,this.inputMergingFunction=t}return(0,u.default)(e,[{key:"add",value:function(e,t){var r=this,n=new a.default(function(n,i){return r.queuedRequests.push({input:e,requestFunction:t,resolve:n,reject:i})});return this.wakeupQueue(),n}},{key:"squashAndAdd",value:function(e,t){var r=this.queuedRequests;this.queuedRequests=[];var n=void 0;r.length>0?(n=r.map(function(e){return e.input}).reduce(this.inputMergingFunction),n=this.inputMergingFunction(n,e)):n=e;var i=this.add(n,t);return r.forEach(function(e){return i.then(e.resolve,e.reject)}),i}},{key:"isEmpty",value:function(){return 0===this.queuedRequests.length&&!this.isRequestInFlight}},{key:"wakeupQueue",value:function(){var e=this;if(0!==this.queuedRequests.length&&!this.isRequestInFlight){var t=this.queuedRequests.shift();this.isRequestInFlight=!0,t.requestFunction(t.input).then(t.resolve,t.reject).then(function(t){e.isRequestInFlight=!1,e.wakeupQueue()})}}}]),e}();r.MergingQueue=l;var d=function(){function e(t){(0,o.default)(this,e),this.queueByNamespaceKey=new s.default,this.inputReducer=t}return(0,u.default)(e,[{key:"add",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r,i){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,function(e){return e.add(r,i)}));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"squashAndAdd",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r,i){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,function(e){return e.squashAndAdd(r,i)}));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"invokeQueueMethod",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r){var i,s;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.queueByNamespaceKey.has(t)||this.queueByNamespaceKey.set(t,new l(this.inputReducer)),i=this.queueByNamespaceKey.get(t),s=r(i),this.queueByNamespaceKey.get(t).isEmpty()&&this.queueByNamespaceKey.delete(t),e.abrupt("return",s);case 5:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()}]),e}();r.NamespacedMergingQueue=d},{"babel-runtime/core-js/map":30,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],247:[function(e,t,r){"use strict";var n=o(e("babel-runtime/regenerator")),i=o(e("babel-runtime/helpers/asyncToGenerator")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(){function e(t,r,n,i){(0,s.default)(this,e),this.prevToken=n,this.nextToken=i,this.items=t,this.source=r}return(0,a.default)(e,[{key:"nextPage",value:function(){var e=(0,i.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasNextPage){e.next=2;break}throw new Error("No next page");case 2:return e.abrupt("return",this.source(this.nextToken));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"prevPage",value:function(){var e=(0,i.default)(n.default.mark(function e(){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPrevPage){e.next=2;break}throw new Error("No previous page");case 2:return e.abrupt("return",this.source(this.prevToken));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"hasNextPage",get:function(){return!!this.nextToken}},{key:"hasPrevPage",get:function(){return!!this.prevToken}}]),e}();r.Paginator=u},{"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],248:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=e("./utils/logger"),o="com.twilio.rtd.cds.document",u="com.twilio.rtd.cds.list",c="com.twilio.rtd.cds.map",l="twilio.sync.event",d=function(){function e(t){var r=this;(0,n.default)(this,e),this.config=t.config,this.subscriptions=t.subscriptions,this.notifications=t.notifications,this.notifications.subscribe(l),this.notifications.subscribe(o),this.notifications.subscribe(u),this.notifications.subscribe(c),this.notifications.on("message",function(e,t){return r.onMessage(e,t)}),this.notifications.on("transportReady",function(e){return r.onConnectionStateChanged(e)})}return(0,i.default)(e,[{key:"onMessage",value:function(e,t){switch(a.default.trace("Notification type:",e,"content:",t),e){case o:case u:case c:this.subscriptions.acceptMessage(t,!1);break;case l:this.subscriptions.acceptMessage(t,!0)}}},{key:"subscribe",value:function(e,t){this.subscriptions.add(e,t)}},{key:"unsubscribe",value:function(e){this.subscriptions.remove(e)}},{key:"onConnectionStateChanged",value:function(e){this.subscriptions.onConnectionStateChanged(e)}}]),e}();r.Router=d,r.default=d},{"./utils/logger":256,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],249:[function(e,t,r){"use strict";var n=u(e("babel-runtime/core-js/promise")),i=u(e("babel-runtime/core-js/object/assign")),s=u(e("babel-runtime/core-js/json/stringify")),a=u(e("babel-runtime/helpers/classCallCheck")),o=u(e("babel-runtime/helpers/createClass"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var c=e("uuid"),l=e("../utils/syncerror"),d=e("../utils/logger"),f=e("operation-retrier"),p=e("twilsock");function h(e){if(e.body&&e.body.message)return e.body.message;switch(e.status){case 429:return"Throttled by server";case 404:return"Not found from server";default:return"Error from server"}}function b(e){return e.body?e.body.code:0}function m(e){return 409===e.status?new l.SyncNetworkError(h(e),e.status,b(e),e.body):e.status?new l.SyncError(h(e),e.status,b(e)):e instanceof p.TransportUnavailableError?e:new l.SyncError(e.message,0,0)}var v=function(){function e(t,r,n){(0,a.default)(this,e),this.clientInfo=t,this.config=r,this.transport=n}return(0,o.default)(e,[{key:"createHeaders",value:function(){return{"Content-Type":"application/json","Twilio-Sync-Client-Info":(0,s.default)(this.clientInfo),"Twilio-Request-Id":"RQ"+c.v4().replace(/-/g,"")}}},{key:"backoffConfig",value:function(){return(0,i.default)({min:4e3,max:6e4,maxAttemptsTime:9e4,randomness:.2},this.config.backoffConfig)}},{key:"executeWithRetry",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return new n.default(function(n,i){var s=[502,503,504];r&&s.push(429);var a=new f.Retrier(t.backoffConfig());a.on("attempt",function(){e().then(function(e){return a.succeeded(e)}).catch(function(e){if(s.includes(e.status)){var t=parseInt(e.headers?e.headers["Retry-After"]:null);a.failed(m(e),isNaN(t)?null:1e3*t)}else"Twilsock disconnected"===e.message?a.failed(m(e)):(a.removeAllListeners(),a.cancel(),i(m(e)))})}),a.on("succeeded",function(e){n(e)}),a.on("cancelled",function(e){return i(m(e))}),a.on("failed",function(e){return i(m(e))}),a.start()})}},{key:"get",value:function(e){var t=this,r=this.createHeaders();return d.default.debug("GET",e,"ID:",r["Twilio-Request-Id"]),this.executeWithRetry(function(){return t.transport.get(e,r,t.config.productId)},!0)}},{key:"post",value:function(e,t,r){var n=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=this.createHeaders();return null!=r&&(s["If-Match"]=r),d.default.debug("POST",e,"ID:",s["Twilio-Request-Id"]),this.executeWithRetry(function(){return n.transport.post(e,s,t,n.config.productId)},i)}},{key:"put",value:function(e,t,r){var n=this,i=this.createHeaders();return null!=r&&(i["If-Match"]=r),d.default.debug("PUT",e,"ID:",i["Twilio-Request-Id"]),this.executeWithRetry(function(){return n.transport.put(e,i,t,n.config.productId)},!1)}},{key:"delete",value:function(e){var t=this,r=this.createHeaders();return d.default.debug("DELETE",e,"ID:",r["Twilio-Request-Id"]),this.executeWithRetry(function(){return t.transport.delete(e,r,t.config.productId)},!1)}}]),e}();r.NetworkService=v},{"../utils/logger":256,"../utils/syncerror":258,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"operation-retrier":206,twilsock:270,uuid:291}],250:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/assign")),i=o(e("babel-runtime/core-js/json/stringify")),s=o(e("babel-runtime/helpers/classCallCheck")),a=o(e("babel-runtime/helpers/createClass"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(){function e(t,r){(0,s.default)(this,e),this.config=t,this.storageId=null;try{this.storage=r||sessionStorage}catch(e){}}return(0,a.default)(e,[{key:"storageKey",value:function(e,t){return this.storageId+"::"+e+"::"+t}},{key:"updateStorageId",value:function(e){this.storageId=e}},{key:"store",value:function(e,t,r){return this.isReady?this._store(this.storageKey(e,t),r):null}},{key:"read",value:function(e,t){return this.isReady?this._read(this.storageKey(e,t)):null}},{key:"remove",value:function(e,t,r){if(!this.isReady)return null;try{this.storage.removeItem(this.storageKey(e,t)),r&&this.storage.removeItem(this.storageKey(e,r))}catch(e){}}},{key:"update",value:function(e,t,r,n){if(!this.isReady)return null;this._apply(this.storageKey(e,t),n),r&&this._apply(this.storageKey(e,r),n)}},{key:"_store",value:function(e,t){try{this.storage.setItem(e,(0,i.default)(t))}catch(e){}}},{key:"_read",value:function(e){try{var t=this.storage.getItem(e);if(t)return JSON.parse(t)}catch(e){}return null}},{key:"_apply",value:function(e,t){var r=this._read(e);if(!r)return!1;this._store(e,(0,n.default)(r,t))}},{key:"isReady",get:function(){return this.config.sessionStorageEnabled&&!!this.storageId}}]),e}();r.SessionStorage=u},{"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/assign":32,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],251:[function(e,t,r){"use strict";var n=d(e("babel-runtime/helpers/get")),i=d(e("babel-runtime/regenerator")),s=d(e("babel-runtime/helpers/asyncToGenerator")),a=d(e("babel-runtime/core-js/object/get-prototype-of")),o=d(e("babel-runtime/helpers/classCallCheck")),u=d(e("babel-runtime/helpers/createClass")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var f=e("../entity"),p=e("../utils/sanitize"),h=e("../closeable"),b=function(e){function t(e,r,n){(0,o.default)(this,t);var i=(0,c.default)(this,(t.__proto__||(0,a.default)(t)).call(this,e,n));return i.descriptor=r,i}return(0,l.default)(t,e),(0,u.default)(t,[{key:"publishMessage",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n,s,a;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={data:t},e.next=3,this.services.network.post(this.links.messages,r);case 3:return n=e.sent,s=n.body,a=this._handleMessagePublished(s.sid,t,!1),e.abrupt("return",a);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r,n;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.validateMandatoryTtl(t),e.prev=1,r={ttl:t},e.next=5,this.services.network.post(this.uri,r);case 5:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}},e,this,[[1,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"removeStream",value:function(){var e=(0,s.default)(i.default.mark(function e(){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_update",value:function(e){switch(e.type){case"stream_message_published":this._handleMessagePublished(e.message_sid,e.message_data,!0);break;case"stream_removed":this.onRemoved(!1)}}},{key:"_handleMessagePublished",value:function(e,t,r){var n={sid:e,value:t};return this.broadcastEventToListeners("messagePublished",{message:n,isLocal:!r}),n}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"stream"}},{key:"lastEventId",get:function(){return null}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}}],[{key:"type",get:function(){return"stream"}}]),t}(f.SyncEntity);r.SyncStreamImpl=b;var m=function(e){function t(e){(0,o.default)(this,t);var r=(0,c.default)(this,(t.__proto__||(0,a.default)(t)).call(this));return r.syncStreamImpl=e,r.syncStreamImpl.attach(r),r}return(0,l.default)(t,e),(0,u.default)(t,[{key:"publishMessage",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.publishMessage(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"removeStream",value:function(){var e=(0,s.default)(i.default.mark(function e(){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.removeStream());case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){(0,n.default)(t.prototype.__proto__||(0,a.default)(t.prototype),"close",this).call(this),this.syncStreamImpl.detach(this.listenerUuid)}},{key:"uri",get:function(){return this.syncStreamImpl.uri}},{key:"links",get:function(){return this.syncStreamImpl.links}},{key:"dateExpires",get:function(){return this.syncStreamImpl.dateExpires}},{key:"type",get:function(){return b.type}},{key:"lastEventId",get:function(){return null}},{key:"sid",get:function(){return this.syncStreamImpl.sid}},{key:"uniqueName",get:function(){return this.syncStreamImpl.uniqueName}}],[{key:"type",get:function(){return b.type}}]),t}(h.default);r.SyncStream=m,r.default=m},{"../closeable":238,"../entity":241,"../utils/sanitize":257,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55}],252:[function(e,t,r){"use strict";var n=d(e("babel-runtime/regenerator")),i=d(e("babel-runtime/helpers/asyncToGenerator")),s=d(e("babel-runtime/core-js/get-iterator")),a=d(e("babel-runtime/helpers/slicedToArray")),o=d(e("babel-runtime/core-js/object/assign")),u=d(e("babel-runtime/core-js/map")),c=d(e("babel-runtime/helpers/classCallCheck")),l=d(e("babel-runtime/helpers/createClass"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var f=e("operation-retrier"),p=e("./utils/syncerror"),h=e("./utils/logger"),b=e("twilsock"),m=function(){function e(t){(0,c.default)(this,e),this.localObject=t,this.pendingCorrelationId=null,this.pendingAction=null,this.established=!1,this.retryCount=0}return(0,l.default)(e,[{key:"update",value:function(e,t){this.localObject._update(e,t)}},{key:"updatePending",value:function(e,t){this.pendingAction=e,this.pendingCorrelationId=t}},{key:"reset",value:function(){this.updatePending(null,null),this.retryCount=0,this.established=!1,this.setSubscriptionState("none")}},{key:"markAsFailed",value:function(e){this.rejectedWithError=e.error,this.updatePending(null,null),this.localObject.reportFailure(new p.SyncError("Failed to subscribe on service events: "+e.error.message,e.error.status,e.error.code))}},{key:"complete",value:function(e){this.updatePending(null,null),this.established=!0,this.localObject._advanceLastEventId(e)}},{key:"setSubscriptionState",value:function(e){this.localObject._setSubscriptionState(e)}},{key:"sid",get:function(){return this.localObject.sid}},{key:"type",get:function(){return this.localObject.type}},{key:"lastEventId",get:function(){return this.localObject.lastEventId}},{key:"indexName",get:function(){return this.localObject.indexName}},{key:"queryString",get:function(){return this.localObject.queryString}},{key:"isEstablished",get:function(){return this.established}}]),e}(),v=function(){function e(t){var r=this;(0,c.default)(this,e),this.isConnected=!1,this.maxBatchSize=100,this.subscriptionTtlTimer=null,this.pendingPokeReason=null,this.services=t,this.subscriptions=new u.default,this.persisted=new u.default,this.latestPokeResponseArrivalTimestampByCorrelationId=new u.default;this.backoff=f.Backoff.exponential((0,o.default)({randomisationFactor:.2,initialDelay:100,maxDelay:12e4},this.services.config.backoffConfig)),this.backoff.on("ready",function(){var e=r.getSubscriptionUpdateBatch(),t=e.action,n=e.subscriptions;t?r.applyNewSubscriptionUpdateBatch(t,n):(r.backoff.reset(),h.default.debug("All subscriptions resolved."))})}return(0,l.default)(e,[{key:"getSubscriptionUpdateBatch",value:function(){function e(e,t,r,n){var i=[],o=!0,u=!1,c=void 0;try{for(var l,d=(0,s.default)(e);!(o=(l=d.next()).done);o=!0){var f=l.value,p=(0,a.default)(f,2),h=p[0],b=p[1];if(!t.get(h)&&r!==b.pendingAction&&!b.rejectedWithError&&(i.push(b),n&&i.length>=n))break}}catch(e){u=!0,c=e}finally{try{!o&&d.return&&d.return()}finally{if(u)throw c}}return i}var t=e(this.subscriptions,this.persisted,"establish",this.maxBatchSize);if(t.length>0)return{action:"establish",subscriptions:t};var r=e(this.persisted,this.subscriptions,"cancel",this.maxBatchSize);return r.length>0?{action:"cancel",subscriptions:r}:{action:null,subscriptions:null}}},{key:"persist",value:function(){this.backoff.backoff()}},{key:"applyNewSubscriptionUpdateBatch",value:function(){var e=(0,i.default)(n.default.mark(function e(t,r){var i,a,o,u,c,l,d,f,p,m,v,y,g,_,k,w,x,C,j,S,T=this;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isConnected){e.next=4;break}return h.default.debug("Twilsock connection (required for subscription) not ready; waiting\u2026"),this.backoff.reset(),e.abrupt("return");case 4:for(r=this.processLocalActions(t,r),i=(new Date).getTime(),a=!0,o=!1,u=void 0,e.prev=9,c=(0,s.default)(r);!(a=(l=c.next()).done);a=!0)d=l.value,this.recordActionAttemptOn(d,t,i);e.next=17;break;case 13:e.prev=13,e.t0=e.catch(9),o=!0,u=e.t0;case 17:e.prev=17,e.prev=18,!a&&c.return&&c.return();case 20:if(e.prev=20,!o){e.next=23;break}throw u;case 23:return e.finish(20);case 24:return e.finish(17);case 25:return f=this.pendingPokeReason,this.pendingPokeReason=null,e.prev=27,e.next=30,this.request(t,i,f,r);case 30:p=e.sent,m=p.body.max_batch_size,!isNaN(parseInt(m))&&isFinite(m)&&m>0&&(this.maxBatchSize=m),this.subscriptionTtlTimer||(v=p.body.ttl_in_s,y=!isNaN(parseFloat(v))&&isFinite(v),y&&v>0&&(this.subscriptionTtlTimer=setTimeout(function(){return T.onSubscriptionTtlElapsed()},1e3*v))),"establish"===t&&(g=p.body.estimated_delivery_in_ms,_=!isNaN(parseFloat(g))&&isFinite(g),_&&g>0?setTimeout(function(){return T.verifyPokeDelivery(i,g,r)},g):h.default.error("Invalid timeout: "+g),r.filter(function(e){return e.pendingCorrelationId===i}).forEach(function(e){return e.setSubscriptionState("response_in_flight")})),this.backoff.reset(),e.next=60;break;case 38:for(e.prev=38,e.t1=e.catch(27),k=!0,w=!1,x=void 0,e.prev=43,C=(0,s.default)(r);!(k=(j=C.next()).done);k=!0)S=j.value,this.recordActionFailureOn(S,t);e.next=51;break;case 47:e.prev=47,e.t2=e.catch(43),w=!0,x=e.t2;case 51:e.prev=51,e.prev=52,!k&&C.return&&C.return();case 54:if(e.prev=54,!w){e.next=57;break}throw x;case 57:return e.finish(54);case 58:return e.finish(51);case 59:e.t1 instanceof b.TransportUnavailableError?(h.default.debug("Twilsock connection (required for subscription) not ready (c:"+i+"); waiting\u2026"),this.backoff.reset()):(h.default.debug("Failed an attempt to "+t+" subscriptions (c:"+i+"); retrying",e.t1),this.persist());case 60:case"end":return e.stop()}},e,this,[[9,13,17,25],[18,,20,24],[27,38],[43,47,51,59],[52,,54,58]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"verifyPokeDelivery",value:function(e,t,r){var n=this,i=this.latestPokeResponseArrivalTimestampByCorrelationId.get(e),s=i?(new Date).getTime()-i:t;s>=t?(r.filter(function(t){return t.pendingCorrelationId===e}).forEach(function(e){e.updatePending(null,null),e.retryCount++,n.persisted.delete(e.sid)}),this.persist(),this.latestPokeResponseArrivalTimestampByCorrelationId.delete(e)):setTimeout(function(){return n.verifyPokeDelivery(e,t,r)},t-s)}},{key:"processLocalActions",value:function(e,t){return"cancel"===e?t.filter(function(e){return!e.rejectedWithError}):t}},{key:"recordActionAttemptOn",value:function(e,t,r){if(e.setSubscriptionState("request_in_flight"),"establish"===t)this.persisted.set(e.sid,e),e.updatePending(t,r);else{var n=this.persisted.get(e.sid);n&&n.updatePending(t,r)}}},{key:"recordActionFailureOn",value:function(e,t){e.setSubscriptionState("none"),e.updatePending(null,null),"establish"===t&&this.persisted.delete(e.sid)}},{key:"request",value:function(e,t,r,n){var i=n.map(function(t){return{object_sid:t.sid,object_type:t.type,last_event_id:"establish"===e?t.lastEventId:void 0,index_name:"establish"===e?t.indexName:void 0,query_string:"establish"===e?t.queryString:void 0}}),s=n.filter(function(e){return e.retryCount>0}).length;h.default.debug("Attempting '"+e+"' request (c:"+t+"):",i);var a={event_protocol_version:3,action:e,correlation_id:t,retried_requests:s,ttl_in_s:-1,requests:i};return"ttl"===r&&(a.reason=r),this.services.network.post(this.services.config.subscriptionsUri,a)}},{key:"add",value:function(e,t){h.default.debug("Establishing intent to subscribe to "+e);var r=this.subscriptions.get(e);r&&t&&r.lastEventId===t.lastEventId||(this.persisted.delete(e),this.subscriptions.set(e,new m(t)),this.persist())}},{key:"remove",value:function(e){h.default.debug("Establishing intent to unsubscribe from "+e),this.subscriptions.delete(e)&&this.persist()}},{key:"acceptMessage",value:function(e,t){h.default.trace("Subscriptions received",e),e.correlation_id&&this.latestPokeResponseArrivalTimestampByCorrelationId.set(e.correlation_id,(new Date).getTime());var r=void 0;switch(e.event_type){case"subscription_established":this.applySubscriptionEstablishedMessage(e.event,e.correlation_id);break;case"subscription_canceled":this.applySubscriptionCancelledMessage(e.event,e.correlation_id);break;case"subscription_failed":this.applySubscriptionFailedMessage(e.event,e.correlation_id);break;case(r=e.event_type.match(/^(?:map|list|document|stream|live_query)_/)||{}).input:var n=void 0;switch(r[0]){case"map_":n=e.event.map_sid;break;case"list_":n=e.event.list_sid;break;case"document_":n=e.event.document_sid;break;case"stream_":n=e.event.stream_sid;break;case"live_query_":n=e.event.query_id,t=!1,!0===e.strictly_ordered&&(t=!0);break;default:n=void 0}this.applyEventToSubscribedEntity(n,e,t);break;default:h.default.debug("Dropping unknown message type "+e.event_type)}}},{key:"applySubscriptionEstablishedMessage",value:function(e,t){var r=e.object_sid,n=this.persisted.get(e.object_sid);n&&n.pendingCorrelationId===t?"interrupted"===e.replay_status?(h.default.debug("Event Replay for subscription to "+r+" (c:"+t+") interrupted; continuing eagerly."),n.updatePending(null,null),this.persisted.delete(n.sid),this.backoff.reset()):"completed"===e.replay_status&&(h.default.debug("Event Replay for subscription to "+r+" (c:"+t+") completed. Subscription is ready."),n.complete(e.last_event_id),this.persisted.set(e.object_sid,n),n.setSubscriptionState("established"),this.backoff.reset()):h.default.debug("Late message for "+e.object_sid+" (c:"+t+") dropped."),this.persist()}},{key:"applySubscriptionCancelledMessage",value:function(e,t){var r=this.persisted.get(e.object_sid);r&&r.pendingCorrelationId===t?(r.updatePending(null,null),r.setSubscriptionState("none"),this.persisted.delete(e.object_sid)):h.default.debug("Late message for "+e.object_sid+" (c:"+t+") dropped."),this.persist()}},{key:"applySubscriptionFailedMessage",value:function(e,t){var r=e.object_sid,n=this.subscriptions.get(r),i=this.persisted.get(r);n&&i?i.pendingCorrelationId===t&&(h.default.error("Failed to subscribe on "+i.sid,e.error),i.markAsFailed(e),i.setSubscriptionState("none")):!n&&i&&(this.persisted.delete(r),i.setSubscriptionState("none")),this.persist()}},{key:"applyEventToSubscribedEntity",value:function(e,t,r){if(e){var n;r=r||(n=this.persisted.get(e))&&n.isEstablished;var i=this.subscriptions.get(e);i?(t.event.type=t.event_type,i.update(t.event,r)):h.default.debug("Message dropped for SID '"+e+"', for which there is no subscription.")}}},{key:"onConnectionStateChanged",value:function(e){this.isConnected=e,e&&this.poke("reconnect")}},{key:"onSubscriptionTtlElapsed",value:function(){this.isConnected&&this.poke("ttl")}},{key:"poke",value:function(e){h.default.debug("Triggering event replay for all subscriptions, reason="+e),this.pendingPokeReason=e,this.subscriptionTtlTimer&&(clearTimeout(this.subscriptionTtlTimer),this.subscriptionTtlTimer=null);var t=[],r=!0,n=!1,i=void 0;try{for(var a,o=(0,s.default)(this.persisted.values());!(r=(a=o.next()).done);r=!0){var u=a.value;u.reset(),u.rejectedWithError&&t.push(u)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}this.persisted.clear();var c=!0,l=!1,d=void 0;try{for(var f,p=(0,s.default)(t);!(c=(f=p.next()).done);c=!0){var b=f.value;this.persisted.set(b.sid,b)}}catch(e){l=!0,d=e}finally{try{!c&&p.return&&p.return()}finally{if(l)throw d}}this.persist()}},{key:"shutdown",value:function(){this.backoff.reset(),this.subscriptions.clear()}}]),e}();r.Subscriptions=v},{"./utils/logger":256,"./utils/syncerror":258,"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/assign":32,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/slicedToArray":52,"babel-runtime/regenerator":55,"operation-retrier":206,twilsock:270}],253:[function(e,t,r){"use strict";var n=p(e("babel-runtime/helpers/get")),i=p(e("babel-runtime/core-js/promise")),s=p(e("babel-runtime/core-js/object/assign")),a=p(e("babel-runtime/regenerator")),o=p(e("babel-runtime/helpers/asyncToGenerator")),u=p(e("babel-runtime/core-js/object/get-prototype-of")),c=p(e("babel-runtime/helpers/classCallCheck")),l=p(e("babel-runtime/helpers/createClass")),d=p(e("babel-runtime/helpers/possibleConstructorReturn")),f=p(e("babel-runtime/helpers/inherits"));function p(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var h=e("./utils/syncerror"),b=e("./utils/sanitize"),m=e("./utils/logger"),v=e("./entity"),y=e("./mergingqueue"),g=e("./closeable"),_=function(e){function t(e,r,n){(0,c.default)(this,t);var i=(0,d.default)(this,(t.__proto__||(0,u.default)(t)).call(this,e,n));i.isDeleted=!1;return i.updateMergingQueue=new y.MergingQueue(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),i.descriptor=r,i.descriptor.data=i.descriptor.data||{},i.descriptor.date_updated=new Date(i.descriptor.date_updated),i}return(0,f.default)(t,e),(0,l.default)(t,[{key:"_update",value:function(e){switch(e.date_created=new Date(e.date_created),e.type){case"document_updated":if(e.id<=this.lastEventId){m.default.trace("Document update skipped, current:",this.lastEventId,", remote:",e.id);break}var t=void 0!==this.descriptor.data?b.deepClone(this.descriptor.data):null;this.descriptor.last_event_id=e.id,this.descriptor.revision=e.document_revision,this.descriptor.date_updated=e.date_created,this.descriptor.data=e.document_data,this.broadcastEventToListeners("updated",{data:e.document_data,isLocal:!1,previousData:t}),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.id,revision:e.document_revision,date_updated:e.date_created,data:e.document_data});break;case"document_removed":this.onRemoved(!1)}}},{key:"set",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){var n,i=this;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r||{},b.validateOptionalTtl(n.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(n,function(e){return i._setUnconditionally(t,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){var n,i=this;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r||{},b.validateOptionalTtl(n.ttl),e.abrupt("return",this.updateMergingQueue.add(n,function(e){return i._setWithIfMatch(t,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(function(e){return(0,s.default)(e,t)},r));case 1:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,o.default)(a.default.mark(function e(t){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b.validateMandatoryTtl(t),e.next=3,this._postUpdateToServer({ttl:t});case 3:r=e.sent,this.descriptor.date_expires=r.date_expires;case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_setUnconditionally",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){var n;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({data:t,revision:void 0,ttl:r});case 2:return n=e.sent,this._handleSuccessfulUpdateResult(n),e.abrupt("return",this.descriptor.data);case 5:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_setWithIfMatch",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){var n,i,s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=t(b.deepClone(this.descriptor.data)))){e.next=22;break}return i=this.revision,e.prev=3,e.next=6,this._postUpdateToServer({data:n,revision:i,ttl:r});case 6:return s=e.sent,this._handleSuccessfulUpdateResult(s),e.abrupt("return",this.descriptor.data);case 11:if(e.prev=11,e.t0=e.catch(3),412!==e.t0.status){e.next=19;break}return e.next=16,this._softSync();case 16:return e.abrupt("return",this._setWithIfMatch(t));case 19:throw e.t0;case 20:e.next=23;break;case 22:return e.abrupt("return",this.descriptor.data);case 23:case"end":return e.stop()}},e,this,[[3,11]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"_handleSuccessfulUpdateResult",value:function(e){if(!(e.last_event_id<=this.descriptor.last_event_id)){var t=void 0!==this.descriptor.data?b.deepClone(this.descriptor.data):null;this.descriptor.revision=e.revision,this.descriptor.data=e.data,this.descriptor.last_event_id=e.last_event_id,this.descriptor.date_expires=e.date_expires,this.descriptor.date_updated=new Date(e.date_updated),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.last_event_id,revision:e.revision,date_updated:e.date_updated,data:e.data}),this.broadcastEventToListeners("updated",{data:this.descriptor.data,isLocal:!0,previousData:t})}}},{key:"_postUpdateToServer",value:function(){var e=(0,o.default)(a.default.mark(function e(t){var r,n,s;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=17;break}return r={data:t.data},void 0!==t.ttl&&(r.ttl=t.ttl),n=t.revision,e.prev=4,e.next=7,this.services.network.post(this.uri,r,n);case 7:return s=e.sent,e.abrupt("return",{revision:s.body.revision,data:t.data,last_event_id:s.body.last_event_id,date_updated:s.body.date_updated,date_expires:s.body.date_expires});case 11:throw e.prev=11,e.t0=e.catch(4),404===e.t0.status&&this.onRemoved(!1),e.t0;case 15:e.next=18;break;case 17:return e.abrupt("return",i.default.reject(new h.SyncError("The Document has been removed",404,54100)));case 18:case"end":return e.stop()}},e,this,[[4,11]])}));return function(t){return e.apply(this,arguments)}}()},{key:"_softSync",value:function(){var e=(0,o.default)(a.default.mark(function e(){var t=this;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.network.get(this.uri).then(function(e){var r={type:"document_updated",id:e.body.last_event_id,document_revision:e.body.revision,document_data:e.body.data,date_created:e.body.date_updated};return t._update(r),t}).catch(function(e){404===e.status?t.onRemoved(!1):m.default.error("Can't get updates for "+t.sid+":",e)}));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"onRemoved",value:function(e){if(!this.isDeleted){var t=void 0!==this.descriptor.data?b.deepClone(this.descriptor.data):null;this.isDeleted=!0,this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e,previousData:t})}}},{key:"removeDocument",value:function(){var e=(0,o.default)(a.default.mark(function e(){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=6;break}return e.next=3,this.services.network.delete(this.uri);case 3:this.onRemoved(!0),e.next=7;break;case 6:return e.abrupt("return",i.default.reject(new h.SyncError("The Document has been removed",404,54100)));case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"document"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}}],[{key:"type",get:function(){return"document"}}]),t}(v.SyncEntity);r.SyncDocumentImpl=_;var k=function(e){function t(e){(0,c.default)(this,t);var r=(0,d.default)(this,(t.__proto__||(0,u.default)(t)).call(this));return r.syncDocumentImpl=e,r.syncDocumentImpl.attach(r),r}return(0,f.default)(t,e),(0,l.default)(t,[{key:"set",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.set(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.mutate(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,o.default)(a.default.mark(function e(t,r){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.update(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,o.default)(a.default.mark(function e(t){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"removeDocument",value:function(){var e=(0,o.default)(a.default.mark(function e(){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.removeDocument());case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){(0,n.default)(t.prototype.__proto__||(0,u.default)(t.prototype),"close",this).call(this),this.syncDocumentImpl.detach(this.listenerUuid)}},{key:"uri",get:function(){return this.syncDocumentImpl.uri}},{key:"revision",get:function(){return this.syncDocumentImpl.revision}},{key:"lastEventId",get:function(){return this.syncDocumentImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncDocumentImpl.dateExpires}},{key:"type",get:function(){return _.type}},{key:"sid",get:function(){return this.syncDocumentImpl.sid}},{key:"data",get:function(){return this.syncDocumentImpl.data}},{key:"dateUpdated",get:function(){return this.syncDocumentImpl.dateUpdated}},{key:"uniqueName",get:function(){return this.syncDocumentImpl.uniqueName}}],[{key:"type",get:function(){return _.type}}]),t}(g.default);r.SyncDocument=k,r.default=k},{"./closeable":238,"./entity":241,"./mergingqueue":246,"./utils/logger":256,"./utils/sanitize":257,"./utils/syncerror":258,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55}],254:[function(e,t,r){"use strict";var n=f(e("babel-runtime/helpers/get")),i=f(e("babel-runtime/core-js/object/assign")),s=f(e("babel-runtime/regenerator")),a=f(e("babel-runtime/helpers/asyncToGenerator")),o=f(e("babel-runtime/core-js/object/get-prototype-of")),u=f(e("babel-runtime/helpers/classCallCheck")),c=f(e("babel-runtime/helpers/createClass")),l=f(e("babel-runtime/helpers/possibleConstructorReturn")),d=f(e("babel-runtime/helpers/inherits"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("./utils/sanitize"),h=e("./utils/uri"),b=e("./utils/syncerror"),m=e("./utils/logger"),v=e("./entity"),y=e("./listitem"),g=e("./paginator"),_=e("./cache"),k=e("./mergingqueue"),w=e("./closeable"),x=function(e){function t(e,r,n){(0,u.default)(this,t);var i=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e,n));return i.updateMergingQueue=new k.NamespacedMergingQueue(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),i.cache=new _.Cache,i.descriptor=r,i.descriptor.date_updated=new Date(i.descriptor.date_updated),i}return(0,d.default)(t,e),(0,c.default)(t,[{key:"_addOrUpdateItemOnServer",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n,i){var a,o;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a={data:r},void 0!==i&&(a.ttl=i),e.next=4,this.services.network.post(t,a,n);case 4:return(o=e.sent).body.data=r,o.body.date_updated=new Date(o.body.date_updated),e.abrupt("return",o.body);case 8:case"end":return e.stop()}},e,this)}));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"push",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){var n,i,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(r||{}).ttl,p.validateOptionalTtl(n),e.next=4,this._addOrUpdateItemOnServer(this.links.items,t,void 0,n);case 4:return i=e.sent,a=Number(i.index),this._handleItemMutated(a,i.url,i.last_event_id,i.revision,t,i.date_updated,i.date_expires,!0,!1),e.abrupt("return",this.cache.get(a));case 8:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=n||{},p.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,function(e){return a._updateItemUnconditionally(t,r,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_updateItemUnconditionally",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return i=e.sent,e.next=5,this._addOrUpdateItemOnServer(i.uri,r,void 0,n);case 5:return a=e.sent,this._handleItemMutated(t,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 8:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_updateItemWithIfMatch",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a,o,u;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:if(i=e.sent,!(a=r(p.deepClone(i.data)))){e.next=25;break}return o=i.revision,e.prev=6,e.next=9,this._addOrUpdateItemOnServer(i.uri,a,o,n);case 9:return u=e.sent,this._handleItemMutated(t,u.url,u.last_event_id,u.revision,u.data,u.date_updated,u.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 14:if(e.prev=14,e.t0=e.catch(6),412!==e.t0.status){e.next=22;break}return e.next=19,this._getItemFromServer(t);case 19:return e.abrupt("return",this._updateItemWithIfMatch(t,r,n));case 22:throw e.t0;case 23:e.next=26;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}},e,this,[[6,14]])}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=n||{},p.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.add(t,i,function(e){return a._updateItemWithIfMatch(t,r,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,function(e){return(0,i.default)(e,r)},n));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n,i;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,n=p.deepClone(r.data),e.next=6,this.services.network.delete(r.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,n,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.cache.get(t))){e.next=5;break}return e.abrupt("return",r);case 5:return e.abrupt("return",this._getItemFromServer(t));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({index:t});case 2:if(!((r=e.sent).items.length<1)){e.next=7;break}throw new b.SyncError("No item with index "+t+" found",404,54151);case 7:return e.abrupt("return",r.items[0]);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"queryItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n,i,a,o=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},r=new h.UriBuilder(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Index",t.index).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(r);case 4:return n=e.sent,i=n.body.items.map(function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.index)?o._handleItemMutated(e.index,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(Number(e.index),new y.ListItem({index:Number(e.index),uri:e.url,revision:e.revision,lastEventId:e.last_event_id,dateUpdated:e.date_updated,dateExpires:e.date_expires,data:e.data}),e.last_event_id),o.cache.get(e.index)}),a=n.body.meta,e.abrupt("return",new g.Paginator(i,function(e){return o.queryItems({pageToken:e})},a.previous_token,a.next_token));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},p.validatePageSize(t.pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getContext",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=5;break}return e.next=3,this.services.network.get(this.links.context);case 3:t=e.sent,this._updateContextIfRequired(t.body.data,t.body.last_event_id);case 5:return e.abrupt("return",this.context);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.validateMandatoryTtl(t),e.prev=1,r={ttl:t},e.next=5,this.services.network.post(this.uri,r);case 5:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}},e,this,[[1,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"setItemTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){var n,i,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.validateMandatoryTtl(r),e.next=3,this.get(t);case 3:return n=e.sent,i={ttl:r},e.next=7,this.services.network.post(n.uri,i);case 7:a=e.sent,n.updateDateExpires(a.body.date_expires);case 9:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeList",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){var r=Number(e.item_index);switch(e.date_created=new Date(e.date_created),e.type){case"list_item_added":case"list_item_updated":this._handleItemMutated(r,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"list_item_added"===e.type,!0);break;case"list_item_removed":this._handleItemRemoved(r,e.id,e.item_data,e.date_created,!0);break;case"list_context_updated":this._handleContextUpdate(e.context_data,e.id,e.date_created);break;case"list_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.list_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,r,n,i,s,a,o,u){if(this.shouldIgnoreEvent(e,r))m.default.trace("Item ",e," update skipped, current:",this.lastEventId,", remote:",r);else{this._updateRootDateUpdated(s);var c=this.cache.get(e);if(!c){var l=new y.ListItem({index:e,uri:t,lastEventId:r,revision:n,data:i,dateUpdated:s,dateExpires:a});return this.cache.store(e,l,r),void this.emitItemMutationEvent(l,u,o)}var d=p.deepClone(c.data);c.update(r,n,i,s),this.cache.store(e,c,r),void 0!==a&&c.updateDateExpires(a),this.emitItemMutationEvent(c,u,!1,d)}}},{key:"emitItemMutationEvent",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=r?"itemAdded":"itemUpdated",s={item:e,isLocal:!t};r||(s.previousItemData=n),this.broadcastEventToListeners(i,s)}},{key:"_handleItemRemoved",value:function(e,t,r,n,i){this._updateRootDateUpdated(n),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{index:e,isLocal:!i,previousItemData:r})}},{key:"_handleContextUpdate",value:function(e,t,r){this._updateRootDateUpdated(r),this._updateContextIfRequired(e,t)&&this.broadcastEventToListeners("contextUpdated",{context:e,isLocal:!1})}},{key:"_updateContextIfRequired",value:function(e,t){return!this.contextEventId||t>this.contextEventId?(this.context=e,this.contextEventId=t,!0):(m.default.trace("Context update skipped, current:",this.lastEventId,", remote:",t),!1)}},{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"list"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}}],[{key:"type",get:function(){return"list"}}]),t}(v.SyncEntity);r.SyncListImpl=x;var C=function(e){function t(e){(0,u.default)(this,t);var r=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return r.syncListImpl=e,r.syncListImpl.attach(r),r}return(0,d.default)(t,e),(0,c.default)(t,[{key:"push",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.push(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.set(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.mutate(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.update(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.remove(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.get(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getContext",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getContext());case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getItems(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setItemTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setItemTtl(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeList",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.removeList());case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){(0,n.default)(t.prototype.__proto__||(0,o.default)(t.prototype),"close",this).call(this),this.syncListImpl.detach(this.listenerUuid)}},{key:"uri",get:function(){return this.syncListImpl.uri}},{key:"revision",get:function(){return this.syncListImpl.revision}},{key:"lastEventId",get:function(){return this.syncListImpl.lastEventId}},{key:"links",get:function(){return this.syncListImpl.links}},{key:"dateExpires",get:function(){return this.syncListImpl.dateExpires}},{key:"type",get:function(){return x.type}},{key:"sid",get:function(){return this.syncListImpl.sid}},{key:"uniqueName",get:function(){return this.syncListImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncListImpl.dateUpdated}}],[{key:"type",get:function(){return x.type}}]),t}(w.default);r.SyncList=C,r.default=C},{"./cache":235,"./closeable":238,"./entity":241,"./listitem":243,"./mergingqueue":246,"./paginator":247,"./utils/logger":256,"./utils/sanitize":257,"./utils/syncerror":258,"./utils/uri":260,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55}],255:[function(e,t,r){"use strict";var n=f(e("babel-runtime/helpers/get")),i=f(e("babel-runtime/core-js/object/assign")),s=f(e("babel-runtime/regenerator")),a=f(e("babel-runtime/helpers/asyncToGenerator")),o=f(e("babel-runtime/core-js/object/get-prototype-of")),u=f(e("babel-runtime/helpers/classCallCheck")),c=f(e("babel-runtime/helpers/createClass")),l=f(e("babel-runtime/helpers/possibleConstructorReturn")),d=f(e("babel-runtime/helpers/inherits"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("./utils/sanitize"),h=e("./utils/uri"),b=e("./utils/syncerror"),m=e("./utils/logger"),v=e("./entity"),y=e("./mapitem"),g=e("./paginator"),_=e("./cache"),k=e("./mergingqueue"),w=e("./closeable"),x=function(e){function t(e,r,n){(0,u.default)(this,t);var i=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e,n));return i.updateMergingQueue=new k.NamespacedMergingQueue(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),i.cache=new _.Cache,i.descriptor=r,i.descriptor.date_updated=new Date(i.descriptor.date_updated),r.items&&r.items.forEach(function(e){e.date_updated=new Date(e.date_updated),i.cache.store(e.key,new y.MapItem(e),e.last_event_id)}),i}return(0,d.default)(t,e),(0,c.default)(t,[{key:"set",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=n||{},p.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,function(e){return a._putItemUnconditionally(t,r,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}throw new b.SyncError("Item key may not be empty",400,54209);case 2:if(!this.cache.has(t)){e.next=6;break}return e.abrupt("return",this.cache.get(t));case 6:return e.abrupt("return",this._getItemFromServer(t));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({key:t});case 2:if(!((r=e.sent).items.length<1)){e.next=7;break}throw new b.SyncError("The specified Map Item does not exist",404,54201);case 7:return e.abrupt("return",r.items[0]);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=n||{},p.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.add(t,i,function(e){return a._putItemWithIfMatch(t,r,e.ttl)}));case 3:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,function(e){return(0,i.default)(e,r)},n));case 1:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_putItemUnconditionally",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._putItemToServer(t,r,void 0,n);case 2:return i=e.sent,a=i.item,this._handleItemMutated(a.key,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,i.added,!1),e.abrupt("return",this.cache.get(a.key));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_putItemWithIfMatch",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){var i,a,o,u,c;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t).catch(function(e){if(404===e.status)return new y.MapItem({key:t,data:{},last_event_id:-1,revision:"-1",url:null,date_updated:null,date_expires:null});throw e});case 2:if(i=e.sent,!(a=r(p.deepClone(i.data)))){e.next=26;break}return o=i.revision,e.prev=6,e.next=9,this._putItemToServer(t,a,o,n);case 9:return u=e.sent,c=u.item,this._handleItemMutated(c.key,c.url,c.last_event_id,c.revision,c.data,c.date_updated,c.date_expires,u.added,!1),e.abrupt("return",this.cache.get(c.key));case 15:if(e.prev=15,e.t0=e.catch(6),412!==e.t0.status){e.next=23;break}return e.next=20,this._getItemFromServer(t);case 20:return e.abrupt("return",this._putItemWithIfMatch(t,r,n));case 23:throw e.t0;case 24:e.next=27;break;case 26:return e.abrupt("return",i);case 27:case"end":return e.stop()}},e,this,[[6,15]])}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"_putItemToServer",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n,i){var a,o,u,c,l;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=new h.UriBuilder(this.links.items).pathSegment(t).build(),o={data:r},void 0!==i&&(o.ttl=i),e.prev=3,e.next=6,this.services.network.put(a,o,n);case 6:return u=e.sent,(c=u.body).data=r,c.date_updated=new Date(c.date_updated),l=201===u.status.code,e.abrupt("return",{added:l,item:c});case 14:throw e.prev=14,e.t0=e.catch(3),404===e.t0.status&&this.onRemoved(!1),e.t0;case 18:case"end":return e.stop()}},e,this,[[3,14]])}));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n,i;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,n=p.deepClone(r.data),e.next=6,this.services.network.delete(r.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,n,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"queryItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n,i,a,o=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},r=new h.UriBuilder(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Key",t.key).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(r);case 4:return n=e.sent,i=n.body.items.map(function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.key)?o._handleItemMutated(e.key,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(e.key,new y.MapItem(e),e.last_event_id),o.cache.get(e.key)}),a=n.body.meta,e.abrupt("return",new g.Paginator(i,function(e){return o.queryItems({pageToken:e})},a.previous_token,a.next_token));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},p.validatePageSize(t.pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){switch(e.date_created=new Date(e.date_created),e.type){case"map_item_added":case"map_item_updated":this._handleItemMutated(e.item_key,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"map_item_added"===e.type,!0);break;case"map_item_removed":this._handleItemRemoved(e.item_key,e.id,e.item_data,e.date_created,!0);break;case"map_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.map_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,r,n,i,s,a,o,u){if(this.shouldIgnoreEvent(e,r))m.default.trace("Item ",e," update skipped, current:",this.lastEventId,", remote:",r);else{this._updateRootDateUpdated(s);var c=this.cache.get(e);if(!c){var l=new y.MapItem({key:e,url:t,last_event_id:r,revision:n,data:i,date_updated:s,date_expires:a});return this.cache.store(e,l,r),void this.emitItemMutationEvent(l,u,o)}var d=p.deepClone(c.data);c.update(r,n,i,s),this.cache.store(e,c,r),void 0!==a&&c.updateDateExpires(a),this.emitItemMutationEvent(c,u,!1,d)}}},{key:"emitItemMutationEvent",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=r?"itemAdded":"itemUpdated",s={item:e,isLocal:!t};r||(s.previousItemData=n),this.broadcastEventToListeners(i,s)}},{key:"_handleItemRemoved",value:function(e,t,r,n,i){this._updateRootDateUpdated(n),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{key:e,isLocal:!i,previousItemData:r})}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"setTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var r,n;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.validateMandatoryTtl(t),e.prev=1,r={ttl:t},e.next=5,this.services.network.post(this.uri,r);case 5:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}},e,this,[[1,9]])}));return function(t){return e.apply(this,arguments)}}()},{key:"setItemTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){var n,i,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.validateMandatoryTtl(r),e.next=3,this.get(t);case 3:return n=e.sent,i={ttl:r},e.next=7,this.services.network.post(n.uri,i);case 7:a=e.sent,n.updateDateExpires(a.body.date_expires);case 9:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeMap",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"map"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}}],[{key:"type",get:function(){return"map"}}]),t}(v.SyncEntity);r.SyncMapImpl=x;var C=function(e){function t(e){(0,u.default)(this,t);var r=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return r.syncMapImpl=e,r.syncMapImpl.attach(r),r}return(0,d.default)(t,e),(0,c.default)(t,[{key:"set",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.set(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.get(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"mutate",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.mutate(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.update(t,r,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.remove(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.getItems(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setItemTtl",value:function(){var e=(0,a.default)(s.default.mark(function e(t,r){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setItemTtl(t,r));case 2:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"removeMap",value:function(){var e=(0,a.default)(s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.next=3,this.syncMapImpl.removeMap();case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){(0,n.default)(t.prototype.__proto__||(0,o.default)(t.prototype),"close",this).call(this),this.syncMapImpl.detach(this.listenerUuid)}},{key:"uri",get:function(){return this.syncMapImpl.uri}},{key:"links",get:function(){return this.syncMapImpl.links}},{key:"revision",get:function(){return this.syncMapImpl.revision}},{key:"lastEventId",get:function(){return this.syncMapImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncMapImpl.dateExpires}},{key:"type",get:function(){return x.type}},{key:"sid",get:function(){return this.syncMapImpl.sid}},{key:"uniqueName",get:function(){return this.syncMapImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncMapImpl.dateUpdated}}],[{key:"type",get:function(){return x.type}}]),t}(w.Closeable);r.SyncMap=C,r.default=C},{"./cache":235,"./closeable":238,"./entity":241,"./mapitem":245,"./mergingqueue":246,"./paginator":247,"./utils/logger":256,"./utils/sanitize":257,"./utils/syncerror":258,"./utils/uri":260,"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55}],256:[function(e,t,r){"use strict";var n,i=e("babel-runtime/core-js/array/from"),s=(n=i)&&n.__esModule?n:{default:n};Object.defineProperty(r,"__esModule",{value:!0});var a=e("loglevel").getLogger("twilio-sync");function o(e,t){return[(new Date).toISOString()+" Sync "+e+":"].concat((0,s.default)(t))}r.default={setLevel:function(e){a.setLevel(e)},trace:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.trace.apply(null,o("T",t))},debug:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.debug.apply(null,o("D",t))},info:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.info.apply(null,o("I",t))},warn:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.warn.apply(null,o("W",t))},error:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];a.error.apply(null,o("E",t))}}},{"babel-runtime/core-js/array/from":26,loglevel:204}],257:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/typeof")),i=s(e("babel-runtime/core-js/json/stringify"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=e("./syncerror");function o(e,t){if(!t||void 0!==e){var r,i=void 0===e?"undefined":(0,n.default)(e);if("number"!==i||!(u(r=e)&&r>=0)){var s="object"===i?"object":"'"+e+"' of type '"+i+"'";throw new a.default("Invalid TTL, expected a positive integer of type number, was "+s,400,54011)}}}function u(e){return!isNaN(parseInt(e))&&isFinite(e)}r.deepClone=function(e){return JSON.parse((0,i.default)(e))},r.validateId=function(e){if(void 0!==e){var t=void 0===e?"undefined":(0,n.default)(e);if("string"!==t)throw new Error("Invalid ID type, expected a string, got '"+t+"'")}},r.validateOptionalTtl=function(e){o(e,!0)},r.validateMandatoryTtl=function(e){o(e,!1)},r.validatePageSize=function(e){var t;if(!(void 0===e||u(t=e)&&t>0))throw new a.default("Invalid pageSize parameter. Expected a positive integer, was '"+e+"'.",400,20007)},r.validateMode=function(e){if(!["open_or_create","open_existing","create_new"].includes(e))throw new Error("Invalid open mode. Expected one of { 'create_new', 'open_or_create', 'open_existing' }")}},{"./syncerror":258,"babel-runtime/core-js/json/stringify":29,"babel-runtime/helpers/typeof":54}],258:[function(e,t,r){"use strict";var n=d(e("babel-runtime/core-js/object/create")),i=d(e("babel-runtime/core-js/object/set-prototype-of")),s=d(e("babel-runtime/core-js/array/from")),a=d(e("babel-runtime/core-js/reflect/construct")),o=d(e("babel-runtime/core-js/object/get-prototype-of")),u=d(e("babel-runtime/helpers/classCallCheck")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var f=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;(0,u.default)(this,t);var i=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return i.name=i.constructor.name,i.message=e+" (status: "+r+", code: "+n+")",i.status=r,i.code=n,i}return(0,l.default)(t,e),t}(function(e){function t(){var t=(0,a.default)(e,(0,s.default)(arguments));return(0,i.default)(t,(0,o.default)(this)),t}return t.prototype=(0,n.default)(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i.default?(0,i.default)(t,e):t.__proto__=e,t}(Error));r.SyncError=f;var p=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments[3];(0,u.default)(this,t);var s=(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e,r,n));return s.body=i,s}return(0,l.default)(t,e),t}(f);r.SyncNetworkError=p,r.default=f},{"babel-runtime/core-js/array/from":26,"babel-runtime/core-js/object/create":33,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/object/set-prototype-of":39,"babel-runtime/core-js/reflect/construct":41,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],259:[function(e,t,r){"use strict";var n=u(e("babel-runtime/regenerator")),i=u(e("babel-runtime/core-js/get-iterator")),s=u(e("babel-runtime/core-js/symbol/iterator")),a=u(e("babel-runtime/helpers/classCallCheck")),o=u(e("babel-runtime/helpers/createClass"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var c=function(){function e(t,r){(0,a.default)(this,e),this.balanceFactor=0,this.key=t,this.value=r,this.parent=null,this.left=null,this.right=null}return(0,o.default)(e,[{key:"update",value:function(e){this.value=e}},{key:"replace",value:function(e,t){e&&(this.left===t?this.left=t:this.right===t&&(this.right=t))}},{key:"isRoot",get:function(){return null===this.parent}},{key:"isLeaf",get:function(){return null===this.left&&null===this.right}},{key:"isLeftChild",get:function(){return this.parent.left===this}}]),e}(),l=function(){function e(t,r){(0,a.default)(this,e),this.isLessThan=t||function(e,t){return e<t},this.isEqual=r||function(e,t){return e===t},this.root=null,this.count=null}return(0,o.default)(e,[{key:"clear",value:function(){this.root=null,this.count=0}},{key:"set",value:function(e,t){var r=this.getNode(e);r?r.update(t):this.insert(e,t)}},{key:"insert",value:function(e,t){var r=new c(e,t);if(this.count++,this.root){for(var n=this.root;;)if(this.isLessThan(e,n.key)){if(!n.left){n.left=r;break}n=n.left}else{if(!n.right){n.right=r;break}n=n.right}for(r.parent=n,n=r;n.parent;){var i=n.parent,s=i.balanceFactor;if(n.isLeftChild?i.balanceFactor++:i.balanceFactor--,Math.abs(i.balanceFactor)<Math.abs(s))break;if(i.balanceFactor<-1||i.balanceFactor>1){this.rebalance(i);break}n=i}}else this.root=r}},{key:"get",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t.value;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"delete",value:function(e){var t=this.getNode(e);if(!t||t.key!==e)return null;var r=t.parent,n=t.left,i=t.right;if(!!n!=!!i){var s=n||i;r||s?r&&!s?this.root=s:(r.replace(t,null),this.rebalance(r)):this.root=null}else{for(var a=t.left;a.right;)a=a.right;if(t.left===a)t.isRoot?(this.root=a,a.parent=null):(t.isLeftChild?t.parent.left=a:t.parent.right=a,a.parent=t.parent),a.right=t.right,a.right.parent=a,a.balanceFactor=t.balanceFactor,t={parent:a,isLeftChild:!0};else{var o=a.parent,u=a.left;o.right=u,u&&(u.parent=o),t.isRoot?(this.root=a,a.parent=null):(t.isLeftChild?t.parent.left=a:t.parent.right=a,a.parent=t.parent),a.right=t.right,a.right.parent=a,a.left=t.left,a.left.parent=a,a.balanceFactor=t.balanceFactor,t={parent:o,isLeftChild:!1}}}for(this.count--;t.parent;){var c=t.parent,l=c.balanceFactor;if(t.isLeftChild?c.balanceFactor-=1:c.balanceFactor+=1,Math.abs(c.balanceFactor)>Math.abs(l)){if(!(c.balanceFactor<-1||c.balanceFactor>1))break;if(this.rebalance(c),0!==c.parent.balanceFactor)break;t=c.parent}else t=c}return null}},{key:"getNode",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"rebalance",value:function(e){e.balanceFactor<0?e.right.balanceFactor>0?(this.rotateRight(e.right),this.rotateLeft(e)):this.rotateLeft(e):e.balanceFactor>0&&(e.left.balanceFactor<0?(this.rotateLeft(e.left),this.rotateRight(e)):this.rotateRight(e))}},{key:"rotateLeft",value:function(e){var t=e.right;e.right=t.left,null!==t.left&&(t.left.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.left=e,e.parent=t,e.balanceFactor=e.balanceFactor+1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor+1-Math.max(e.balanceFactor,0)}},{key:"rotateRight",value:function(e){var t=e.left;e.left=t.right,null!==t.right&&(t.right.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.right=e,e.parent=t,e.balanceFactor=e.balanceFactor-1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor-1-Math.max(e.balanceFactor,0)}},{key:s.default,value:n.default.mark(function e(){var t,r,s,a,o,u;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,r=!1,s=void 0,e.prev=3,a=(0,i.default)(this.getIterator());case 5:if(t=(o=a.next()).done){e.next=12;break}return u=o.value,e.next=9,u;case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,s=e.t0;case 18:e.prev=18,e.prev=19,!t&&a.return&&a.return();case 21:if(e.prev=21,!r){e.next=24;break}throw s;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}},e,this,[[3,14,18,26],[19,,21,25]])})},{key:"getIterator",value:n.default.mark(function e(){var t,r,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=this.root;case 1:if(!t){e.next=7;break}if(!this.isEqual(i,t.key)&&(null!==i||t.left)){e.next=4;break}return e.abrupt("break",7);case 4:t=this.isLessThan(i,t.key)||null===i?t.left:t.right,e.next=1;break;case 7:if(t){e.next=9;break}return e.abrupt("return",null);case 9:r=!0;case 10:if(!r){e.next=28;break}return e.next=13,[t.key,t.value];case 13:if(r=!1,!t.right){e.next=20;break}for(t=t.right;t.left;)t=t.left;r=!0,e.next=26;break;case 20:if(!t.parent){e.next=25;break}r=t.parent.left===t,t=t.parent,e.next=26;break;case 25:return e.abrupt("break",36);case 26:e.next=34;break;case 28:if(!t.parent){e.next=33;break}r=t.parent.left===t,t=t.parent,e.next=34;break;case 33:return e.abrupt("break",36);case 34:e.next=10;break;case 36:return e.abrupt("return",null);case 37:case"end":return e.stop()}},e,this)})},{key:"getReverseIterator",value:n.default.mark(function e(){var t,r,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=this.root;case 1:if(!t){e.next=7;break}if(!this.isEqual(i,t.key)&&(null!==i||t.right)){e.next=4;break}return e.abrupt("break",7);case 4:t=this.isLessThan(i,t.key)&&null!==i?t.left:t.right,e.next=1;break;case 7:if(t){e.next=9;break}return e.abrupt("return",null);case 9:r=!0;case 10:if(!r){e.next=28;break}return e.next=13,[t.key,t.value];case 13:if(r=!1,!t.left){e.next=20;break}for(t=t.left;t.right;)t=t.right;r=!0,e.next=26;break;case 20:if(!t.parent){e.next=25;break}r=t.parent.right===t,t=t.parent,e.next=26;break;case 25:return e.abrupt("break",36);case 26:e.next=34;break;case 28:if(!t.parent){e.next=33;break}r=t.parent.right===t,t=t.parent,e.next=34;break;case 33:return e.abrupt("break",36);case 34:e.next=10;break;case 36:return e.abrupt("return",null);case 37:case"end":return e.stop()}},e,this)})},{key:"size",get:function(){return this.count}}]),e}();r.TreeMap=l},{"babel-runtime/core-js/get-iterator":27,"babel-runtime/core-js/symbol/iterator":45,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],260:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(t){(0,n.default)(this,e),this.base=t,this.args=new Array,this.paths=new Array}return(0,i.default)(e,[{key:"pathSegment",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"queryParam",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}();r.UriBuilder=a},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],261:[function(e,t,r){t.exports={_from:"twilio-sync@^1.0.0",_id:"twilio-sync@1.0.0",_inBundle:!1,_integrity:"sha512-dWvUjzm06e6q9ZJpU9RhtYJz8Zi4xcAeLHfvMdpqeSEFcz0fPhbrFUC1Q+oZsWCLGPZq6UIy8nTqfICx381hEw==",_location:"/twilio-sync",_phantomChildren:{},_requested:{type:"range",registry:!0,raw:"twilio-sync@^1.0.0",name:"twilio-sync",escapedName:"twilio-sync",rawSpec:"^1.0.0",saveSpec:null,fetchSpec:"^1.0.0"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/twilio-sync/-/twilio-sync-1.0.0.tgz",_shasum:"655a8248afcf7f8d397e04bc566b841a17fb3f93",_spec:"twilio-sync@^1.0.0",_where:"/home/circleci/project",author:{name:"Twilio"},browserify:{transform:["babelify"]},bundleDependencies:!1,dependencies:{loglevel:"^1.6.3","operation-retrier":"^3.0.0",platform:"^1.3.6","twilio-notifications":"^0.5.12",twilsock:"^0.6.2",uuid:"^3.3.2"},deprecated:!1,description:"Twilio Sync client library",devDependencies:{"@types/chai":"^4.1.7","@types/chai-as-promised":"7.1.0","@types/chai-string":"^1.4.1","@types/mocha":"^5.2.7","@types/node":"^12.0.4","@types/sinon":"^7.0.12","@types/sinon-chai":"^3.2.2","async-test-tools":"^1.0.7","babel-core":"^6.26.0","babel-plugin-transform-builtin-extend":"^1.1.2","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.6.1","babel-runtime":"^6.26.0",babelify:"^8.0.0",browserify:"^16.2.3",chai:"^4.2.0","chai-as-promised":"^7.1.1","chai-string":"^1.5.0",cheerio:"^1.0.0-rc.2","cross-env":"^5.2.0",del:"^4.1.1","fancy-log":"^1.3.3",fs:"0.0.2",gulp:"^4.0.2","gulp-babel":"^7.0.1","gulp-derequire":"^2.1.0","gulp-if":"^2.0.2","gulp-insert":"^0.5.0","gulp-rename":"^1.4.0","gulp-sourcemaps":"^2.6.5","gulp-tap":"^1.0.1","gulp-tslint":"^8.1.4","gulp-typescript":"^5.0.1","gulp-uglify-es":"^1.0.4","ink-docstrap":"^1.3.2",jsdoc:"~3.5.5",jsonwebtoken:"^8.5.1",karma:"^4.1.0","karma-browserify":"^6.0.0","karma-browserstack-launcher":"^1.5.1","karma-mocha":"^1.3.0","karma-mocha-reporter":"^2.2.5",mocha:"^6.1.4",nyc:"^14.1.1",path:"^0.12.7",sinon:"^7.3.2","sinon-chai":"^3.3.0","ts-node":"^8.2.0",tslint:"^5.17.0",twilio:"^3.31.1",typescript:"^3.5.1","uglify-es":"^3.3.10","uglify-save-license":"^0.4.1",underscore:"^1.9.1","vinyl-buffer":"^1.0.1","vinyl-source-stream":"^2.0.0",watchify:"^3.11.1"},engines:{node:">=8"},license:"MIT",main:"lib/index.js",name:"twilio-sync",scripts:{integrationTest:"npx gulp integrationTest",unitTest:"npx gulp unitTest"},types:"./lib/index.d.ts",version:"1.0.0"}},{}],262:[function(e,t,r){"use strict";var n=c(e("babel-runtime/core-js/object/assign")),i=c(e("babel-runtime/core-js/object/get-prototype-of")),s=c(e("babel-runtime/helpers/classCallCheck")),a=c(e("babel-runtime/helpers/createClass")),o=c(e("babel-runtime/helpers/possibleConstructorReturn")),u=c(e("babel-runtime/helpers/inherits"));function c(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var l=e("events"),d=e("operation-retrier"),f=function(e){function t(e){(0,s.default)(this,t);var r=(0,o.default)(this,(t.__proto__||(0,i.default)(t)).call(this));return r.options=e?(0,n.default)({},e):{},r}return(0,u.default)(t,e),(0,a.default)(t,[{key:"start",value:function(){if(this.inProgress)throw new Error("Already waiting for next attempt, call finishAttempt(success : boolean) to finish it");this.createRetrier()}},{key:"stop",value:function(){this.cleanRetrier(),this.newBackoff=null,this.usedBackoff=null}},{key:"modifyBackoff",value:function(e){this.newBackoff=e}},{key:"attemptFailed",value:function(){if(!this.inProgress)throw new Error("No attempt is in progress");this.newBackoff?!this.usedBackoff||this.usedBackoff<this.newBackoff?this.createRetrier():this.retrier.failed(new Error):this.retrier.failed(new Error)}},{key:"cancel",value:function(){this.retrier&&this.retrier.cancel()}},{key:"cleanRetrier",value:function(){this.retrier&&(this.retrier.removeAllListeners(),this.retrier.cancel(),this.retrier=null)}},{key:"getRetryPolicy",value:function(){var e=(0,n.default)({},this.options);return this.newBackoff&&(e.min=this.newBackoff,e.max=this.options.max&&this.options.max>this.newBackoff?this.options.max:this.newBackoff),e.maxAttemptsCount=this.options.maxAttemptsCount?this.options.maxAttemptsCount+1:void 0,e}},{key:"createRetrier",value:function(){var e=this;this.cleanRetrier();var t=this.getRetryPolicy();this.retrier=new d.Retrier(t),this.retrier.once("attempt",function(){e.retrier.on("attempt",function(){return e.emit("attempt")}),e.retrier.failed(new Error("Skipping first attempt"))}),this.retrier.on("failed",function(t){return e.emit("failed",t)}),this.usedBackoff=this.newBackoff,this.newBackoff=null,this.retrier.start().catch(function(e){})}},{key:"inProgress",get:function(){return!!this.retrier}}]),t}(l.EventEmitter);r.BackoffRetrier=f},{"babel-runtime/core-js/object/assign":32,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201,"operation-retrier":206}],263:[function(e,t,r){"use strict";var n=f(e("babel-runtime/regenerator")),i=f(e("babel-runtime/helpers/asyncToGenerator")),s=f(e("babel-runtime/core-js/json/stringify")),a=f(e("babel-runtime/core-js/object/get-prototype-of")),o=f(e("babel-runtime/helpers/createClass")),u=f(e("babel-runtime/helpers/possibleConstructorReturn")),c=f(e("babel-runtime/helpers/get")),l=f(e("babel-runtime/helpers/inherits")),d=f(e("babel-runtime/helpers/classCallCheck"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("events"),h=e("./logger"),b=e("./configuration"),m=e("./twilsock"),v=e("./packetinterface"),y=e("./websocketchannel"),g=e("./services/registrations"),_=e("./services/upstream"),k=e("./deferred"),w=e("./error/twilsockerror"),x=e("./offlinestorage"),C=e("./tokenStorage"),j=e("./services/telemetrytracker"),S=function e(){(0,d.default)(this,e)};r.TelemetryEvents=S,S.TWILSOCK_CONNECT="twilsock.sdk.connect",S.TWILSOCK_INIT="twilsock.sdk.init";var T=function(e){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,d.default)(this,t);var i=(0,u.default)(this,(t.__proto__||(0,a.default)(t)).call(this));i.offlineStorageDeferred=new k.Deferred,n.continuationToken=n.continuationToken?n.continuationToken:C.TokenStorage.getStoredToken(r);var s=i.config=new b.Configuration(e,r,n);h.log.setLevel(s.logLevel);var o=new y.WebSocketChannel(s.url),c=n.transport?n.transport:new v.PacketInterface(o,s);return i.channel=n.channel?n.channel:new m.TwilsockImpl(o,c,s),i.registrations=n.registrations?n.registrations:new g.Registrations(c),i.upstream=new _.Upstream(c,i.channel,s),i.telemetryTracker=new j.TelemetryTracker(s,c),i.channel.on("initialized",function(){return i.telemetryTracker.canSendTelemetry=!0}),o.on("disconnected",function(){return i.telemetryTracker.canSendTelemetry=!1}),i.registrations.on("registered",function(e){return i.emit("registered",e)}),i.channel.on("message",function(e,t){return setTimeout(function(){return i.emit("message",e,t)},0)}),i.channel.on("stateChanged",function(e){return setTimeout(function(){return i.emit("stateChanged",e)},0)}),i.channel.on("connectionError",function(e){return setTimeout(function(){return i.emit("connectionError",e)},0)}),i.channel.on("tokenAboutToExpire",function(){return setTimeout(function(){return i.emit("tokenAboutToExpire")},0)}),i.channel.on("tokenExpired",function(){return setTimeout(function(){return i.emit("tokenExpired")},0)}),i.channel.on("connected",function(){return i.registrations.updateRegistrations()}),i.channel.on("connected",function(){return i.upstream.sendPendingMessages()}),i.channel.on("connected",function(){return setTimeout(function(){return i.emit("connected")},0)}),i.channel.on("beforeConnect",function(){return i.telemetryTracker.addPartialEvent(new j.TelemetryEventDescription("Establish WebSocket connection","",new Date),S.TWILSOCK_CONNECT,j.TelemetryPoint.Start)}),i.channel.on("connected",function(){return i.telemetryTracker.addPartialEvent(new j.TelemetryEventDescription("Establish WebSocket connection","",new Date,new Date),S.TWILSOCK_CONNECT,j.TelemetryPoint.End)}),i.channel.on("beforeSendInit",function(){return i.telemetryTracker.addPartialEvent(new j.TelemetryEventDescription("Send Twilsock init","",new Date),S.TWILSOCK_INIT,j.TelemetryPoint.Start)}),i.channel.on("initialized",function(){return i.telemetryTracker.addPartialEvent(new j.TelemetryEventDescription("Send Twilsock init","Succeeded",new Date,new Date),S.TWILSOCK_INIT,j.TelemetryPoint.End)}),i.channel.on("sendInitFailed",function(){return i.telemetryTracker.addPartialEvent(new j.TelemetryEventDescription("Send Twilsock init","Failed",new Date,new Date),S.TWILSOCK_INIT,j.TelemetryPoint.End)}),i.channel.on("initialized",function(e){i.handleStorageId(r,e),C.TokenStorage.storeToken(e.continuationToken,r),setTimeout(function(){return i.emit("initialized",e)},0)}),i.channel.on("disconnected",function(){return setTimeout(function(){return i.emit("disconnected")},0)}),i.channel.on("disconnected",function(){return i.upstream.rejectPendingMessages()}),i.channel.on("disconnected",function(){return i.offlineStorageDeferred.fail(new w.TwilsockError("Client disconnected"))}),i.offlineStorageDeferred.promise.catch(function(){}),i}return(0,l.default)(t,e),(0,o.default)(t,[{key:"emit",value:function(e){for(var r,n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return h.log.debug("Emitting "+e.toString()+"("+i.map(function(e){return(0,s.default)(e)}).join(", ")+")"),(r=(0,c.default)(t.prototype.__proto__||(0,a.default)(t.prototype),"emit",this)).call.apply(r,[this,e].concat(i))}},{key:"handleStorageId",value:function(e,t){if(t.offlineStorage)if(t.offlineStorage.hasOwnProperty(e))try{this.offlineStorageDeferred.set(x.OfflineProductStorage.create(t.offlineStorage[e])),h.log.debug("Offline storage for '"+e+"' product: "+(0,s.default)(t.offlineStorage[e])+".")}catch(r){this.offlineStorageDeferred.fail(new w.TwilsockError("Failed to parse offline storage for "+e+" "+(0,s.default)(t.offlineStorage[e])+". "+r+"."))}else this.offlineStorageDeferred.fail(new w.TwilsockError("No offline storage id for '"+e+"' product: "+(0,s.default)(t.offlineStorage)));else this.offlineStorageDeferred.fail(new w.TwilsockError("No offline storage id"))}},{key:"storageId",value:function(){return this.offlineStorageDeferred.promise}},{key:"updateToken",value:function(){var e=(0,i.default)(n.default.mark(function e(t){return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(h.log.trace("updating token '"+t+"'"),this.config.token!==t){e.next=3;break}return e.abrupt("return");case 3:return this.config.updateToken(t),e.abrupt("return",this.channel.updateToken(t));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"setNotificationsContext",value:function(e,t){this.registrations.setNotificationsContext(e,t)}},{key:"removeNotificationsContext",value:function(e){this.registrations.removeNotificationsContext(e)}},{key:"connect",value:function(){return this.channel.connect()}},{key:"disconnect",value:function(){return this.telemetryTracker.sendTelemetry(j.EventSendingLimitation.AnyEventsIncludingUnfinished),this.channel.disconnect()}},{key:"get",value:function(e,t,r){return this.telemetryTracker.sendTelemetry(j.EventSendingLimitation.AnyEvents),this.upstream.send("GET",e,t,void 0,r)}},{key:"post",value:function(e,t,r,n){return this.telemetryTracker.sendTelemetry(j.EventSendingLimitation.AnyEvents),this.upstream.send("POST",e,t,r,n)}},{key:"put",value:function(e,t,r,n){return this.telemetryTracker.sendTelemetry(j.EventSendingLimitation.AnyEvents),this.upstream.send("PUT",e,t,r,n)}},{key:"delete",value:function(e,t,r){return this.telemetryTracker.sendTelemetry(j.EventSendingLimitation.AnyEvents),this.upstream.send("DELETE",e,t,void 0,r)}},{key:"addTelemetryEvent",value:function(e){this.telemetryTracker.addTelemetryEvent(e),this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}},{key:"addPartialTelemetryEvent",value:function(e,t,r){this.telemetryTracker.addPartialEvent(e,t,r),r===j.TelemetryPoint.End&&this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}},{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"state",get:function(){return this.channel.state}}]),t}(p.EventEmitter);r.TwilsockClient=T,r.Twilsock=T},{"./configuration":264,"./deferred":265,"./error/twilsockerror":267,"./logger":271,"./offlinestorage":273,"./packetinterface":274,"./services/registrations":285,"./services/telemetrytracker":286,"./services/upstream":287,"./tokenStorage":288,"./twilsock":289,"./websocketchannel":290,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/get":49,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201}],264:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/set")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o="0.6.2",u=function(){function e(t,r){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,i.default)(this,e),this.confirmedCapabilities=new n.default,this.activeGrant=r,this._token=t;var a="wss://tsock."+(s.region||"us1")+".twilio.com/v3/wsconnect",u=s.twilsock||s.Twilsock||{};this.url=u.uri||a,this._continuationToken=s.continuationToken?s.continuationToken:null,this.logLevel=s.logLevel?s.logLevel:"error",this.retryPolicy=s.retryPolicy?s.retryPolicy:{min:1e3,max:12e4,randomness:.2},this.clientMetadata=s.clientMetadata?s.clientMetadata:{},this.clientMetadata.ver=o,this.initRegistrations=s.initRegistrations?s.initRegistrations:null,this.tweaks=s.tweaks?s.tweaks:null}return(0,s.default)(e,[{key:"updateToken",value:function(e){this._token=e}},{key:"updateContinuationToken",value:function(e){this._continuationToken=e}},{key:"token",get:function(){return this._token}},{key:"continuationToken",get:function(){return this._continuationToken}}]),e}();r.Configuration=u},{"babel-runtime/core-js/set":43,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],265:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/promise")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o=function(){function e(){var t=this;(0,i.default)(this,e),this._promise=new n.default(function(e,r){t._resolve=e,t._reject=r})}return(0,s.default)(e,[{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}},{key:"promise",get:function(){return this._promise}}]),e}();r.Deferred=o},{"babel-runtime/core-js/promise":40,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],266:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e){return(0,i.default)(this,t),(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this,e))}return(0,a.default)(t,e),t}(e("./twilsockerror").TwilsockError);r.TransportUnavailableError=u},{"./twilsockerror":267,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],267:[function(e,t,r){"use strict";var n=d(e("babel-runtime/core-js/object/create")),i=d(e("babel-runtime/core-js/object/set-prototype-of")),s=d(e("babel-runtime/core-js/array/from")),a=d(e("babel-runtime/core-js/reflect/construct")),o=d(e("babel-runtime/core-js/object/get-prototype-of")),u=d(e("babel-runtime/helpers/classCallCheck")),c=d(e("babel-runtime/helpers/possibleConstructorReturn")),l=d(e("babel-runtime/helpers/inherits"));function d(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var f=function(e){function t(e){return(0,u.default)(this,t),(0,c.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e))}return(0,l.default)(t,e),t}(function(e){function t(){var t=(0,a.default)(e,(0,s.default)(arguments));return(0,i.default)(t,(0,o.default)(this)),t}return t.prototype=(0,n.default)(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i.default?(0,i.default)(t,e):t.__proto__=e,t}(Error));r.TwilsockError=f},{"babel-runtime/core-js/array/from":26,"babel-runtime/core-js/object/create":33,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/object/set-prototype-of":39,"babel-runtime/core-js/reflect/construct":41,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],268:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e,r){(0,i.default)(this,t);var a=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this,e));return a.reply=r,a}return(0,a.default)(t,e),t}(e("./twilsockerror").TwilsockError);r.TwilsockReplyError=u},{"./twilsockerror":267,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],269:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e,r,a){(0,i.default)(this,t);var o=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this,r));return o.status=e,o.description=r,o.body=a,o}return(0,a.default)(t,e),t}(e("./twilsockerror").TwilsockError);r.TwilsockUpstreamError=u},{"./twilsockerror":267,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],270:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./client");r.TwilsockClient=n.TwilsockClient,r.Twilsock=n.TwilsockClient;var i=e("./error/twilsockerror");r.TwilsockError=i.TwilsockError;var s=e("./error/transportunavailableerror");r.TransportUnavailableError=s.TransportUnavailableError},{"./client":263,"./error/transportunavailableerror":266,"./error/twilsockerror":267}],271:[function(e,t,r){"use strict";var n=a(e("babel-runtime/helpers/classCallCheck")),i=a(e("babel-runtime/helpers/createClass")),s=a(e("babel-runtime/core-js/array/from"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o=e("loglevel").getLogger("twilsock");function u(e,t){return[(new Date).toISOString()+" Twilsock "+e+":"].concat((0,s.default)(t))}var c=function(){function e(t){(0,n.default)(this,e),this.prefix="",this.prefix=null!=t&&t.length>0?" "+t+":":""}return(0,i.default)(e,[{key:"setLevel",value:function(e){o.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.info.apply(null,u("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.warn.apply(null,u("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.error.apply(null,u("E",t))}}],[{key:"setLevel",value:function(e){o.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.trace.apply(null,u("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.debug.apply(null,u("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.info.apply(null,u("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.warn.apply(null,u("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];o.error.apply(null,u("E",t))}}]),e}();r.Logger=c;var l=new c("");r.log=l},{"babel-runtime/core-js/array/from":26,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,loglevel:204}],272:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=e("platform"),o=function(){function e(){(0,n.default)(this,e)}return(0,i.default)(e,null,[{key:"getMetadata",value:function(e){"undefined"!=typeof navigator&&a.parse(navigator.userAgent);var t=e&&e.clientMetadata?e.clientMetadata:{},r={env:a.name,envv:a.version,os:a.os.family,osv:a.os.version,osa:a.os.architecture,sdk:"js-default"},n={};return["ver","env","envv","os","osv","osa","type","sdk","sdkv","dev","devv","devt","app","appv"].filter(function(e){return e in t||e in r}).forEach(function(e){return n[e]=e in t?t[e]:r[e]}),n}}]),e}();r.Metadata=o},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,platform:208}],273:[function(e,t,r){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=e("./error/twilsockerror"),o=function(){function e(t){(0,n.default)(this,e),this.id=t}return(0,i.default)(e,null,[{key:"create",value:function(t){if(t instanceof Object&&"storage_id"in t)return new e(t.storage_id);throw new a.TwilsockError('Field "storage_id" is missing')}}]),e}();r.OfflineProductStorage=o},{"./error/twilsockerror":267,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],274:[function(e,t,r){"use strict";var n=f(e("babel-runtime/core-js/promise")),i=f(e("babel-runtime/regenerator")),s=f(e("babel-runtime/core-js/set")),a=f(e("babel-runtime/helpers/asyncToGenerator")),o=f(e("babel-runtime/core-js/map")),u=f(e("babel-runtime/helpers/createClass")),c=f(e("babel-runtime/helpers/classCallCheck")),l=f(e("babel-runtime/core-js/json/stringify")),d=f(e("babel-runtime/helpers/typeof"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("./logger"),h=e("uuid"),b=e("./error/twilsockerror"),m=e("./error/twilsockreplyerror"),v=e("./parser"),y=e("./protocol/messages"),g=e("./metadata");r.PacketResponse=function e(){(0,c.default)(this,e)};var _=function(){function e(t,r){var n=this;(0,c.default)(this,e),this.config=r,this.activeRequests=new o.default,this.channel=t,this.channel.on("reply",function(e){return n.processReply(e)}),this.channel.on("disconnected",function(){n.activeRequests.forEach(function(e){clearTimeout(e.timeout),e.reject(new b.TwilsockError("disconnected"))}),n.activeRequests.clear()})}return(0,u.default)(e,[{key:"processReply",value:function(e){var t,r=this.activeRequests.get(e.id);r&&(clearTimeout(r.timeout),this.activeRequests.delete(e.id),(t=e.status.code)>=200&&t<300?r.resolve(e):(r.reject(new m.TwilsockReplyError("Transport failure: "+e.status.status,e)),p.log.trace("message rejected")))}},{key:"storeRequest",value:function(e,t,r){var n={resolve:t,reject:r,timeout:setTimeout(function(){p.log.trace("request",e,"is timed out"),r(new b.TwilsockError("Twilsock: request timeout: "+e))},3e4)};this.activeRequests.set(e,n)}},{key:"shutdown",value:function(){this.activeRequests.forEach(function(e){clearTimeout(e.timeout),e.reject(new b.TwilsockError("Twilsock: request cancelled by user"))}),this.activeRequests.clear()}},{key:"sendInit",value:function(){var e=(0,a.default)(i.default.mark(function e(){var t,r,n;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.log.trace("sendInit"),t=g.Metadata.getMetadata(this.config),r=new y.Init(this.config.token,this.config.continuationToken,t,this.config.initRegistrations,this.config.tweaks),e.next=5,this.sendWithReply(r);case 5:return n=e.sent,e.abrupt("return",new y.InitReply(n.id,n.header.continuation_token,n.header.continuation_token_status,n.header.offline_storage,n.header.init_registrations,n.header.debug_info,new s.default(n.header.capabilities)));case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"sendClose",value:function(){var e=new y.Close;this.send(e)}},{key:"sendWithReply",value:function(e,t){var r=this;return new n.default(function(n,i){var s=r.send(e,t);r.storeRequest(s,n,i)})}},{key:"send",value:function(e,t){e.id=e.id||"TM"+h.v4();var r=v.Parser.createPacket(e,function(e){switch(void 0===e?"undefined":(0,d.default)(e)){case"undefined":return"";case"object":return(0,l.default)(e);default:return e}}(t));try{return this.channel.send(r),e.id}catch(t){throw p.log.debug("failed to send ",e,t),p.log.trace(t.stack),t}}},{key:"isConnected",get:function(){return this.channel.isConnected}}]),e}();r.PacketInterface=_},{"./error/twilsockerror":267,"./error/twilsockreplyerror":268,"./logger":271,"./metadata":272,"./parser":275,"./protocol/messages":278,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/map":30,"babel-runtime/core-js/promise":40,"babel-runtime/core-js/set":43,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,uuid:291}],275:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/json/stringify")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o=e("./logger");function u(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}).length}function c(e){var t=Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join("").replace(/(.)/g,function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r});return decodeURIComponent(t)}function l(e){return JSON.parse(c(e))}var d=function(){function e(){(0,i.default)(this,e)}return(0,s.default)(e,null,[{key:"parse",value:function(e){var t=new Uint8Array(e),r=function(e){for(var t="",r=0;r<e.length;++r){var n=String.fromCharCode(e[r]);if(t+=n,"\r"===n){r+=2;break}}var i=t.split(" ");return{size:r,protocol:i[0],version:i[1],headerSize:Number(i[2])}}(t);if("TWILSOCK"===r.protocol&&"V3.0"===r.version){var n=null;try{n=l(t.subarray(r.size,r.size+r.headerSize))}catch(t){return void o.log.error("failed to parse message header",t,e)}o.log.debug("message received: ",n.method),o.log.trace("message received: ",n);var i=null;if(n.payload_size>0){var s=2+r.size+r.headerSize,a=n.payload_size;if(n.hasOwnProperty("payload_type")&&0!==n.payload_type.indexOf("application/json"))0===n.payload_type.indexOf("text/plain")&&(i=c(t.subarray(s,s+a)));else try{i=l(t.subarray(s,s+a))}catch(t){return void o.log.error("failed to parse message body",t,e)}}return{method:n.method,header:n,payload:i}}o.log.error("unsupported protocol: "+r.protocol+" ver "+r.version)}},{key:"createPacket",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e.payload_size=u(t);var r,i,s=(0,n.default)(e)+"\r\n",a="TWILSOCK V3.0 "+(u(s)-2)+"\r\n";return o.log.debug("send request:",a+s+t),(r=encodeURIComponent(a+s+t).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}),i=new Uint8Array(r.length),Array.prototype.forEach.call(r,function(e,t){i[t]=e.charCodeAt(0)}),i).buffer}}]),e}();r.Parser=d},{"./logger":271,"babel-runtime/core-js/json/stringify":29,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],276:[function(e,t,r){"use strict";var n,i=e("babel-runtime/helpers/classCallCheck"),s=(n=i)&&n.__esModule?n:{default:n};Object.defineProperty(r,"__esModule",{value:!0});var a=e("uuid");r.AbstractMessage=function e(t){(0,s.default)(this,e),this.id=t||"TM"+a.v4()}},{"babel-runtime/helpers/classCallCheck":47,uuid:291}],277:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(){(0,i.default)(this,t);var e=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return e.method="close",e}return(0,a.default)(t,e),t}(e("./abstractmessage").AbstractMessage);r.Close=u},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],278:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=e("./init");r.Init=n.Init;var i=e("./initReply");r.InitReply=i.InitReply;var s=e("./update");r.Update=s.Update;var a=e("./message");r.Message=a.Message;var o=e("./reply");r.Reply=o.Reply;var u=e("./close");r.Close=u.Close;var c=e("./telemetry");r.Telemetry=c.Telemetry},{"./close":277,"./init":279,"./initReply":280,"./message":281,"./reply":282,"./telemetry":283,"./update":284}],279:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e,r,a){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,i.default)(this,t);var c=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return c.method="init",c.token=e,c.continuation_token=r,c.metadata=a,c.registrations=o,c.tweaks=u,c.capabilities=["client_update","offline_storage","telemetry.v1"],c}return(0,a.default)(t,e),t}(e("./abstractmessage").AbstractMessage);r.Init=u},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],280:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/possibleConstructorReturn")),s=o(e("babel-runtime/helpers/inherits")),a=o(e("babel-runtime/helpers/classCallCheck"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=e("./abstractmessage");r.ContinuationTokenStatus=function e(){(0,a.default)(this,e)};var c=function(e){function t(e,r,s,o,u,c,l){(0,a.default)(this,t);var d=(0,i.default)(this,(t.__proto__||(0,n.default)(t)).call(this,e));return d.continuationToken=r,d.continuationTokenStatus=s,d.offlineStorage=o,d.initRegistrations=u,d.debugInfo=c,d.confirmedCapabilities=l,d}return(0,s.default)(t,e),t}(u.AbstractMessage);r.InitReply=c},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],281:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e,r,a){(0,i.default)(this,t);var o=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return o.method="message",o.active_grant=e,o.payload_type=r,o.http_request=a,o}return(0,a.default)(t,e),t}(e("./abstractmessage").AbstractMessage);r.Message=u},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],282:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e){(0,i.default)(this,t);var r=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this,e));return r.method="reply",r.payload_type="application/json",r.status={code:200,status:"OK"},r}return(0,a.default)(t,e),t}(e("./abstractmessage").AbstractMessage);r.Reply=u},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],283:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/possibleConstructorReturn")),s=o(e("babel-runtime/helpers/inherits")),a=o(e("babel-runtime/helpers/classCallCheck"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=e("./abstractmessage");r.TelemetryEvent=function e(t,r,n,i,s,o){(0,a.default)(this,e),this.start=t,this.end=r,this.title=n,this.details=i,this.id=s,this.type=o};var c=function(e){function t(e){(0,a.default)(this,t);var r=(0,i.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return r.method="telemetry.v1",r.events=e,r}return(0,s.default)(t,e),t}(u.AbstractMessage);r.Telemetry=c},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],284:[function(e,t,r){"use strict";var n=o(e("babel-runtime/core-js/object/get-prototype-of")),i=o(e("babel-runtime/helpers/classCallCheck")),s=o(e("babel-runtime/helpers/possibleConstructorReturn")),a=o(e("babel-runtime/helpers/inherits"));function o(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var u=function(e){function t(e){(0,i.default)(this,t);var r=(0,s.default)(this,(t.__proto__||(0,n.default)(t)).call(this));return r.method="update",r.token=e,r}return(0,a.default)(t,e),t}(e("./abstractmessage").AbstractMessage);r.Update=u},{"./abstractmessage":276,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51}],285:[function(e,t,r){"use strict";var n=f(e("babel-runtime/core-js/set")),i=f(e("babel-runtime/regenerator")),s=f(e("babel-runtime/helpers/asyncToGenerator")),a=f(e("babel-runtime/core-js/map")),o=f(e("babel-runtime/core-js/object/get-prototype-of")),u=f(e("babel-runtime/helpers/classCallCheck")),c=f(e("babel-runtime/helpers/createClass")),l=f(e("babel-runtime/helpers/possibleConstructorReturn")),d=f(e("babel-runtime/helpers/inherits"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("../logger"),h=e("events"),b=e("uuid"),m=e("../error/twilsockerror"),v=function(e){function t(e){(0,u.default)(this,t);var r=(0,l.default)(this,(t.__proto__||(0,o.default)(t)).call(this));return r.transport=e,r.registrations=new a.default,r.registrationsInProgress=new a.default,r}return(0,d.default)(t,e),(0,c.default)(t,[{key:"putNotificationContext",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var n;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={method:"put_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(n,r);case 3:e.sent;case 4:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"deleteNotificationContext",value:function(){var e=(0,s.default)(i.default.mark(function e(t){var r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={method:"delete_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(r);case 3:e.sent;case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateRegistration",value:function(){var e=(0,s.default)(i.default.mark(function e(t,r){var s,a;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p.log.debug("update registration for context",t),(s=this.registrationsInProgress.get(t))||(s=new n.default,this.registrationsInProgress.set(t,s)),a=b.v4(),s.add(a),e.prev=5,e.next=8,this.putNotificationContext(t,r);case 8:p.log.debug("registration attempt succeeded for context",r),s.delete(a),0===s.size&&(this.registrationsInProgress.delete(t),this.emit("registered",t)),e.next=19;break;case 13:e.prev=13,e.t0=e.catch(5),p.log.warn("registration attempt failed for context",r),p.log.debug(e.t0),s.delete(a),0===s.size&&(this.registrationsInProgress.delete(t),this.emit("registrationFailed",t,e.t0));case 19:case"end":return e.stop()}},e,this,[[5,13]])}));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateRegistrations",value:function(){var e=this;p.log.trace("refreshing "+this.registrations.size+" registrations"),this.registrations.forEach(function(t,r){e.updateRegistration(r,t)})}},{key:"setNotificationsContext",value:function(e,t){if(!e||!t)throw new m.TwilsockError("Invalid arguments provided");this.registrations.set(e,t),this.transport.isConnected&&this.updateRegistration(e,t)}},{key:"removeNotificationsContext",value:function(){var e=(0,s.default)(i.default.mark(function e(t){return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrations.has(t)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.deleteNotificationContext(t);case 4:this.transport.isConnected&&this.registrations.delete(t);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),t}(h.EventEmitter);r.Registrations=v},{"../error/twilsockerror":267,"../logger":271,"babel-runtime/core-js/map":30,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/set":43,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/regenerator":55,events:201,uuid:291}],286:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/map")),i=a(e("babel-runtime/helpers/classCallCheck")),s=a(e("babel-runtime/helpers/createClass"));function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var o,u,c=e("../protocol/messages/telemetry"),l=e("../logger"),d=function(){function e(t,r,n,s,a,o){(0,i.default)(this,e),this.title=t,this.details=r,this.start=n,this.type=a,this.id=o,this.end=s}return(0,s.default)(e,[{key:"toTelemetryEvent",value:function(){var e=new Date,t=this.start,r=this.end?this.end:e;if(r<t){var n=r;r=t,t=n}var i=t.getTime()-e.getTime(),s=r.getTime()-e.getTime();return new c.TelemetryEvent(i,s,this.title,this.details,this.id,this.type)}}]),e}();r.TelemetryEventDescription=d,function(e){e[e.Start=0]="Start",e[e.End=1]="End"}(o||(o={})),r.TelemetryPoint=o,function(e){e[e.MinEventsPortion=0]="MinEventsPortion",e[e.AnyEvents=1]="AnyEvents",e[e.AnyEventsIncludingUnfinished=2]="AnyEventsIncludingUnfinished"}(u||(u={})),r.EventSendingLimitation=u;var f=function(){function e(t,r){(0,i.default)(this,e),this.minEventsPortionToSend=50,this.maxEventsPortionToSend=100,this.pendingEvents=new n.default,this.readyEvents=[],this.hasInitializationFinished=!1,this._canSendTelemetry=!1,this.config=t,this.packetInterface=r}return(0,s.default)(e,[{key:"addTelemetryEvent",value:function(e){!this.canSendTelemetry&&this.hasInitializationFinished||this.readyEvents.push(e)}},{key:"addPartialEvent",value:function(e,t,r){l.log.debug("Adding "+(r===o.Start?"starting":"ending")+" timepoint for '"+t+"' event");var n=this.pendingEvents.has(t);if(r===o.Start)n&&l.log.debug("Overwriting starting point for '"+t+"' event"),this.pendingEvents.set(t,e);else{if(!n)return void l.log.info("Could not find started event for '"+t+"' event");this.addTelemetryEvent(this.merge(this.pendingEvents.get(t),e)),this.pendingEvents.delete(t)}}},{key:"getTelemetryToSend",value:function(e){return this.canSendTelemetry&&0!=this.readyEvents.length?e==u.MinEventsPortion&&this.readyEvents.length<this.minEventsPortionToSend?[]:this.getTelemetryPortion(e==u.AnyEventsIncludingUnfinished):[]}},{key:"getTelemetryPortion",value:function(e){var t=this,r=Math.min(this.readyEvents.length,this.maxEventsPortionToSend),n=this.readyEvents.splice(0,r);return e&&n.length<this.maxEventsPortionToSend&&this.pendingEvents.forEach(function(e,r){if(!(n.length>=t.maxEventsPortionToSend)){var i=t.pendingEvents.get(r);t.pendingEvents.delete(r),n.push(new d("[UNFINISHED] "+i.title,i.details,i.start,null,i.type,i.id))}}),n}},{key:"merge",value:function(e,t){return new d(t.title?t.title:e.title,t.details?t.details:e.details,e.start,t.end,t.type?t.type:e.type,t.id?t.id:e.id)}},{key:"sendTelemetryIfMinimalPortionCollected",value:function(){this.sendTelemetry(u.MinEventsPortion)}},{key:"sendTelemetry",value:function(e){var t=this.getTelemetryToSend(e);if(0!==t.length)try{this.packetInterface.send(new c.Telemetry(t.map(function(e){return e.toTelemetryEvent()})))}catch(e){l.log.debug("Error while sending "+t.length+" telemetry events due to "+e+"; they will be resubmitted"),this.readyEvents=this.readyEvents.concat(t)}}},{key:"isTelemetryEnabled",get:function(){return this.config.confirmedCapabilities.has("telemetry.v1")}},{key:"canSendTelemetry",get:function(){return this._canSendTelemetry&&this.isTelemetryEnabled},set:function(e){l.log.debug("TelemetryTracker.canSendTelemetry: "+e+" TelemetryTracker.isTelemetryEnabled: "+this.isTelemetryEnabled),this._canSendTelemetry&&!e&&(this.pendingEvents.clear(),this.readyEvents=[]),this._canSendTelemetry=e,e&&this.sendTelemetry(u.AnyEvents),e&&!this.hasInitializationFinished&&(this.hasInitializationFinished=!0)}}]),e}();r.TelemetryTracker=f},{"../logger":271,"../protocol/messages/telemetry":283,"babel-runtime/core-js/map":30,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],287:[function(e,t,r){"use strict";var n=u(e("babel-runtime/regenerator")),i=u(e("babel-runtime/helpers/asyncToGenerator")),s=u(e("babel-runtime/core-js/promise")),a=u(e("babel-runtime/helpers/createClass")),o=u(e("babel-runtime/helpers/classCallCheck"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var c=e("../logger"),l=e("../error/twilsockerror"),d=e("../error/twilsockupstreamerror"),f=e("../protocol/messages"),p=e("../error/transportunavailableerror");function h(e,t){var r=function(e){var t=e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);if(t){var r={protocol:t[1],host:t[2],hostname:t[3],port:t[4],pathname:t[5],search:t[6],hash:t[7],params:null};if(r.search.length>0){var n=r.search.substring(1);r.params=n.split("&").map(function(e){return e.split("=")}).reduce(function(e,t){return e.hasOwnProperty(t[0])?Array.isArray(e[t[0]])?e[t[0]].push(t[1]):e[t[0]]=[e[t[0]],t[1]]:e[t[0]]=t[1],e},{})}return r}throw new l.TwilsockError("Incorrect URI: "+e)}(t),n={method:e,host:r.host,path:r.pathname};return r.params&&(n.params=r.params),n}var b=function(){function e(t,r,n){(0,o.default)(this,e),this.config=n,this.transport=t,this.pendingMessages=[],this.twilsock=r}return(0,a.default)(e,[{key:"saveMessage",value:function(e){var t=this;return new s.default(function(r,n){var i={message:e,resolve:r,reject:n,alreadyRejected:!1,timeout:setTimeout(function(){c.log.debug("request is timed out"),n(new l.TwilsockError("request '"+e.to.method+"' to '"+e.to.host+"' timed out")),i.alreadyRejected=!0},2e4)};t.pendingMessages.push(i)})}},{key:"sendPendingMessages",value:function(){for(var e=this,t=function(){var t=e.pendingMessages[0];if(!t.alreadyRejected)try{var r=t.message;e.actualSend(r).then(function(e){return t.resolve(e)}).catch(function(e){return t.reject(e)}),clearTimeout(t.timeout)}catch(e){return c.log.debug("Failed to send pending message",e),"break"}e.pendingMessages.splice(0,1)};this.pendingMessages.length;){if("break"===t())break}}},{key:"rejectPendingMessages",value:function(){var e=this;this.pendingMessages.forEach(function(t){t.reject(new p.TransportUnavailableError("Unable to connect: "+e.twilsock.getTerminationReason)),clearTimeout(t.timeout)}),this.pendingMessages.splice(0,this.pendingMessages.length)}},{key:"actualSend",value:function(){var e=(0,i.default)(n.default.mark(function e(t){var r,i,s,a,o,u,c;return n.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.to,i=t.headers,s=t.body,a=t.grant?t.grant:this.config.activeGrant,o={host:r.host,path:r.path,method:r.method,params:r.params,headers:i},u=new f.Message(a,i["Content-Type"]||"application/json",o),e.next=8,this.transport.sendWithReply(u,s);case 8:if(c=e.sent,!((l=c)&&l.header&&l.header.http_status)||(n=c.header.http_status.code)>=200&&n<300){e.next=11;break}throw new d.TwilsockUpstreamError(c.header.http_status.code,c.header.http_status.status,c.body);case 11:return e.abrupt("return",{status:c.header.http_status,headers:c.header.http_headers,body:c.body});case 12:case"end":return e.stop()}var n,l},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"send",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],i=arguments[4];if(this.twilsock.isTerminalState)return s.default.reject(new p.TransportUnavailableError("Unable to connect: "+this.twilsock.getTerminationReason));var a=function(e,t,r,n,i){return{to:h(e,t),headers:r,body:n,grant:i}}(e,t,r,n,i);return this.twilsock.isConnected?this.actualSend(a):this.saveMessage(a)}}]),e}();r.Upstream=b},{"../error/transportunavailableerror":266,"../error/twilsockerror":267,"../error/twilsockupstreamerror":269,"../logger":271,"../protocol/messages":278,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/regenerator":55}],288:[function(e,t,r){(function(t){(function(){"use strict";var n=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(){(0,n.default)(this,e)}return(0,i.default)(e,null,[{key:"storeToken",value:function(t,r){e.canStore&&e.sessionStorage.setItem(e.getKeyName(r),t)}},{key:"getStoredToken",value:function(t){return e.canStore?e.sessionStorage.getItem(e.getKeyName(t)):null}},{key:"initialize",value:function(){e.canStore&&(e.sessionStorage.getItem(e.initializedFlag)&&this.clear(),e.sessionStorage.setItem(e.initializedFlag,"true"),e.window.addEventListener("unload",function(){e.sessionStorage.removeItem(e.initializedFlag)}))}},{key:"clear",value:function(){if(e.canStore){for(var t=[],r=0;r<e.sessionStorage.length;r++){var n=e.sessionStorage.key(r);0===n.indexOf(e.tokenStoragePrefix)&&t.push(n)}t.forEach(function(t){return e.sessionStorage.removeItem(t)}),e.sessionStorage.removeItem(e.initializedFlag)}}},{key:"getKeyName",value:function(t){return""+e.tokenStoragePrefix+t}},{key:"sessionStorage",get:function(){try{return t.sessionStorage}catch(e){return null}}},{key:"window",get:function(){try{return t.window}catch(e){return null}}},{key:"canStore",get:function(){return e.sessionStorage&&e.window}}]),e}();r.TokenStorage=a,a.initializedFlag="twilio_twilsock_token_storage",a.tokenStoragePrefix="twilio_continuation_token_",a.initialize()}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48}],289:[function(e,t,r){"use strict";var n=f(e("babel-runtime/core-js/promise")),i=f(e("babel-runtime/regenerator")),s=f(e("babel-runtime/helpers/asyncToGenerator")),a=f(e("babel-runtime/core-js/object/get-prototype-of")),o=f(e("babel-runtime/helpers/createClass")),u=f(e("babel-runtime/helpers/possibleConstructorReturn")),c=f(e("babel-runtime/helpers/inherits")),l=f(e("babel-runtime/helpers/classCallCheck")),d=f(e("babel-runtime/core-js/json/stringify"));f(e("babel-runtime/helpers/typeof"));function f(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var p=e("events"),h=e("javascript-state-machine"),b=e("./logger"),m=e("./protocol/messages"),v=e("./parser"),y=e("./error/twilsockreplyerror"),g=e("./backoffretrier");r.Response=function e(){(0,l.default)(this,e)};var _=function(e){function t(e,r,n){(0,l.default)(this,t);var i=(0,u.default)(this,(t.__proto__||(0,a.default)(t)).call(this));return i.terminalStates=["disconnected","rejected"],i.lastEmittedState=void 0,i.tokenExpiredSasCode=20104,i.terminationReason="Connection is not initialized",i.websocket=e,i.websocket.on("connected",function(){return i.fsm.socketConnected()}),i.websocket.on("disconnected",function(e){return i.fsm.socketClosed()}),i.websocket.on("message",function(e){return i.onIncomingMessage(e)}),i.websocket.on("socketError",function(e){return i.emit("connectionError",{terminal:!1,message:"Socket error: "+e.message,httpStatusCode:null,errorCode:null})}),i.transport=r,i.config=n,i.retrier=new g.BackoffRetrier(n.retryPolicy),i.retrier.on("attempt",function(){return i.retry()}),i.retrier.on("failed",function(e){b.log.warn("Retrying failed: "+e.message),i.disconnect()}),"undefined"!=typeof window&&void 0!==window.addEventListener&&(window.addEventListener("online",function(){b.log.debug("Browser reported connectivity state: online"),i.resetBackoff(),i.fsm.systemOnline()}),window.addEventListener("offline",function(){b.log.debug("Browser reported connectivity state: offline"),i.websocket.close(),i.fsm.socketClosed()})),i.fsm=new h({init:"disconnected",transitions:[{name:"userConnect",from:["disconnected","rejected"],to:"connecting"},{name:"userConnect",from:["connecting","connected"]},{name:"userDisconnect",from:["connecting","initialising","connected","updating","retrying","rejected","waitSocketClosed","waitOffloadSocketClosed"],to:"disconnecting"},{name:"userRetry",from:["retrying"],to:"connecting"},{name:"socketConnected",from:["connecting"],to:"initialising"},{name:"socketClosed",from:["connecting","initialising","connected","updating","error","waitOffloadSocketClosed"],to:"retrying"},{name:"socketClosed",from:["disconnecting"],to:"disconnected"},{name:"socketClosed",from:["waitSocketClosed"],to:"disconnected"},{name:"socketClosed",from:["rejected"],to:"rejected"},{name:"initSuccess",from:["initialising"],to:"connected"},{name:"initError",from:["initialising"],to:"error"},{name:"tokenRejected",from:["initialising","updating"],to:"rejected"},{name:"protocolError",from:["initialising","connected","updating"],to:"error"},{name:"receiveClose",from:["initialising","connected","updating"],to:"waitSocketClosed"},{name:"receiveOffload",from:["initialising","connected","updating"],to:"waitOffloadSocketClosed"},{name:"unsupportedProtocol",from:["initialising","connected","updating"],to:"unsupported"},{name:"receiveFatalClose",from:["initialising","connected","updating"],to:"unsupported"},{name:"userUpdateToken",from:["disconnected","rejected","connecting","retrying"],to:"connecting"},{name:"userUpdateToken",from:["connected"],to:"updating"},{name:"updateSuccess",from:["updating"],to:"connected"},{name:"updateError",from:["updating"],to:"error"},{name:"userSend",from:["connected"],to:"connected"},{name:"systemOnline",from:["retrying"],to:"connecting"}],methods:{onConnecting:function(){i.setupSocket(),i.emit("connecting")},onEnterInitialising:function(){i.sendInit()},onLeaveInitialising:function(){i.cancelInit()},onEnterUpdating:function(){i.sendUpdate()},onLeaveUpdating:function(){i.cancelUpdate()},onEnterRetrying:function(){i.initRetry(),i.emit("connecting")},onEnterConnected:function(){i.resetBackoff(),i.onConnected()},onUserUpdateToken:function(){i.resetBackoff()},onTokenRejected:function(){i.resetBackoff(),i.closeSocket(!0),i.finalizeSocket()},onUserDisconnect:function(){i.closeSocket(!0)},onEnterDisconnecting:function(){i.startDisconnectTimer()},onLeaveDisconnecting:function(){i.cancelDisconnectTimer()},onEnterWaitSocketClosed:function(){i.startDisconnectTimer()},onLeaveWaitSocketClosed:function(){i.cancelDisconnectTimer()},onEnterWaitOffloadSocketClosed:function(){i.startDisconnectTimer()},onLeaveWaitOffloadSocketClosed:function(){i.cancelDisconnectTimer()},onDisconnected:function(){i.resetBackoff(),i.finalizeSocket()},onReceiveClose:function(e,t){i.onCloseReceived(t)},onReceiveOffload:function(e,t){b.log.debug("onreceiveoffload: ",t),i.modifyBackoff(t.body),i.onCloseReceived(t.status)},onUnsupported:function(){i.closeSocket(!0),i.finalizeSocket()},onError:function(e,t){i.closeSocket(t),i.finalizeSocket()},onEnterState:function(e){"none"!==e.from&&i.changeState(e)},onInvalidTransition:function(e,t,r){b.log.warn("FSM: unexpected transition",t,r)}}}),i}return(0,c.default)(t,e),(0,o.default)(t,[{key:"changeState",value:function(e){b.log.debug("FSM: "+e.transition+": "+e.from+" --\x3e "+e.to),this.lastEmittedState!==this.state&&(this.lastEmittedState=this.state,this.emit("stateChanged",this.state))}},{key:"resetBackoff",value:function(){b.log.trace("resetBackoff"),this.retrier.stop()}},{key:"modifyBackoff",value:function(e){b.log.trace("modifyBackoff",e);var t=e?e.backoff_policy:null;t&&"number"==typeof t.reconnect_min_ms&&this.retrier.modifyBackoff(t.reconnect_min_ms)}},{key:"startDisconnectTimer",value:function(){var e=this;b.log.trace("startDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null),this.disconnectingTimer=setTimeout(function(){b.log.debug("disconnecting is timed out"),e.closeSocket(!0)},3e3)}},{key:"cancelDisconnectTimer",value:function(){b.log.trace("cancelDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null)}},{key:"initRetry",value:function(){b.log.debug("initRetry"),this.retrier.inProgress?this.retrier.attemptFailed():this.retrier.start()}},{key:"retry",value:function(){"connecting"!=this.fsm.state?(b.log.trace("retry"),this.websocket.close(),this.fsm.userRetry()):b.log.trace("can\t retry as already connecting")}},{key:"onConnected",value:function(){this.emit("connected")}},{key:"finalizeSocket",value:function(){b.log.trace("finalizeSocket"),this.websocket.close(),this.emit("disconnected"),this.disconnectedPromiseResolve&&(this.disconnectedPromiseResolve(),this.disconnectedPromiseResolve=null)}},{key:"setupSocket",value:function(){b.log.trace("setupSocket:",this.config.token),this.emit("beforeConnect"),this.websocket.connect()}},{key:"onIncomingMessage",value:function(e){var t=v.Parser.parse(e),r=t.method,n=t.header,i=t.payload;if("reply"!==r&&this.confirmReceiving(n),"notification"===r)this.emit("message",n.message_type,i);else if("reply"===n.method)this.transport.processReply({id:n.id,status:n.status,header:n,body:i});else if("client_update"===n.method)"token_about_to_expire"===n.client_update_type&&this.emit("tokenAboutToExpire");else if("close"===n.method)if(308===n.status.code)b.log.debug("Connection has been offloaded"),this.fsm.receiveOffload({status:n.status.status,body:i});else if(406===n.status.code){var s="Server closed connection because can't parse protocol: "+(0,d.default)(n.status);this.emitReplyConnectionError(s,n,!0),b.log.error(s),this.fsm.receiveFatalClose()}else 417===n.status.code?(b.log.error("Server closed connection because can't parse client reply: "+(0,d.default)(n.status)),this.fsm.receiveFatalClose(n.status.status)):410===n.status.code?(b.log.warn("Server closed connection: "+(0,d.default)(n.status)),this.fsm.receiveClose(n.status.status),this.emit("tokenExpired")):401===n.status.code?(b.log.error("Server closed connection: "+(0,d.default)(n.status)),this.fsm.receiveClose(n.status.status)):(b.log.warn("unexpected message: ",n.status),this.fsm.receiveOffload({status:n.status.status,body:null}))}},{key:"sendInit",value:function(){var e=(0,s.default)(i.default.mark(function e(){var t,r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b.log.trace("sendInit"),e.prev=1,this.emit("beforeSendInit"),e.next=5,this.transport.sendInit();case 5:t=e.sent,this.config.updateContinuationToken(t.continuationToken),this.config.confirmedCapabilities=t.confirmedCapabilities,this.fsm.initSuccess(t),this.emit("initialized",t),this.emit("tokenUpdated"),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),e.t0 instanceof y.TwilsockReplyError?(r=!1,b.log.warn("Init rejected by server: "+(0,d.default)(e.t0.reply.status)),this.emit("sendInitFailed"),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(r=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.initError(!0)):500===e.t0.reply.status.code?this.fsm.initError(!1):this.fsm.initError(!0),this.emitReplyConnectionError(e.t0.message,e.t0.reply,r)):(this.terminationReason=e.t0.message,this.emit("connectionError",{terminal:!0,message:"Unknown error during connection initialisation: "+e.t0.message+"\n"+(0,d.default)(e.t0,null,2),httpStatusCode:null,errorCode:null}),this.fsm.initError(!0)),this.emit("tokenUpdated",e.t0);case 17:case"end":return e.stop()}},e,this,[[1,13]])}));return function(){return e.apply(this,arguments)}}()},{key:"sendUpdate",value:function(){var e=(0,s.default)(i.default.mark(function e(){var t,r,n;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b.log.trace("sendUpdate"),t=new m.Update(this.config.token),e.prev=2,e.next=5,this.transport.sendWithReply(t);case 5:r=e.sent,this.fsm.updateSuccess(r.body),this.emit("tokenUpdated"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),e.t0 instanceof y.TwilsockReplyError?(n=!1,b.log.warn("Token update rejected by server: "+(0,d.default)(e.t0.reply.status)),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(n=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.updateError(e.t0.reply.status)):this.fsm.updateError(e.t0.reply.status),this.emitReplyConnectionError(e.t0.message,e.t0.reply,n)):(this.emit("error",!1,e.t0.message,null,null),this.fsm.updateError(e.t0)),this.emit("tokenUpdated",e.t0);case 14:case"end":return e.stop()}},e,this,[[2,10]])}));return function(){return e.apply(this,arguments)}}()},{key:"emitReplyConnectionError",value:function(e,t,r){var n=t.status&&t.status.description?t.status.description:e,i=t.status.code,s=t.status&&t.status.errorCode?t.status.errorCode:null;r&&(this.terminationReason=n),this.emit("connectionError",{terminal:r,message:"Connection error: "+n,httpStatusCode:i,errorCode:s})}},{key:"cancelInit",value:function(){b.log.trace("cancelInit")}},{key:"cancelUpdate",value:function(){b.log.trace("cancelUpdate")}},{key:"confirmReceiving",value:function(e){b.log.trace("confirmReceiving");try{this.transport.send(new m.Reply(e.id))}catch(e){b.log.debug("failed to confirm packet receiving",e)}}},{key:"closeSocket",value:function(e){var t=this;b.log.trace("closeSocket (graceful: "+e+")"),e&&this.transport.isConnected&&this.transport.sendClose(),this.websocket.close(),setTimeout(function(){return t.fsm.socketClosed()},0)}},{key:"connect",value:function(){b.log.trace("connect"),this.fsm.userConnect()}},{key:"disconnect",value:function(){var e=this;return b.log.trace("disconnect"),this.fsm.is("disconnected")?n.default.resolve():new n.default(function(t){e.disconnectedPromiseResolve=t,e.fsm.userDisconnect()})}},{key:"updateToken",value:function(e){var t=this;return b.log.trace("updateToken:",e),new n.default(function(e,r){t.once("tokenUpdated",function(t){t?r(t):e()}),t.fsm.userUpdateToken()})}},{key:"onCloseReceived",value:function(e){this.websocket.close()}},{key:"isConnected",get:function(){return"connected"===this.state&&this.websocket.isConnected}},{key:"state",get:function(){switch(this.fsm.state){case"connecting":case"initialising":case"retrying":case"error":return"connecting";case"updating":case"connected":return"connected";case"rejected":return"rejected";case"disconnecting":case"waitSocketClosed":case"waitOffloadSocketClosed":return"disconnecting";case"disconnected":default:return"disconnected"}}},{key:"isTerminalState",get:function(){return-1!==this.terminalStates.indexOf(this.fsm.state)}},{key:"getTerminationReason",get:function(){return this.terminationReason}}]),t}(p.EventEmitter);r.TwilsockChannel=_,r.TwilsockImpl=_},{"./backoffretrier":262,"./error/twilsockreplyerror":268,"./logger":271,"./parser":275,"./protocol/messages":278,"babel-runtime/core-js/json/stringify":29,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/core-js/promise":40,"babel-runtime/helpers/asyncToGenerator":46,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,"babel-runtime/helpers/typeof":54,"babel-runtime/regenerator":55,events:201,"javascript-state-machine":203}],290:[function(e,t,r){(function(t){(function(){"use strict";var n=u(e("babel-runtime/core-js/object/get-prototype-of")),i=u(e("babel-runtime/helpers/classCallCheck")),s=u(e("babel-runtime/helpers/createClass")),a=u(e("babel-runtime/helpers/possibleConstructorReturn")),o=u(e("babel-runtime/helpers/inherits"));function u(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(r,"__esModule",{value:!0});var c=e("events"),l=e("./logger"),d=function(r){function u(r){(0,i.default)(this,u);var s=(0,a.default)(this,(u.__proto__||(0,n.default)(u)).call(this));return s.url=r,s.WebSocket=t.WebSocket||t.MozWebSocket||e("ws"),s}return(0,o.default)(u,r),(0,s.default)(u,[{key:"connect",value:function(){var e=this;l.log.trace("connecting to socket");var t=void 0;try{t=new this.WebSocket(this.url)}catch(e){return l.log.debug("Socket error: "+this.url),void this.emit("socketError",e)}t.binaryType="arraybuffer",t.onopen=function(){l.log.debug("socket opened "+e.url),e.emit("connected")},t.onclose=function(t){l.log.debug("socket closed",t),e.emit("disconnected",t)},t.onerror=function(t){l.log.debug("Socket error:",t),e.emit("socketError",t)},t.onmessage=function(t){e.emit("message",t.data)},this.socket=t}},{key:"send",value:function(e){this.socket.send(e)}},{key:"close",value:function(){if(l.log.trace("closing socket"),this.socket){this.socket.onopen=null,this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null;try{this.socket.close()}finally{}}}},{key:"isConnected",get:function(){return this.socket&&1===this.socket.readyState}}]),u}(c.EventEmitter);r.WebSocketChannel=d}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":271,"babel-runtime/core-js/object/get-prototype-of":37,"babel-runtime/helpers/classCallCheck":47,"babel-runtime/helpers/createClass":48,"babel-runtime/helpers/inherits":50,"babel-runtime/helpers/possibleConstructorReturn":51,events:201,ws:56}],291:[function(e,t,r){var n=e("./v1"),i=e("./v4"),s=i;s.v1=n,s.v4=i,t.exports=s},{"./v1":294,"./v4":295}],292:[function(e,t,r){for(var n=[],i=0;i<256;++i)n[i]=(i+256).toString(16).substr(1);t.exports=function(e,t){var r=t||0,i=n;return[i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]]].join("")}},{}],293:[function(e,t,r){var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(n){var i=new Uint8Array(16);t.exports=function(){return n(i),i}}else{var s=new Array(16);t.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),s[t]=e>>>((3&t)<<3)&255;return s}}},{}],294:[function(e,t,r){var n,i,s=e("./lib/rng"),a=e("./lib/bytesToUuid"),o=0,u=0;t.exports=function(e,t,r){var c=t&&r||0,l=t||[],d=(e=e||{}).node||n,f=void 0!==e.clockseq?e.clockseq:i;if(null==d||null==f){var p=s();null==d&&(d=n=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==f&&(f=i=16383&(p[6]<<8|p[7]))}var h=void 0!==e.msecs?e.msecs:(new Date).getTime(),b=void 0!==e.nsecs?e.nsecs:u+1,m=h-o+(b-u)/1e4;if(m<0&&void 0===e.clockseq&&(f=f+1&16383),(m<0||h>o)&&void 0===e.nsecs&&(b=0),b>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");o=h,u=b,i=f;var v=(1e4*(268435455&(h+=122192928e5))+b)%4294967296;l[c++]=v>>>24&255,l[c++]=v>>>16&255,l[c++]=v>>>8&255,l[c++]=255&v;var y=h/4294967296*1e4&268435455;l[c++]=y>>>8&255,l[c++]=255&y,l[c++]=y>>>24&15|16,l[c++]=y>>>16&255,l[c++]=f>>>8|128,l[c++]=255&f;for(var g=0;g<6;++g)l[c+g]=d[g];return t||a(l)}},{"./lib/bytesToUuid":292,"./lib/rng":293}],295:[function(e,t,r){var n=e("./lib/rng"),i=e("./lib/bytesToUuid");t.exports=function(e,t,r){var s=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var a=(e=e||{}).random||(e.rng||n)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t)for(var o=0;o<16;++o)t[s+o]=a[o];return t||i(a)}},{"./lib/bytesToUuid":292,"./lib/rng":293}],296:[function(e,t,r){t.exports={name:"twilio-chat",version:"5.0.0",description:"Twilio Chat service client library",main:"lib/index.js",browser:"browser/index.js",types:"./lib/client.d.ts",author:"Twilio",license:"MIT",dependencies:{"twilio-mcs-client":"^0.4.1","twilio-notifications":"^0.5.11","twilio-sdk-type-validator":"0.1.0","twilio-sync":"^1.0.0",twilsock:"^0.6.1","babel-runtime":"^6.26.0","iso8601-duration":"^1.2.0",loglevel:"^1.6.6","operation-retrier":"^3.0.1",platform:"^1.3.6",rfc6902:"^3.0.2",uuid:"^3.4.0"},devDependencies:{"@types/chai":"^4.2.5","@types/chai-as-promised":"^7.1.2","@types/chai-string":"^1.4.1","@types/core-js":"^2.5.0","@types/mocha":"^5.2.7","@types/node":"^12.12.12","@types/sinon":"^10.0.0","@types/sinon-chai":"^3.2.2",async:"^3.0.1","async-test-tools":"^1.0.7","babel-core":"^6.26.0","babel-plugin-transform-builtin-extend":"^1.1.2","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.6.1",babelify:"^8.0.0",backoff:"^2.5.0",browserify:"^16.2.3","browserify-replace":"^1.0.0",browserslist:"^4.13.0",chai:"^4.2.0","chai-as-promised":"^7.1.1","chai-string":"^1.5.0",cheerio:"^1.0.0-rc.2","cross-env":"^5.2.0",del:"^5.1.0","fancy-log":"^1.3.3",fs:"0.0.2",gulp:"^4.0.2","gulp-babel":"^7.0.1","gulp-derequire":"^2.1.0","gulp-if":"^2.0.2","gulp-insert":"^0.5.0","gulp-rename":"^1.4.0","gulp-sourcemaps":"^2.6.5","gulp-tap":"^1.0.1","gulp-tslint":"^8.1.4","gulp-typescript":"^5.0.1","gulp-uglify-es":"^1.0.4","ink-docstrap":"^1.3.2","isomorphic-form-data":"^2.0.0",jsdoc:"~3.5.5","jsdoc-strip-async-await":"^0.1.0",mocha:"^6.2.2","mocha.parallel":"^0.15.6","node-fetch":"^2.6.1",nyc:"^14.1.1",path:"^0.12.7",sinon:"^9.2.4","sinon-chai":"^3.3.0","ts-node":"^8.5.2",tslint:"^5.20.1",twilio:"^3.37.1",typescript:"^3.7.2","uglify-save-license":"^0.4.1","vinyl-buffer":"^1.0.1","vinyl-source-stream":"^2.0.0"},scripts:{unitTest:"npx gulp unitTest",integrationTest:"npx gulp integrationTest"},engines:{node:">=6"},browserslist:["IE 11","last 3 Chrome versions","last 3 Firefox versions","last 3 Safari versions","last 3 Edge versions","last 2 iOS version","last 2 ChromeAndroid version","last 2 FirefoxAndroid version","last 2 Samsung versions","last 2 UCAndroid versions"]}},{}]},{},[3])(3)});